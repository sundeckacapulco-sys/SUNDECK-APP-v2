# üß≠ Mapa de Arquitectura ‚Äî Sundeck CRM (Fase 0)

## 1. Estructura general del repositorio
- `client/`: Aplicaci√≥n React 18. Incluye m√≥dulos de Proyectos e Instalaciones, componentes compartidos, hooks propios y servicios de consumo de API. „ÄêF:README_MASTER.md‚Ä†L98-L134„Äë
  - `src/components/Prospectos/hooks/`: L√≥gica reutilizable para manejo de piezas y etapas. „ÄêF:client/src/components/Prospectos/hooks/usePiezasManager.js‚Ä†L1-L120„Äë
  - `src/hooks/`: Hooks globales (`useCotizacionUnificada`, `useEtapaManager`, `useModalEtapasSharedLogic`). „ÄêF:client/src/hooks/useEtapaManager.js‚Ä†L1-L10„Äë
  - `src/modules/proyectos/`: Componentes y servicios especializados para la experiencia de proyectos (modales de levantamiento y cotizaci√≥n). „ÄêF:client/src/modules/proyectos/components/AgregarMedidasProyectoModal.jsx‚Ä†L1-L60„Äë
  - `src/modules/instalaciones/`: Consumo y vistas del flujo de instalaciones, con servicios espec√≠ficos de API. „ÄêF:client/src/modules/instalaciones/services/instalacionesApi.js‚Ä†L1-L120„Äë
  - `src/services/`: Utilidades de c√°lculo, normalizaci√≥n y validaci√≥n compartidas por los m√≥dulos de UI. „ÄêF:client/src/services/calculosService.js‚Ä†L1-L20„Äë
- `server/`: Backend Node.js + Express + MongoDB. Agrupa modelos Mongoose, controladores REST, servicios de negocio y utilidades de exportaci√≥n. „ÄêF:README_MASTER.md‚Ä†L98-L134„Äë
  - `models/`: Definiciones de esquemas principales (`Proyecto`, `Pedido`, `Instalacion`, etc.). „ÄêF:server/models/Proyecto.js‚Ä†L1-L120„Äë
  - `controllers/`: Endpoints HTTP que orquestan l√≥gica de proyectos, cotizaciones y exportaciones. „ÄêF:server/controllers/proyectoController.js‚Ä†L1-L80„Äë
  - `services/`: Capa de dominio con normalizadores, generaci√≥n de PDF/Excel, IA y m√©tricas. „ÄêF:server/services/instalacionesInteligentesService.js‚Ä†L1-L40„Äë
  - `routes/`, `middleware/`, `config/`, `utils/`: Infraestructura Express (no modificada en esta fase).
- `docs/`: Documentaci√≥n operativa (nuevo archivo `architecture_map.md`).
- `docschecklists/`, `docs-archivo/`: Archivos hist√≥ricos, roadmap y checklists por fase. „ÄêF:docschecklists/ROADMAPMASTER.md‚Ä†L1-L120„Äë
- Archivos ra√≠z: `README_MASTER.md`, `README.md`, `KPIS_SISTEMA.md`, scripts de generaci√≥n (`generar-pdf.js`, `generar-excel.js`). „ÄêF:README_MASTER.md‚Ä†L1-L120„Äë

## 2. Modelos clave (`server/models`)
- `Proyecto.js`: N√∫cleo del dominio. Centraliza datos de cliente, estado del flujo (levantamiento‚Üíinstalaci√≥n), levantamientos normalizados, cotizaci√≥n activa y colecciones de medidas/partidas. Referencia a `Cotizacion` y sincroniza totales. „ÄêF:server/models/Proyecto.js‚Ä†L1-L120„Äë
- `Pedido.js`: Representa la conversi√≥n de una cotizaci√≥n aprobada en pedido. Referencia `Cotizacion` y `Prospecto`, controla pagos, estados de fabricaci√≥n e hitos de entrega. „ÄêF:server/models/Pedido.js‚Ä†L1-L100„Äë
- `Instalacion.js`: Gestiona programaci√≥n de cuadrillas, checklist operativo y v√≠nculo con `Pedido` o `Proyecto`. Integra `validacionTecnicaService` para consistencia t√©cnica. „ÄêF:server/models/Instalacion.js‚Ä†L1-L80„Äë
- Otros modelos relevantes: `Cotizacion`, `Fabricacion`, `ProyectoPedido`, `Usuario`, `Producto`, `KPI`, `Recordatorio`, `Plantilla(WhatsApp)`, `Prospecto` y `ProspectoNoConvertido`. Soportan m√≥dulos de ventas, comunicaci√≥n y postventa. „ÄêF:server/models/Cotizacion.js‚Ä†L1-L32„Äë„ÄêF:server/models/Fabricacion.js‚Ä†L1-L32„Äë„ÄêF:server/models/KPI.js‚Ä†L1-L32„Äë„ÄêF:server/models/PlantillaWhatsApp.js‚Ä†L1-L32„Äë

## 3. Controladores principales (`server/controllers`)
- `proyectoController.js`: Gesti√≥n integral de proyectos (generaci√≥n de PDF/Excel, normalizaci√≥n de partidas, persistencia de levantamientos y cotizaciones). „ÄêF:server/controllers/proyectoController.js‚Ä†L1-L120„Äë
- `cotizacionController.js`: CRUD de cotizaciones vinculadas a proyectos y pedidos. „ÄêF:server/controllers/cotizacionController.js‚Ä†L1-L80„Äë
- `exportacionController.js`: Centraliza exportaciones de reportes y normalizadores para PDF/Excel. „ÄêF:server/controllers/exportacionController.js‚Ä†L1-L80„Äë
- `proyectoPedidoController.js`: Sincroniza proyectos con pedidos generados (flujo aprobado ‚Üí fabricaci√≥n). „ÄêF:server/controllers/proyectoPedidoController.js‚Ä†L1-L80„Äë

## 4. Hooks relevantes en el frontend
- `usePiezasManager` (`client/src/components/Prospectos/hooks/`): Administra el ciclo de vida de piezas/partidas, validaciones y c√°lculos de √°reas, motorizaci√≥n e instalaci√≥n especial. Reutilizado en modales de proyectos. „ÄêF:client/src/components/Prospectos/hooks/usePiezasManager.js‚Ä†L1-L120„Äë
- `useCotizacionUnificada` (`client/src/hooks/`): Orquesta estado de cotizaciones en vivo y sincronizaci√≥n con la API. „ÄêF:client/src/hooks/useCotizacionUnificada.js‚Ä†L1-L80„Äë
- `useEtapaManager` y `useModalEtapasSharedLogic`: Compartimentalizan l√≥gica de etapas y modales, facilitando reutilizaci√≥n entre prospectos y proyectos. „ÄêF:client/src/hooks/useEtapaManager.js‚Ä†L1-L60„Äë

## 5. Servicios identificados
### Backend (`server/services`)
- `pdfService.js`, `pdfFabricacionService.js`, `excelService.js`: Generaci√≥n de documentos para levantamientos, cotizaciones e hitos de fabricaci√≥n. „ÄêF:server/services/pdfService.js‚Ä†L1-L40„Äë
- `cotizacionMappingService.js`, `fabricacionService.js`, `sincronizacionService.js`: Normalizaci√≥n de datos y sincronizaci√≥n entre m√≥dulos proyecto‚Üípedido‚Üífabricaci√≥n. „ÄêF:server/services/cotizacionMappingService.js‚Ä†L1-L40„Äë
- `instalacionesInteligentesService.js`: Motor IA para sugerir cuadrillas, herramientas y tiempos. „ÄêF:server/services/instalacionesInteligentesService.js‚Ä†L1-L80„Äë
- `kpisInstalacionesService.js`, `metricasComerciales.js`: Capa de m√©tricas y an√°lisis operativo.
- `notificacionesService.js`, `notificacionesComerciales.js`: Integraci√≥n de avisos internos (correo/WhatsApp).
- `validacionTecnicaService.js`: Validaciones cruzadas para instalaciones, usado desde `Instalacion.js`. „ÄêF:server/models/Instalacion.js‚Ä†L1-L20„Äë

### Frontend (`client/src/services` y m√≥dulos)
- `calculosService.js`, `normalizacionService.js`, `validacionService.js`: Utilidades de c√°lculo y reglas de negocio reflejadas en UI para mantener paridad con backend. „ÄêF:client/src/services/calculosService.js‚Ä†L1-L80„Äë
- `cotizacionUnificadaService.js`: Abstracci√≥n para enviar cotizaciones en vivo y sincronizar totales. „ÄêF:client/src/services/cotizacionUnificadaService.js‚Ä†L1-L80„Äë
- `modules/proyectos/services/proyectosApi.js`: Cliente Axios para endpoints de proyectos (levantamientos, cotizaciones, PDF). „ÄêF:client/src/modules/proyectos/services/proyectosApi.js‚Ä†L1-L80„Äë
- `modules/instalaciones/services/instalacionesApi.js`: Cliente para programaci√≥n y sugerencias IA de instalaciones. „ÄêF:client/src/modules/instalaciones/services/instalacionesApi.js‚Ä†L1-L120„Äë

## 6. Relaciones entre m√≥dulos principales
- **Proyecto** es el eje central: contiene estado del flujo (`levantamiento`‚Üí`cotizacion`‚Üí`aprobado`‚Üí`fabricacion`‚Üí`instalacion`) y almacena levantamientos y cotizaciones normalizadas. „ÄêF:server/models/Proyecto.js‚Ä†L25-L110„Äë
- **Pedido** se crea cuando una cotizaci√≥n es aprobada; referencia a `Cotizacion` y `Prospecto`, copia productos y controla los hitos de fabricaci√≥n e instalaci√≥n. „ÄêF:server/models/Pedido.js‚Ä†L1-L100„Äë
- **Instalaci√≥n** puede enlazarse a un `Pedido` o directamente a un `Proyecto`, incorporando programaci√≥n de equipos y checklist operativo. „ÄêF:server/models/Instalacion.js‚Ä†L1-L80„Äë
- La transici√≥n `Proyecto ‚Üí Pedido` est√° coordinada por `proyectoPedidoController.js` y servicios de sincronizaci√≥n, mientras que `instalacionesInteligentesService` alimenta el paso `Pedido/Proyecto ‚Üí Instalaci√≥n` con sugerencias autom√°ticas. „ÄêF:server/services/instalacionesInteligentesService.js‚Ä†L1-L80„Äë
- Frontend mantiene consistencia mediante `usePiezasManager` y servicios de normalizaci√≥n, garantizando que los datos enviados al backend sigan la estructura esperada por los modelos. „ÄêF:client/src/components/Prospectos/hooks/usePiezasManager.js‚Ä†L1-L120„Äë

## 7. Recomendaciones de logging (Fase 0)
- Adoptar **Winston o Pino** en `server/` con transporte JSON y etiquetas por m√≥dulo (`proyecto`, `pedido`, `instalacion`). Inyectar logger en controladores principales (`proyectoController.js`, `proyectoPedidoController.js`, `instalacionesInteligentesService.js`). „ÄêF:server/controllers/proyectoController.js‚Ä†L1-L80„Äë
- Normalizar eventos de auditor√≠a existentes (`üìä AUDIT` en `proyectoController.js`) para capturar `requestId`, `usuarioId`, `tiempos de ejecuci√≥n` y `estado de respuesta`.
- Registrar m√©tricas de performance en servicios cr√≠ticos (generaci√≥n de PDF/Excel, IA de instalaciones) utilizando middlewares de tiempo y almacenando resultados en colecci√≥n `Logs` o exportando a dashboard local.
- Agregar logging estructurado en frontend solo para errores cr√≠ticos (enviar a backend v√≠a endpoint `/api/logs` futuro), evitando saturaci√≥n de consola en producci√≥n.

## 8. KPIs baseline sugeridos
- **Latencia API**: Promedio y p95 por endpoint cr√≠tico (`/api/proyectos/:id/levantamiento`, `/api/proyectos/:id/cotizaciones`, `/api/instalaciones/sugerencias`). „ÄêF:README_MASTER.md‚Ä†L140-L180„Äë
- **Tama√±o de documento Mongo**: Medir tama√±o de `Proyecto`, `Pedido` e `Instalacion` antes y despu√©s de operaciones clave para orientar refactor de Fase 1.
- **Errores 4xx/5xx**: Conteo diario por controlador, destacando validaciones y fallos de generaci√≥n de documentos.
- **Tasa de conversi√≥n**: `Proyectos en cotizaci√≥n` ‚Üí `Pedidos` ‚Üí `Instalaciones completadas`, usando datos existentes en modelos para establecer baseline comercial.
- **Capacidad operativa**: N√∫mero de instalaciones programadas por semana y ocupaci√≥n de cuadrillas sugeridas por IA (`instalacionesInteligentesService`). „ÄêF:server/services/instalacionesInteligentesService.js‚Ä†L1-L80„Äë

> **Pr√≥ximos pasos**: Con este mapa se puede iniciar la instrumentaci√≥n de logging estructurado y capturar las m√©tricas baseline exigidas en la Fase 0 del `ROADMAP_MASTER`. „ÄêF:docschecklists/ROADMAPMASTER.md‚Ä†L40-L80„Äë
