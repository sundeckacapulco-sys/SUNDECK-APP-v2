{
  "archivos": [
    {
      "archivo": "\\server\\controllers\\cotizacionController.js",
      "referencias": 26,
      "detalles": [
        {
          "linea": 2,
          "contenido": "const Prospecto = require('../models/Prospecto');"
        },
        {
          "linea": 27,
          "contenido": "prospecto: prospectoId,"
        },
        {
          "linea": 46,
          "contenido": "if (!prospectoId) {"
        },
        {
          "linea": 47,
          "contenido": "logger.warn('Solicitud sin prospectoId', {"
        },
        {
          "linea": 54,
          "contenido": "return res.status(400).json({ message: 'Debes proporcionar el prospecto asociado a la cotización.' });"
        },
        {
          "linea": 87,
          "contenido": "const prospecto = await Prospecto.findById(prospectoId);"
        },
        {
          "linea": 88,
          "contenido": "if (!prospecto) {"
        },
        {
          "linea": 89,
          "contenido": "logger.warn('Prospecto no encontrado para crear cotización', {"
        },
        {
          "linea": 95,
          "contenido": "prospectoId"
        },
        {
          "linea": 97,
          "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
        },
        {
          "linea": 123,
          "contenido": "prospecto: prospecto._id,"
        },
        {
          "linea": 124,
          "contenido": "nombre: nombre || `Cotización para ${prospecto.nombre}`,"
        },
        {
          "linea": 171,
          "contenido": "prospectoId: prospecto._id"
        },
        {
          "linea": 174,
          "contenido": "prospecto.etapa = 'cotizacion';"
        },
        {
          "linea": 175,
          "contenido": "prospecto.fechaUltimoContacto = new Date();"
        },
        {
          "linea": 176,
          "contenido": "await prospecto.save();"
        },
        {
          "linea": 177,
          "contenido": "logger.info('Prospecto actualizado a etapa cotizacion', {"
        },
        {
          "linea": 183,
          "contenido": "prospectoId"
        },
        {
          "linea": 229,
          "contenido": "const cotizacion = await Cotizacion.findById(id).populate('prospecto');"
        },
        {
          "linea": 253,
          "contenido": "if (cotizacion.prospecto?._id) {"
        },
        {
          "linea": 254,
          "contenido": "await Prospecto.findByIdAndUpdate(cotizacion.prospecto._id, {"
        },
        {
          "linea": 268,
          "contenido": "prospectoId: cotizacion.prospecto?._id,"
        },
        {
          "linea": 270,
          "contenido": "id: cotizacion.prospecto?._id,"
        },
        {
          "linea": 271,
          "contenido": "nombre: cotizacion.prospecto?.nombre,"
        },
        {
          "linea": 272,
          "contenido": "telefono: cotizacion.prospecto?.telefono,"
        },
        {
          "linea": 273,
          "contenido": "correo: cotizacion.prospecto?.correo"
        }
      ]
    },
    {
      "archivo": "\\server\\controllers\\fabricacionController.js",
      "referencias": 12,
      "detalles": [
        {
          "linea": 92,
          "contenido": ".populate('prospecto', 'nombre telefono direccion');"
        },
        {
          "linea": 112,
          "contenido": "prospectoId: pedido.prospecto?._id,"
        },
        {
          "linea": 122,
          "contenido": "nombre: pedido.prospecto?.nombre,"
        },
        {
          "linea": 123,
          "contenido": "telefono: pedido.prospecto?.telefono,"
        },
        {
          "linea": 124,
          "contenido": "direccion: pedido.prospecto?.direccion || ''"
        },
        {
          "linea": 214,
          "contenido": "}, { new: true }).populate('prospecto', 'nombre telefono direccion email');"
        },
        {
          "linea": 222,
          "contenido": "nombre: pedidoEvento?.prospecto?.nombre,"
        },
        {
          "linea": 223,
          "contenido": "telefono: pedidoEvento?.prospecto?.telefono,"
        },
        {
          "linea": 250,
          "contenido": "select: 'numero prospecto productos estado fechaInstalacion fechaEntrega direccionEntrega contactoEntrega',"
        },
        {
          "linea": 251,
          "contenido": "populate: { path: 'prospecto', select: 'nombre telefono email direccion' }"
        },
        {
          "linea": 270,
          "contenido": "nombre: ordenActualizada.pedido?.prospecto?.nombre,"
        },
        {
          "linea": 271,
          "contenido": "telefono: ordenActualizada.pedido?.prospecto?.telefono,"
        }
      ]
    },
    {
      "archivo": "\\server\\controllers\\pedidoController.js",
      "referencias": 10,
      "detalles": [
        {
          "linea": 3,
          "contenido": "const Prospecto = require('../models/Prospecto');"
        },
        {
          "linea": 22,
          "contenido": "const cotizacion = await Cotizacion.findById(cotizacionId).populate('prospecto');"
        },
        {
          "linea": 91,
          "contenido": "prospecto: cotizacion.prospecto?._id,"
        },
        {
          "linea": 109,
          "contenido": "direccionEntrega: direccionEntrega || cotizacion.prospecto?.direccion || {},"
        },
        {
          "linea": 111,
          "contenido": "nombre: cotizacion.prospecto?.nombre,"
        },
        {
          "linea": 112,
          "contenido": "telefono: cotizacion.prospecto?.telefono,"
        },
        {
          "linea": 130,
          "contenido": "if (cotizacion.prospecto?._id) {"
        },
        {
          "linea": 131,
          "contenido": "await Prospecto.findByIdAndUpdate(cotizacion.prospecto._id, {"
        },
        {
          "linea": 138,
          "contenido": ".populate('prospecto', 'nombre telefono email direccion')"
        },
        {
          "linea": 165,
          "contenido": "prospectoId: pedidoCompleto.prospecto?._id,"
        }
      ]
    },
    {
      "archivo": "\\server\\controllers\\proyectoController.js",
      "referencias": 31,
      "detalles": [
        {
          "linea": 2,
          "contenido": "const Prospecto = require('../models/Prospecto');"
        },
        {
          "linea": 95,
          "contenido": "const proyecto = await Proyecto.findById(id).populate('prospecto_original');"
        },
        {
          "linea": 106,
          "contenido": "const prospecto = proyecto.prospecto_original || proyecto.cliente || {};"
        },
        {
          "linea": 113,
          "contenido": "prospecto,"
        },
        {
          "linea": 127,
          "contenido": "const clienteNombre = prospecto?.nombre || proyecto.cliente?.nombre || id;"
        },
        {
          "linea": 420,
          "contenido": "prospecto_original"
        },
        {
          "linea": 442,
          "contenido": "prospecto_original,"
        },
        {
          "linea": 458,
          "contenido": "{ path: 'prospecto_original', select: 'nombre telefono' }"
        },
        {
          "linea": 535,
          "contenido": "{ path: 'prospecto_original', select: 'nombre telefono email etapa' }"
        },
        {
          "linea": 605,
          "contenido": "{ path: 'prospecto_original', select: 'nombre telefono email direccion' },"
        },
        {
          "linea": 678,
          "contenido": "{ path: 'prospecto_original', select: 'nombre telefono' }"
        },
        {
          "linea": 871,
          "contenido": "const crearDesdeProspecto = async (req, res) => {"
        },
        {
          "linea": 873,
          "contenido": "const { prospectoId } = req.params;"
        },
        {
          "linea": 876,
          "contenido": "if (!mongoose.Types.ObjectId.isValid(prospectoId)) {"
        },
        {
          "linea": 879,
          "contenido": "message: 'ID de prospecto inválido'"
        },
        {
          "linea": 883,
          "contenido": "const prospecto = await Prospecto.findById(prospectoId);"
        },
        {
          "linea": 885,
          "contenido": "if (!prospecto) {"
        },
        {
          "linea": 888,
          "contenido": "message: 'Prospecto no encontrado'"
        },
        {
          "linea": 895,
          "contenido": "nombre: prospecto.nombre,"
        },
        {
          "linea": 896,
          "contenido": "telefono: prospecto.telefono,"
        },
        {
          "linea": 897,
          "contenido": "correo: prospecto.email,"
        },
        {
          "linea": 898,
          "contenido": "direccion: prospecto.direccion,"
        },
        {
          "linea": 899,
          "contenido": "zona: prospecto.zona"
        },
        {
          "linea": 902,
          "contenido": "observaciones: prospecto.observaciones,"
        },
        {
          "linea": 903,
          "contenido": "responsable: prospecto.asesorAsignado,"
        },
        {
          "linea": 904,
          "contenido": "prospecto_original: prospectoId,"
        },
        {
          "linea": 913,
          "contenido": "message: 'Proyecto creado desde prospecto exitosamente',"
        },
        {
          "linea": 919,
          "contenido": "context: 'crearDesdeProspecto',"
        },
        {
          "linea": 920,
          "contenido": "prospectoId: req.params.prospectoId,"
        },
        {
          "linea": 1489,
          "contenido": "prospecto: proyecto.prospecto_original,"
        },
        {
          "linea": 1643,
          "contenido": "crearDesdeProspecto,"
        }
      ]
    },
    {
      "archivo": "\\server\\controllers\\proyectoPedidoController.js",
      "referencias": 13,
      "detalles": [
        {
          "linea": 2,
          "contenido": "const Prospecto = require('../models/Prospecto');"
        },
        {
          "linea": 20,
          "contenido": "const cotizacion = await Cotizacion.findById(cotizacionId).populate('prospecto');"
        },
        {
          "linea": 47,
          "contenido": "prospecto: cotizacion.prospecto._id,"
        },
        {
          "linea": 52,
          "contenido": "nombre: cotizacion.prospecto.nombre,"
        },
        {
          "linea": 53,
          "contenido": "telefono: cotizacion.prospecto.telefono,"
        },
        {
          "linea": 54,
          "contenido": "email: cotizacion.prospecto.email,"
        },
        {
          "linea": 55,
          "contenido": "direccion: cotizacion.prospecto.direccion"
        },
        {
          "linea": 103,
          "contenido": "direccion: cotizacion.prospecto.direccion,"
        },
        {
          "linea": 105,
          "contenido": "nombre: contactoEntrega?.nombre || cotizacion.prospecto.nombre,"
        },
        {
          "linea": 106,
          "contenido": "telefono: contactoEntrega?.telefono || cotizacion.prospecto.telefono,"
        },
        {
          "linea": 137,
          "contenido": ".populate('prospecto', 'nombre telefono email')"
        },
        {
          "linea": 259,
          "contenido": "{ path: 'prospecto', select: 'nombre telefono email etapa' },"
        },
        {
          "linea": 311,
          "contenido": ".populate('prospecto')"
        }
      ]
    },
    {
      "archivo": "\\server\\index.js",
      "referencias": 1,
      "detalles": [
        {
          "linea": 124,
          "contenido": "app.use('/api/prospectos', require('./routes/prospectos'));"
        }
      ]
    },
    {
      "archivo": "\\server\\listeners\\fabricacionListener.js",
      "referencias": 4,
      "detalles": [
        {
          "linea": 50,
          "contenido": "const pedido = await Pedido.findById(pedidoId).populate('prospecto');"
        },
        {
          "linea": 72,
          "contenido": "nombre: pedido.prospecto?.nombre,"
        },
        {
          "linea": 73,
          "contenido": "telefono: pedido.prospecto?.telefono,"
        },
        {
          "linea": 74,
          "contenido": "direccion: pedido.prospecto?.direccion?.calle || ''"
        }
      ]
    },
    {
      "archivo": "\\server\\listeners\\instalacionListener.js",
      "referencias": 3,
      "detalles": [
        {
          "linea": 41,
          "contenido": "const pedido = await Pedido.findById(pedidoId).populate('prospecto');"
        },
        {
          "linea": 69,
          "contenido": "nombre: cliente?.nombre || pedido.prospecto?.nombre,"
        },
        {
          "linea": 70,
          "contenido": "telefono: cliente?.telefono || pedido.prospecto?.telefono"
        }
      ]
    },
    {
      "archivo": "\\server\\listeners\\pedidoListener.js",
      "referencias": 17,
      "detalles": [
        {
          "linea": 4,
          "contenido": "const Prospecto = require('../models/Prospecto');"
        },
        {
          "linea": 28,
          "contenido": "prospectoId,"
        },
        {
          "linea": 36,
          "contenido": "if (!cotizacionId || !prospectoId) {"
        },
        {
          "linea": 39,
          "contenido": "prospectoId"
        },
        {
          "linea": 63,
          "contenido": ".select('prospecto total productos formaPago instalacion descuento pago entrega vendedor')"
        },
        {
          "linea": 64,
          "contenido": ".populate('prospecto');"
        },
        {
          "linea": 66,
          "contenido": "const prospecto = cotizacion?.prospecto || await Prospecto.findById(prospectoId);"
        },
        {
          "linea": 68,
          "contenido": "if (!cotizacion && !prospecto) {"
        },
        {
          "linea": 69,
          "contenido": "this.logWarn('No se encontró cotización ni prospecto para crear pedido', {"
        },
        {
          "linea": 71,
          "contenido": "prospectoId"
        },
        {
          "linea": 78,
          "contenido": "prospecto: prospecto?._id || prospectoId,"
        },
        {
          "linea": 125,
          "contenido": "if (prospecto) {"
        },
        {
          "linea": 126,
          "contenido": "prospecto.etapa = 'pedido';"
        },
        {
          "linea": 127,
          "contenido": "prospecto.fechaUltimoContacto = new Date();"
        },
        {
          "linea": 128,
          "contenido": "await prospecto.save();"
        },
        {
          "linea": 138,
          "contenido": "prospectoId: prospecto?._id || prospectoId"
        },
        {
          "linea": 148,
          "contenido": "prospectoId"
        }
      ]
    },
    {
      "archivo": "\\server\\middleware\\proyectoSync.js",
      "referencias": 64,
      "detalles": [
        {
          "linea": 14,
          "contenido": "static async sincronizarProspecto(prospecto, operacion = 'create') {"
        },
        {
          "linea": 16,
          "contenido": "logger.info('Sincronizando prospecto con proyecto', {"
        },
        {
          "linea": 18,
          "contenido": "accion: 'sincronizarProspecto',"
        },
        {
          "linea": 19,
          "contenido": "prospectoId: prospecto?._id?.toString(),"
        },
        {
          "linea": 24,
          "contenido": "let proyecto = await Proyecto.findOne({ prospecto_original: prospecto._id });"
        },
        {
          "linea": 28,
          "contenido": "proyecto = await this.crearProyectoDesdeProspecto(prospecto);"
        },
        {
          "linea": 31,
          "contenido": "proyecto = await this.actualizarProyectoDesdeProspecto(proyecto, prospecto);"
        },
        {
          "linea": 37,
          "contenido": "logger.error('Error en sincronización Prospecto → Proyecto', {"
        },
        {
          "linea": 39,
          "contenido": "accion: 'sincronizarProspecto',"
        },
        {
          "linea": 40,
          "contenido": "prospectoId: prospecto?._id?.toString(),"
        },
        {
          "linea": 53,
          "contenido": "static async crearProyectoDesdeProspecto(prospecto) {"
        },
        {
          "linea": 55,
          "contenido": "logger.info('Creando proyecto desde prospecto', {"
        },
        {
          "linea": 57,
          "contenido": "accion: 'crearProyectoDesdeProspecto',"
        },
        {
          "linea": 58,
          "contenido": "prospectoId: prospecto?._id?.toString()"
        },
        {
          "linea": 62,
          "contenido": "const tipo_fuente = this.determinarTipoFuente(prospecto);"
        },
        {
          "linea": 67,
          "contenido": "nombre: prospecto.nombre,"
        },
        {
          "linea": 68,
          "contenido": "telefono: prospecto.telefono,"
        },
        {
          "linea": 69,
          "contenido": "correo: prospecto.email,"
        },
        {
          "linea": 70,
          "contenido": "direccion: this.formatearDireccion(prospecto.direccion),"
        },
        {
          "linea": 71,
          "contenido": "zona: prospecto.direccion?.colonia || ''"
        },
        {
          "linea": 74,
          "contenido": "estado: this.mapearEtapaAEstado(prospecto.etapa),"
        },
        {
          "linea": 75,
          "contenido": "observaciones: prospecto.descripcionNecesidad || '',"
        },
        {
          "linea": 79,
          "contenido": "fotos: prospecto.archivos?.map(arch => arch.url) || [],"
        },
        {
          "linea": 80,
          "contenido": "responsable: prospecto.vendedorAsignado?.toString() || '',"
        },
        {
          "linea": 81,
          "contenido": "monto_estimado: prospecto.presupuestoEstimado || 0,"
        },
        {
          "linea": 82,
          "contenido": "prospecto_original: prospecto._id,"
        },
        {
          "linea": 83,
          "contenido": "fecha_compromiso: prospecto.fechaCita,"
        },
        {
          "linea": 86,
          "contenido": "creado_por: prospecto.vendedorAsignado,"
        },
        {
          "linea": 87,
          "contenido": "asesor_asignado: prospecto.vendedorAsignado,"
        },
        {
          "linea": 93,
          "contenido": "logger.info('Proyecto creado exitosamente desde prospecto', {"
        },
        {
          "linea": 95,
          "contenido": "accion: 'crearProyectoDesdeProspecto',"
        },
        {
          "linea": 96,
          "contenido": "prospectoId: prospecto?._id?.toString(),"
        },
        {
          "linea": 103,
          "contenido": "logger.error('Error creando proyecto desde prospecto', {"
        },
        {
          "linea": 105,
          "contenido": "accion: 'crearProyectoDesdeProspecto',"
        },
        {
          "linea": 106,
          "contenido": "prospectoId: prospecto?._id?.toString(),"
        },
        {
          "linea": 117,
          "contenido": "static async actualizarProyectoDesdeProspecto(proyecto, prospecto) {"
        },
        {
          "linea": 119,
          "contenido": "logger.info('Actualizando proyecto desde prospecto', {"
        },
        {
          "linea": 121,
          "contenido": "accion: 'actualizarProyectoDesdeProspecto',"
        },
        {
          "linea": 122,
          "contenido": "prospectoId: prospecto?._id?.toString(),"
        },
        {
          "linea": 127,
          "contenido": "proyecto.cliente.nombre = prospecto.nombre;"
        },
        {
          "linea": 128,
          "contenido": "proyecto.cliente.telefono = prospecto.telefono;"
        },
        {
          "linea": 129,
          "contenido": "proyecto.cliente.correo = prospecto.email;"
        },
        {
          "linea": 130,
          "contenido": "proyecto.cliente.direccion = this.formatearDireccion(prospecto.direccion);"
        },
        {
          "linea": 131,
          "contenido": "proyecto.cliente.zona = prospecto.direccion?.colonia || '';"
        },
        {
          "linea": 133,
          "contenido": "proyecto.estado = this.mapearEtapaAEstado(prospecto.etapa);"
        },
        {
          "linea": 134,
          "contenido": "proyecto.observaciones = prospecto.descripcionNecesidad || '';"
        },
        {
          "linea": 135,
          "contenido": "proyecto.monto_estimado = prospecto.presupuestoEstimado || 0;"
        },
        {
          "linea": 136,
          "contenido": "proyecto.fecha_compromiso = prospecto.fechaCita;"
        },
        {
          "linea": 140,
          "contenido": "logger.info('Proyecto actualizado exitosamente desde prospecto', {"
        },
        {
          "linea": 142,
          "contenido": "accion: 'actualizarProyectoDesdeProspecto',"
        },
        {
          "linea": 143,
          "contenido": "prospectoId: prospecto?._id?.toString(),"
        },
        {
          "linea": 150,
          "contenido": "logger.error('Error actualizando proyecto desde prospecto', {"
        },
        {
          "linea": 152,
          "contenido": "accion: 'actualizarProyectoDesdeProspecto',"
        },
        {
          "linea": 153,
          "contenido": "prospectoId: prospecto?._id?.toString(),"
        },
        {
          "linea": 165,
          "contenido": "static async sincronizarMedidasDesdeEtapas(proyectoId, prospectoId) {"
        },
        {
          "linea": 170,
          "contenido": "const etapas = await Etapa.find({ prospectoId }).sort({ creadoEn: 1 });"
        },
        {
          "linea": 273,
          "contenido": "prospectoId: prospectoId?.toString(),"
        },
        {
          "linea": 282,
          "contenido": "prospectoId: prospectoId?.toString(),"
        },
        {
          "linea": 316,
          "contenido": "static determinarTipoFuente(prospecto) {"
        },
        {
          "linea": 317,
          "contenido": "if (prospecto.fuente === 'cotizacion_directa') return 'directo';"
        },
        {
          "linea": 318,
          "contenido": "if (prospecto.tipoProducto === 'cotizacion') return 'en_vivo';"
        },
        {
          "linea": 319,
          "contenido": "if (prospecto.tipoProducto === 'toma_medidas') return 'formal';"
        },
        {
          "linea": 323,
          "contenido": "static mapearEtapaAEstado(etapaProspecto) {"
        },
        {
          "linea": 338,
          "contenido": "return mapeo[etapaProspecto] || 'levantamiento';"
        }
      ]
    },
    {
      "archivo": "\\server\\models\\Cotizacion.js",
      "referencias": 3,
      "detalles": [
        {
          "linea": 6,
          "contenido": "prospecto: {"
        },
        {
          "linea": 8,
          "contenido": "ref: 'Prospecto'"
        },
        {
          "linea": 229,
          "contenido": "cotizacionSchema.index({ prospecto: 1 });"
        }
      ]
    },
    {
      "archivo": "\\server\\models\\Etapa.js",
      "referencias": 2,
      "detalles": [
        {
          "linea": 47,
          "contenido": "prospectoId: {"
        },
        {
          "linea": 49,
          "contenido": "ref: 'Prospecto',"
        }
      ]
    },
    {
      "archivo": "\\server\\models\\Fabricacion.legacy.js",
      "referencias": 2,
      "detalles": [
        {
          "linea": 27,
          "contenido": "prospecto: {"
        },
        {
          "linea": 29,
          "contenido": "ref: 'Prospecto',"
        }
      ]
    },
    {
      "archivo": "\\server\\models\\KPI.js",
      "referencias": 10,
      "detalles": [
        {
          "linea": 21,
          "contenido": "prospectosNuevos: { type: Number, default: 0 },"
        },
        {
          "linea": 22,
          "contenido": "prospectosActivos: { type: Number, default: 0 },"
        },
        {
          "linea": 23,
          "contenido": "prospectosConvertidos: { type: Number, default: 0 },"
        },
        {
          "linea": 24,
          "contenido": "prospectosPerdidos: { type: Number, default: 0 },"
        },
        {
          "linea": 52,
          "contenido": "prospectoACotizacion: { type: Number, default: 0 },"
        },
        {
          "linea": 89,
          "contenido": "prospectosAsignados: { type: Number, default: 0 },"
        },
        {
          "linea": 177,
          "contenido": "prospectosNuevos: datosNormalizados.length,"
        },
        {
          "linea": 178,
          "contenido": "prospectosActivos: datosNormalizados.filter(p => !['completado', 'cancelado', 'entregado', 'instalado'].includes(p.estado)).length,"
        },
        {
          "linea": 179,
          "contenido": "prospectosConvertidos: datosNormalizados.filter(p => estadosCompletados.includes(p.estado)).length,"
        },
        {
          "linea": 180,
          "contenido": "prospectosPerdidos: datosNormalizados.filter(p => p.estado === 'cancelado').length,"
        }
      ]
    },
    {
      "archivo": "\\server\\models\\Pedido.js",
      "referencias": 3,
      "detalles": [
        {
          "linea": 12,
          "contenido": "prospecto: {"
        },
        {
          "linea": 14,
          "contenido": "ref: 'Prospecto',"
        },
        {
          "linea": 420,
          "contenido": "pedidoSchema.index({ prospecto: 1 });"
        }
      ]
    },
    {
      "archivo": "\\server\\models\\Postventa.js",
      "referencias": 1,
      "detalles": [
        {
          "linea": 17,
          "contenido": "ref: 'Prospecto',"
        }
      ]
    },
    {
      "archivo": "\\server\\models\\Prospecto.js",
      "referencias": 13,
      "detalles": [
        {
          "linea": 4,
          "contenido": "const prospectoSchema = new mongoose.Schema({"
        },
        {
          "linea": 190,
          "contenido": "prospectoSchema.index({ telefono: 1 });"
        },
        {
          "linea": 191,
          "contenido": "prospectoSchema.index({ email: 1 });"
        },
        {
          "linea": 192,
          "contenido": "prospectoSchema.index({ etapa: 1 });"
        },
        {
          "linea": 193,
          "contenido": "prospectoSchema.index({ vendedorAsignado: 1 });"
        },
        {
          "linea": 194,
          "contenido": "prospectoSchema.index({ fechaProximoSeguimiento: 1 });"
        },
        {
          "linea": 195,
          "contenido": "prospectoSchema.index({ archivado: 1 });"
        },
        {
          "linea": 196,
          "contenido": "prospectoSchema.index({ enPapelera: 1 });"
        },
        {
          "linea": 197,
          "contenido": "prospectoSchema.index({ createdAt: -1 });"
        },
        {
          "linea": 200,
          "contenido": "prospectoSchema.methods.calcularScore = function() {"
        },
        {
          "linea": 207,
          "contenido": "prospectoSchema.methods.necesitaSeguimiento = function() {"
        },
        {
          "linea": 213,
          "contenido": "prospectoSchema.plugin(mongoosePaginate);"
        },
        {
          "linea": 215,
          "contenido": "module.exports = mongoose.model('Prospecto', prospectoSchema);"
        }
      ]
    },
    {
      "archivo": "\\server\\models\\ProspectoNoConvertido.js",
      "referencias": 11,
      "detalles": [
        {
          "linea": 4,
          "contenido": "const prospectoNoConvertidoSchema = new mongoose.Schema({"
        },
        {
          "linea": 168,
          "contenido": "prospectoNoConvertidoSchema.index({ fechaPerdida: -1 });"
        },
        {
          "linea": 169,
          "contenido": "prospectoNoConvertidoSchema.index({ vendedorAsignado: 1, estadoRecuperacion: 1 });"
        },
        {
          "linea": 170,
          "contenido": "prospectoNoConvertidoSchema.index({ 'razonPerdida.tipo': 1 });"
        },
        {
          "linea": 171,
          "contenido": "prospectoNoConvertidoSchema.index({ 'alertas.proximoSeguimiento': 1, 'alertas.alertaActiva': 1 });"
        },
        {
          "linea": 174,
          "contenido": "prospectoNoConvertidoSchema.pre('save', function(next) {"
        },
        {
          "linea": 192,
          "contenido": "prospectoNoConvertidoSchema.methods.calcularScoreRecuperacion = function() {"
        },
        {
          "linea": 230,
          "contenido": "prospectoNoConvertidoSchema.statics.obtenerRecuperables = function(limite = 50) {"
        },
        {
          "linea": 243,
          "contenido": "prospectoNoConvertidoSchema.statics.analizarPerdidas = async function(fechaInicio, fechaFin) {"
        },
        {
          "linea": 271,
          "contenido": "prospectoNoConvertidoSchema.methods.programarSeguimiento = function(dias = 7) {"
        },
        {
          "linea": 281,
          "contenido": "module.exports = mongoose.model('ProspectoNoConvertido', prospectoNoConvertidoSchema);"
        }
      ]
    },
    {
      "archivo": "\\server\\models\\Proyecto.js",
      "referencias": 2,
      "detalles": [
        {
          "linea": 748,
          "contenido": "prospecto_original: {"
        },
        {
          "linea": 750,
          "contenido": "ref: 'Prospecto'"
        }
      ]
    },
    {
      "archivo": "\\server\\models\\ProyectoPedido.legacy.js",
      "referencias": 3,
      "detalles": [
        {
          "linea": 24,
          "contenido": "prospecto: {"
        },
        {
          "linea": 26,
          "contenido": "ref: 'Prospecto',"
        },
        {
          "linea": 761,
          "contenido": "proyectoPedidoSchema.index({ prospecto: 1 });"
        }
      ]
    },
    {
      "archivo": "\\server\\models\\Recordatorio.js",
      "referencias": 3,
      "detalles": [
        {
          "linea": 44,
          "contenido": "prospecto: {"
        },
        {
          "linea": 46,
          "contenido": "ref: 'Prospecto'"
        },
        {
          "linea": 151,
          "contenido": "recordatorioSchema.index({ prospecto: 1 });"
        }
      ]
    },
    {
      "archivo": "\\server\\models\\Usuario.js",
      "referencias": 2,
      "detalles": [
        {
          "linea": 44,
          "contenido": "enum: ['prospectos', 'cotizaciones', 'pedidos', 'fabricacion', 'instalaciones', 'postventa', 'reportes', 'usuarios', 'configuracion']"
        },
        {
          "linea": 83,
          "contenido": "prospectosAsignados: { type: Number, default: 0 },"
        }
      ]
    },
    {
      "archivo": "\\server\\models\\WhatsAppTracking.js",
      "referencias": 4,
      "detalles": [
        {
          "linea": 9,
          "contenido": "prospecto: {"
        },
        {
          "linea": 11,
          "contenido": "ref: 'Prospecto',"
        },
        {
          "linea": 51,
          "contenido": "etapa_prospecto: String,"
        },
        {
          "linea": 65,
          "contenido": "whatsAppTrackingSchema.index({ prospecto: 1, fecha_evento: -1 });"
        }
      ]
    },
    {
      "archivo": "\\server\\routes\\backup.js",
      "referencias": 67,
      "detalles": [
        {
          "linea": 8,
          "contenido": "const Prospecto = require('../models/Prospecto');"
        },
        {
          "linea": 26,
          "contenido": "prospectos,"
        },
        {
          "linea": 31,
          "contenido": "Prospecto.find({}).lean(),"
        },
        {
          "linea": 45,
          "contenido": "prospectos: prospectos.length,"
        },
        {
          "linea": 51,
          "contenido": "prospectos,"
        },
        {
          "linea": 89,
          "contenido": "router.get('/export/prospectos', auth, verificarPermiso('prospectos', 'leer'), async (req, res) => {"
        },
        {
          "linea": 91,
          "contenido": "logger.info('Iniciando exportación de prospectos', {"
        },
        {
          "linea": 93,
          "contenido": "accion: 'exportacionProspectos',"
        },
        {
          "linea": 116,
          "contenido": "const prospectos = await Prospecto.find(filtros)"
        },
        {
          "linea": 123,
          "contenido": "exportType: 'prospectos_only',"
        },
        {
          "linea": 130,
          "contenido": "totalRecords: prospectos.length"
        },
        {
          "linea": 133,
          "contenido": "prospectos"
        },
        {
          "linea": 137,
          "contenido": "logger.info('Exportación de prospectos completada', {"
        },
        {
          "linea": 139,
          "contenido": "accion: 'exportacionProspectos',"
        },
        {
          "linea": 141,
          "contenido": "totalProspectos: prospectos.length"
        },
        {
          "linea": 144,
          "contenido": "const fileName = `prospectos_backup_${new Date().toISOString().split('T')[0]}_${Date.now()}.json`;"
        },
        {
          "linea": 152,
          "contenido": "logger.error('Error en exportación de prospectos', {"
        },
        {
          "linea": 154,
          "contenido": "accion: 'exportacionProspectos',"
        },
        {
          "linea": 168,
          "contenido": "router.get('/export/excel', auth, verificarPermiso('prospectos', 'leer'), async (req, res) => {"
        },
        {
          "linea": 172,
          "contenido": "logger.info('Iniciando exportación de prospectos a Excel', {"
        },
        {
          "linea": 186,
          "contenido": "const prospectos = await Prospecto.find(filtros)"
        },
        {
          "linea": 194,
          "contenido": "const worksheetMain = workbook.addWorksheet('Prospectos');"
        },
        {
          "linea": 215,
          "contenido": "prospectos.forEach(prospecto => {"
        },
        {
          "linea": 217,
          "contenido": "id: prospecto._id.toString(),"
        },
        {
          "linea": 218,
          "contenido": "nombre: prospecto.nombre,"
        },
        {
          "linea": 219,
          "contenido": "telefono: prospecto.telefono,"
        },
        {
          "linea": 220,
          "contenido": "email: prospecto.email || '',"
        },
        {
          "linea": 221,
          "contenido": "producto: prospecto.producto,"
        },
        {
          "linea": 222,
          "contenido": "etapa: prospecto.etapa,"
        },
        {
          "linea": 223,
          "contenido": "prioridad: prospecto.prioridad,"
        },
        {
          "linea": 224,
          "contenido": "fuente: prospecto.fuente,"
        },
        {
          "linea": 225,
          "contenido": "vendedor: prospecto.vendedorAsignado ?"
        },
        {
          "linea": 226,
          "contenido": "`${prospecto.vendedorAsignado.nombre} ${prospecto.vendedorAsignado.apellido}` : '',"
        },
        {
          "linea": 227,
          "contenido": "ciudad: prospecto.direccion?.ciudad || '',"
        },
        {
          "linea": 228,
          "contenido": "fechaCreacion: prospecto.createdAt,"
        },
        {
          "linea": 229,
          "contenido": "ultimoContacto: prospecto.fechaUltimoContacto || '',"
        },
        {
          "linea": 230,
          "contenido": "archivado: prospecto.archivado ? 'Sí' : 'No',"
        },
        {
          "linea": 231,
          "contenido": "observaciones: prospecto.descripcionNecesidad || ''"
        },
        {
          "linea": 240,
          "contenido": "total: prospectos.length,"
        },
        {
          "linea": 244,
          "contenido": "archivados: prospectos.filter(p => p.archivado).length"
        },
        {
          "linea": 247,
          "contenido": "prospectos.forEach(p => {"
        },
        {
          "linea": 258,
          "contenido": "worksheetStats.addRow(['Total Prospectos', stats.total]);"
        },
        {
          "linea": 274,
          "contenido": "const fileName = `sundeck_prospectos_${new Date().toISOString().split('T')[0]}.xlsx`;"
        },
        {
          "linea": 283,
          "contenido": "logger.error('Error en exportación Excel de prospectos', {"
        },
        {
          "linea": 321,
          "contenido": "if (backupData.data.prospectos && options.importProspectos !== false) {"
        },
        {
          "linea": 323,
          "contenido": "const prospectos = backupData.data.prospectos;"
        },
        {
          "linea": 327,
          "contenido": "for (const prospectoData of prospectos) {"
        },
        {
          "linea": 330,
          "contenido": "const existente = await Prospecto.findOne({ telefono: prospectoData.telefono });"
        },
        {
          "linea": 338,
          "contenido": "await Prospecto.findByIdAndUpdate(existente._id, prospectoData);"
        },
        {
          "linea": 342,
          "contenido": "await Prospecto.create(prospectoData);"
        },
        {
          "linea": 347,
          "contenido": "results.errors.push(`Error importando prospecto ${prospectoData.nombre}: ${error.message}`);"
        },
        {
          "linea": 351,
          "contenido": "results.imported.prospectos = importedCount;"
        },
        {
          "linea": 352,
          "contenido": "results.skipped.prospectos = skippedCount;"
        },
        {
          "linea": 354,
          "contenido": "results.errors.push(`Error general importando prospectos: ${error.message}`);"
        },
        {
          "linea": 414,
          "contenido": "totalProspectos,"
        },
        {
          "linea": 415,
          "contenido": "prospectosActivos,"
        },
        {
          "linea": 416,
          "contenido": "prospectosArchivados,"
        },
        {
          "linea": 417,
          "contenido": "prospectosPapelera,"
        },
        {
          "linea": 421,
          "contenido": "Prospecto.countDocuments({}),"
        },
        {
          "linea": 422,
          "contenido": "Prospecto.countDocuments({ activo: true, archivado: { $ne: true }, enPapelera: { $ne: true } }),"
        },
        {
          "linea": 423,
          "contenido": "Prospecto.countDocuments({ archivado: true }),"
        },
        {
          "linea": 424,
          "contenido": "Prospecto.countDocuments({ enPapelera: true }),"
        },
        {
          "linea": 431,
          "contenido": "prospectos: {"
        },
        {
          "linea": 432,
          "contenido": "total: totalProspectos,"
        },
        {
          "linea": 433,
          "contenido": "activos: prospectosActivos,"
        },
        {
          "linea": 434,
          "contenido": "archivados: prospectosArchivados,"
        },
        {
          "linea": 435,
          "contenido": "enPapelera: prospectosPapelera"
        }
      ]
    },
    {
      "archivo": "\\server\\routes\\cotizaciones.js",
      "referencias": 25,
      "detalles": [
        {
          "linea": 3,
          "contenido": "const Prospecto = require('../models/Prospecto');"
        },
        {
          "linea": 37,
          "contenido": "prospecto,"
        },
        {
          "linea": 45,
          "contenido": "if (prospecto) filtros.prospecto = prospecto;"
        },
        {
          "linea": 69,
          "contenido": "{ path: 'prospecto', select: 'nombre telefono email' },"
        },
        {
          "linea": 88,
          "contenido": "prospectoId,"
        },
        {
          "linea": 99,
          "contenido": "logger.debug('Datos extraídos desde-visita', { prospectoId, piezasCount: Array.isArray(piezas) ? piezas.length : 0, precioGeneral, totalM2, unidadMedida, origen });"
        },
        {
          "linea": 102,
          "contenido": "const prospecto = await Prospecto.findById(prospectoId);"
        },
        {
          "linea": 103,
          "contenido": "if (!prospecto) {"
        },
        {
          "linea": 104,
          "contenido": "logger.warn('Prospecto no encontrado', { prospectoId });"
        },
        {
          "linea": 105,
          "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
        },
        {
          "linea": 107,
          "contenido": "logger.debug('Prospecto encontrado', { prospectoId, nombre: prospecto.nombre });"
        },
        {
          "linea": 485,
          "contenido": "logger.debug('Creando nueva cotización', { numeroCotizacion, prospectoId });"
        },
        {
          "linea": 487,
          "contenido": "prospecto: prospectoId,"
        },
        {
          "linea": 516,
          "contenido": "{ path: 'prospecto', select: 'nombre telefono email' },"
        },
        {
          "linea": 521,
          "contenido": "prospecto.etapa = 'cotizacion';"
        },
        {
          "linea": 524,
          "contenido": "if (!prospecto.producto || prospecto.producto.trim() === '') {"
        },
        {
          "linea": 525,
          "contenido": "prospecto.producto = productos[0]?.nombre || 'Producto personalizado';"
        },
        {
          "linea": 528,
          "contenido": "await prospecto.save();"
        },
        {
          "linea": 535,
          "contenido": "logger.logError(error, { context: 'generarCotizacionDesdeVisita', prospectoId: req.body.prospectoId, userId: req.usuario?.id });"
        },
        {
          "linea": 555,
          "contenido": ".populate('prospecto')"
        },
        {
          "linea": 564,
          "contenido": "logger.debug('Cotización encontrada', { numero: cotizacion.numero, prospecto: cotizacion.prospecto?.nombre, productosCount: cotizacion.productos?.length || 0, total: cotizacion.total });"
        },
        {
          "linea": 895,
          "contenido": ".populate('prospecto')"
        },
        {
          "linea": 911,
          "contenido": "const nombreCliente = (cotizacion.prospecto?.nombre || 'Cliente').replace(/[^a-zA-Z0-9\\s]/g, '').replace(/\\s+/g, '-') || 'Cliente';"
        },
        {
          "linea": 950,
          "contenido": ".populate('prospecto')"
        },
        {
          "linea": 966,
          "contenido": "const nombreCliente = (cotizacion.prospecto?.nombre || 'Cliente').replace(/[^a-zA-Z0-9\\s]/g, '').replace(/\\s+/g, '-') || 'Cliente';"
        }
      ]
    },
    {
      "archivo": "\\server\\routes\\dashboard.js",
      "referencias": 28,
      "detalles": [
        {
          "linea": 2,
          "contenido": "const Prospecto = require('../models/Prospecto');"
        },
        {
          "linea": 26,
          "contenido": "Prospecto.countDocuments({ ...filtroUsuario, etapa: 'nuevo', activo: true }),"
        },
        {
          "linea": 27,
          "contenido": "Prospecto.countDocuments({ ...filtroUsuario, etapa: 'contactado', activo: true }),"
        },
        {
          "linea": 28,
          "contenido": "Prospecto.countDocuments({ ...filtroUsuario, etapa: 'cita_agendada', activo: true }),"
        },
        {
          "linea": 29,
          "contenido": "Prospecto.countDocuments({ ...filtroUsuario, etapa: 'cotizacion', activo: true }),"
        },
        {
          "linea": 30,
          "contenido": "Prospecto.countDocuments({ ...filtroUsuario, etapa: 'venta_cerrada', activo: true }),"
        },
        {
          "linea": 31,
          "contenido": "Prospecto.countDocuments({ ...filtroUsuario, etapa: 'pedido', activo: true }),"
        },
        {
          "linea": 34,
          "contenido": "Prospecto.countDocuments({ ...filtroUsuario, etapa: 'entregado', activo: true }),"
        },
        {
          "linea": 35,
          "contenido": "Prospecto.countDocuments({ ...filtroUsuario, etapa: 'postventa', activo: true })"
        },
        {
          "linea": 99,
          "contenido": "prospectosNuevos,"
        },
        {
          "linea": 101,
          "contenido": "ventasCerradasProspectos,"
        },
        {
          "linea": 103,
          "contenido": "montoVentasProspectos,"
        },
        {
          "linea": 106,
          "contenido": "Prospecto.countDocuments({"
        },
        {
          "linea": 118,
          "contenido": "Prospecto.countDocuments({"
        },
        {
          "linea": 124,
          "contenido": "Prospecto.countDocuments({"
        },
        {
          "linea": 138,
          "contenido": "Prospecto.aggregate(["
        },
        {
          "linea": 186,
          "contenido": "const montoVentasTotal = (montoVentasProspectos[0]?.total || 0) + (montoVentasPedidos[0]?.total || 0);"
        },
        {
          "linea": 189,
          "contenido": "const seguimientosPendientes = await Prospecto.find({"
        },
        {
          "linea": 200,
          "contenido": "const actividadReciente = await Prospecto.find({"
        },
        {
          "linea": 215,
          "contenido": "const citasHoy = await Prospecto.find({"
        },
        {
          "linea": 225,
          "contenido": "const totalProspectos = await Prospecto.countDocuments({"
        },
        {
          "linea": 231,
          "contenido": "const tasaConversion = totalProspectos > 0 ?"
        },
        {
          "linea": 238,
          "contenido": "prospectosNuevos,"
        },
        {
          "linea": 273,
          "contenido": "const metricas = await Prospecto.aggregate(["
        },
        {
          "linea": 284,
          "contenido": "totalProspectos: { $sum: 1 },"
        },
        {
          "linea": 314,
          "contenido": "totalProspectos: 1,"
        },
        {
          "linea": 319,
          "contenido": "{ $divide: ['$contactados', '$totalProspectos'] },"
        },
        {
          "linea": 346,
          "contenido": "const embudo = await Prospecto.aggregate(["
        }
      ]
    },
    {
      "archivo": "\\server\\routes\\etapas.js",
      "referencias": 61,
      "detalles": [
        {
          "linea": 5,
          "contenido": "const Prospecto = require('../models/Prospecto');"
        },
        {
          "linea": 14,
          "contenido": "router.get('/', auth, verificarPermiso('prospectos', 'leer'), async (req, res) => {"
        },
        {
          "linea": 16,
          "contenido": "const { prospectoId } = req.query;"
        },
        {
          "linea": 18,
          "contenido": "if (!prospectoId || !mongoose.Types.ObjectId.isValid(prospectoId)) {"
        },
        {
          "linea": 19,
          "contenido": "return res.status(400).json({ message: 'prospectoId inválido o requerido' });"
        },
        {
          "linea": 23,
          "contenido": "const prospecto = await Prospecto.findById(prospectoId);"
        },
        {
          "linea": 24,
          "contenido": "if (!prospecto) {"
        },
        {
          "linea": 25,
          "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
        },
        {
          "linea": 29,
          "contenido": "const etapas = await Etapa.find({ prospectoId })"
        },
        {
          "linea": 42,
          "contenido": "prospectoId: req.query.prospectoId,"
        },
        {
          "linea": 49,
          "contenido": "router.post('/', auth, verificarPermiso('prospectos', 'actualizar'), async (req, res) => {"
        },
        {
          "linea": 52,
          "contenido": "prospectoId,"
        },
        {
          "linea": 63,
          "contenido": "if (!prospectoId || !mongoose.Types.ObjectId.isValid(prospectoId)) {"
        },
        {
          "linea": 64,
          "contenido": "return res.status(400).json({ message: 'prospectoId inválido' });"
        },
        {
          "linea": 71,
          "contenido": "const prospecto = await Prospecto.findById(prospectoId);"
        },
        {
          "linea": 72,
          "contenido": "if (!prospecto) {"
        },
        {
          "linea": 73,
          "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
        },
        {
          "linea": 132,
          "contenido": "prospectoId,"
        },
        {
          "linea": 146,
          "contenido": "prospecto.fechaUltimoContacto = new Date();"
        },
        {
          "linea": 147,
          "contenido": "await prospecto.save();"
        },
        {
          "linea": 152,
          "contenido": "const proyecto = await Proyecto.findOne({ prospecto_original: prospectoId });"
        },
        {
          "linea": 155,
          "contenido": "await ProyectoSyncMiddleware.sincronizarMedidasDesdeEtapas(proyecto._id, prospectoId);"
        },
        {
          "linea": 158,
          "contenido": "prospectoId,"
        },
        {
          "linea": 165,
          "contenido": "prospectoId,"
        },
        {
          "linea": 178,
          "contenido": "prospectoId: req.body.prospectoId,"
        },
        {
          "linea": 213,
          "contenido": "prospectoId: req.query.prospectoId"
        },
        {
          "linea": 218,
          "contenido": "prospectoId,"
        },
        {
          "linea": 227,
          "contenido": "prospectoId,"
        },
        {
          "linea": 233,
          "contenido": "await generarPDFLevantamiento(req, res, { prospectoId, piezas, precioGeneral: Number(precioGeneral), totalM2: Number(totalM2), unidadMedida });"
        },
        {
          "linea": 237,
          "contenido": "prospectoId: req.query.prospectoId"
        },
        {
          "linea": 244,
          "contenido": "router.get('/pdf-viewer/:prospectoId', authSimple, async (req, res) => {"
        },
        {
          "linea": 246,
          "contenido": "prospectoId: req.params.prospectoId"
        },
        {
          "linea": 250,
          "contenido": "const { prospectoId } = req.params;"
        },
        {
          "linea": 260,
          "contenido": "prospectoId,"
        },
        {
          "linea": 272,
          "contenido": "await generarPDFLevantamiento(req, res, { prospectoId, piezas, precioGeneral: Number(precioGeneral), totalM2: Number(totalM2), unidadMedida });"
        },
        {
          "linea": 276,
          "contenido": "prospectoId: req.params.prospectoId"
        },
        {
          "linea": 285,
          "contenido": "prospectoId: req.body.prospectoId,"
        },
        {
          "linea": 293,
          "contenido": "prospectoId,"
        },
        {
          "linea": 301,
          "contenido": "prospectoId,"
        },
        {
          "linea": 305,
          "contenido": "await generarPDFLevantamiento(req, res, { prospectoId, piezas, precioGeneral, totalM2, unidadMedida });"
        },
        {
          "linea": 309,
          "contenido": "prospectoId: req.body.prospectoId,"
        },
        {
          "linea": 324,
          "contenido": "}, auth, verificarPermiso('prospectos', 'leer'), async (req, res) => {"
        },
        {
          "linea": 327,
          "contenido": "prospectoId: req.body.prospectoId,"
        },
        {
          "linea": 335,
          "contenido": "prospectoId,"
        },
        {
          "linea": 371,
          "contenido": "prospectoId,"
        },
        {
          "linea": 376,
          "contenido": "const nombreCliente = (prospecto.nombre || 'Cliente').replace(/[^a-zA-Z0-9\\s]/g, '').replace(/\\s+/g, '-') || 'Cliente';"
        },
        {
          "linea": 387,
          "contenido": "prospectoId,"
        },
        {
          "linea": 401,
          "contenido": "prospectoId: req.body.prospectoId,"
        },
        {
          "linea": 422,
          "contenido": "router.post('/levantamiento-excel', auth, verificarPermiso('prospectos', 'leer'), async (req, res) => {"
        },
        {
          "linea": 425,
          "contenido": "prospectoId,"
        },
        {
          "linea": 433,
          "contenido": "if (!prospectoId || !mongoose.Types.ObjectId.isValid(prospectoId)) {"
        },
        {
          "linea": 434,
          "contenido": "return res.status(400).json({ message: 'prospectoId inválido' });"
        },
        {
          "linea": 437,
          "contenido": "const prospecto = await Prospecto.findById(prospectoId);"
        },
        {
          "linea": 438,
          "contenido": "if (!prospecto) {"
        },
        {
          "linea": 439,
          "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
        },
        {
          "linea": 445,
          "contenido": "nombre: prospecto.nombre,"
        },
        {
          "linea": 446,
          "contenido": "telefono: prospecto.telefono,"
        },
        {
          "linea": 447,
          "contenido": "email: prospecto.email,"
        },
        {
          "linea": 448,
          "contenido": "direccion: prospecto.direccion"
        },
        {
          "linea": 458,
          "contenido": "const nombreCliente = (prospecto.nombre || 'Cliente').replace(/[^a-zA-Z0-9\\s]/g, '').replace(/\\s+/g, '-') || 'Cliente';"
        },
        {
          "linea": 478,
          "contenido": "prospectoId: req.body.prospectoId,"
        }
      ]
    },
    {
      "archivo": "\\server\\routes\\instalaciones.js",
      "referencias": 7,
      "detalles": [
        {
          "linea": 232,
          "contenido": ".populate('prospecto', 'nombre telefono direccion');"
        },
        {
          "linea": 288,
          "contenido": "nombre: fabricacion.prospecto.nombre,"
        },
        {
          "linea": 289,
          "contenido": "telefono: fabricacion.prospecto.telefono,"
        },
        {
          "linea": 290,
          "contenido": "direccion: fabricacion.prospecto.direccion"
        },
        {
          "linea": 308,
          "contenido": "nombre: fabricacion.prospecto.nombre,"
        },
        {
          "linea": 309,
          "contenido": "telefono: fabricacion.prospecto.telefono"
        },
        {
          "linea": 313,
          "contenido": "direccion: fabricacion.prospecto.direccion || {},"
        }
      ]
    },
    {
      "archivo": "\\server\\routes\\kpis.js",
      "referencias": 45,
      "detalles": [
        {
          "linea": 4,
          "contenido": "const ProspectoNoConvertido = require('../models/ProspectoNoConvertido');"
        },
        {
          "linea": 32,
          "contenido": "const razonesPerdidasQuery = await ProspectoNoConvertido.analizarPerdidas(fechaInicio, fechaFin);"
        },
        {
          "linea": 35,
          "contenido": "const prospectosRecuperables = await ProspectoNoConvertido.obtenerRecuperables(10);"
        },
        {
          "linea": 41,
          "contenido": "prospectosAbandonados: await ProspectoNoConvertido.countDocuments({"
        },
        {
          "linea": 54,
          "contenido": "prospectosRecuperables,"
        },
        {
          "linea": 57,
          "contenido": "totalProspectos: kpiActual.metricas.prospectosNuevos,"
        },
        {
          "linea": 61,
          "contenido": "prospectosEnRiesgo: prospectosRecuperables.length"
        },
        {
          "linea": 103,
          "contenido": "prospectos: conversionPorEtapa.reduce((sum, etapa) => sum + etapa.cantidad, 0),"
        },
        {
          "linea": 154,
          "contenido": "const razonesAnalisis = await ProspectoNoConvertido.analizarPerdidas("
        },
        {
          "linea": 160,
          "contenido": "const perdidasPorEtapa = await ProspectoNoConvertido.aggregate(["
        },
        {
          "linea": 174,
          "contenido": "const perdidasPorVendedor = await ProspectoNoConvertido.aggregate(["
        },
        {
          "linea": 195,
          "contenido": "const tendenciaPerdidas = await ProspectoNoConvertido.aggregate(["
        },
        {
          "linea": 249,
          "contenido": "const prospectosRecuperables = await ProspectoNoConvertido.find(filtro)"
        },
        {
          "linea": 258,
          "contenido": "alta: prospectosRecuperables.filter(p => p.scoreRecuperacion >= 70),"
        },
        {
          "linea": 259,
          "contenido": "media: prospectosRecuperables.filter(p => p.scoreRecuperacion >= 50 && p.scoreRecuperacion < 70),"
        },
        {
          "linea": 260,
          "contenido": "baja: prospectosRecuperables.filter(p => p.scoreRecuperacion < 50)"
        },
        {
          "linea": 264,
          "contenido": "const proximosSeguimientos = await ProspectoNoConvertido.find({"
        },
        {
          "linea": 276,
          "contenido": "prospectosRecuperables,"
        },
        {
          "linea": 278,
          "contenido": "alta: { cantidad: porPrioridad.alta.length, prospectos: porPrioridad.alta },"
        },
        {
          "linea": 279,
          "contenido": "media: { cantidad: porPrioridad.media.length, prospectos: porPrioridad.media },"
        },
        {
          "linea": 280,
          "contenido": "baja: { cantidad: porPrioridad.baja.length, prospectos: porPrioridad.baja }"
        },
        {
          "linea": 284,
          "contenido": "totalRecuperables: prospectosRecuperables.length,"
        },
        {
          "linea": 285,
          "contenido": "montoTotalRecuperable: prospectosRecuperables.reduce((sum, p) => sum + (p.montoEstimado || 0), 0),"
        },
        {
          "linea": 286,
          "contenido": "scorePromedio: prospectosRecuperables.length > 0"
        },
        {
          "linea": 287,
          "contenido": "? prospectosRecuperables.reduce((sum, p) => sum + p.scoreRecuperacion, 0) / prospectosRecuperables.length"
        },
        {
          "linea": 292,
          "contenido": "console.error('Error obteniendo prospectos recuperables:', error);"
        },
        {
          "linea": 293,
          "contenido": "res.status(500).json({ message: 'Error obteniendo prospectos recuperables', error: error.message });"
        },
        {
          "linea": 332,
          "contenido": "const prospectoNoConvertido = new ProspectoNoConvertido({"
        },
        {
          "linea": 352,
          "contenido": "await prospectoNoConvertido.save();"
        },
        {
          "linea": 366,
          "contenido": "message: 'Prospecto registrado como perdido',"
        },
        {
          "linea": 367,
          "contenido": "prospectoNoConvertido"
        },
        {
          "linea": 370,
          "contenido": "console.error('Error registrando prospecto perdido:', error);"
        },
        {
          "linea": 371,
          "contenido": "res.status(500).json({ message: 'Error registrando prospecto perdido', error: error.message });"
        },
        {
          "linea": 381,
          "contenido": "const prospecto = await ProspectoNoConvertido.findById(id);"
        },
        {
          "linea": 382,
          "contenido": "if (!prospecto) {"
        },
        {
          "linea": 383,
          "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
        },
        {
          "linea": 387,
          "contenido": "prospecto.intentosRecuperacion.push({"
        },
        {
          "linea": 397,
          "contenido": "prospecto.estadoRecuperacion = 'recuperado';"
        },
        {
          "linea": 398,
          "contenido": "prospecto.alertas.alertaActiva = false;"
        },
        {
          "linea": 400,
          "contenido": "prospecto.estadoRecuperacion = 'en_seguimiento';"
        },
        {
          "linea": 402,
          "contenido": "prospecto.alertas.proximoSeguimiento = new Date(proximoSeguimiento);"
        },
        {
          "linea": 405,
          "contenido": "prospecto.estadoRecuperacion = 'perdido_definitivo';"
        },
        {
          "linea": 406,
          "contenido": "prospecto.alertas.alertaActiva = false;"
        },
        {
          "linea": 409,
          "contenido": "await prospecto.save();"
        },
        {
          "linea": 413,
          "contenido": "prospecto"
        }
      ]
    },
    {
      "archivo": "\\server\\routes\\pedidos.js",
      "referencias": 40,
      "detalles": [
        {
          "linea": 4,
          "contenido": "const Prospecto = require('../models/Prospecto');"
        },
        {
          "linea": 28,
          "contenido": ".populate('prospecto', 'nombre telefono')"
        },
        {
          "linea": 59,
          "contenido": "const cotizacion = await Cotizacion.findById(cotizacionId).populate('prospecto');"
        },
        {
          "linea": 85,
          "contenido": "prospecto: cotizacion.prospecto._id,"
        },
        {
          "linea": 164,
          "contenido": "calle: cotizacion.prospecto.direccion || '',"
        },
        {
          "linea": 168,
          "contenido": "nombre: cotizacion.prospecto.nombre,"
        },
        {
          "linea": 169,
          "contenido": "telefono: cotizacion.prospecto.telefono"
        },
        {
          "linea": 181,
          "contenido": "{ path: 'prospecto', select: 'nombre telefono email' },"
        },
        {
          "linea": 191,
          "contenido": "await Prospecto.findByIdAndUpdate(cotizacion.prospecto._id, {"
        },
        {
          "linea": 219,
          "contenido": "prospectoId: nuevoPedido.prospecto?._id,"
        },
        {
          "linea": 250,
          "contenido": "const pedido = await Pedido.findById(id).populate('prospecto');"
        },
        {
          "linea": 306,
          "contenido": "let nuevaEtapaProspecto = pedido.prospecto.etapa;"
        },
        {
          "linea": 307,
          "contenido": "if (estado === 'terminado') nuevaEtapaProspecto = 'fabricacion';"
        },
        {
          "linea": 308,
          "contenido": "if (estado === 'instalado') nuevaEtapaProspecto = 'entregado';"
        },
        {
          "linea": 310,
          "contenido": "await Prospecto.findByIdAndUpdate(pedido.prospecto._id, {"
        },
        {
          "linea": 311,
          "contenido": "etapa: nuevaEtapaProspecto,"
        },
        {
          "linea": 334,
          "contenido": "{ path: 'prospecto', select: 'nombre telefono' },"
        },
        {
          "linea": 358,
          "contenido": "const pedido = await Pedido.findById(id).populate('prospecto');"
        },
        {
          "linea": 384,
          "contenido": "await Prospecto.findByIdAndUpdate(pedido.prospecto._id, {"
        },
        {
          "linea": 406,
          "contenido": "{ path: 'prospecto', select: 'nombre telefono' },"
        },
        {
          "linea": 428,
          "contenido": ".populate('prospecto')"
        },
        {
          "linea": 468,
          "contenido": "prospectoId,"
        },
        {
          "linea": 480,
          "contenido": "if (!prospectoId) {"
        },
        {
          "linea": 481,
          "contenido": "return res.status(400).json({ message: 'ProspectoId es requerido' });"
        },
        {
          "linea": 493,
          "contenido": "prospectoId,"
        },
        {
          "linea": 503,
          "contenido": "prospectoId,"
        },
        {
          "linea": 518,
          "contenido": "prospectoId"
        },
        {
          "linea": 522,
          "contenido": "const prospecto = await Prospecto.findById(prospectoId);"
        },
        {
          "linea": 523,
          "contenido": "if (!prospecto) {"
        },
        {
          "linea": 524,
          "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
        },
        {
          "linea": 529,
          "contenido": "prospectoId,"
        },
        {
          "linea": 551,
          "contenido": "prospecto: prospecto._id,"
        },
        {
          "linea": 568,
          "contenido": "prospecto: prospecto._id,"
        },
        {
          "linea": 607,
          "contenido": "direccion: prospecto.direccion || '',"
        },
        {
          "linea": 608,
          "contenido": "contacto: prospecto.telefono || ''"
        },
        {
          "linea": 642,
          "contenido": "prospecto.etapa = 'pedido';"
        },
        {
          "linea": 643,
          "contenido": "prospecto.fechaUltimoContacto = new Date();"
        },
        {
          "linea": 644,
          "contenido": "await prospecto.save();"
        },
        {
          "linea": 648,
          "contenido": ".populate('prospecto', 'nombre telefono email')"
        },
        {
          "linea": 657,
          "contenido": "prospectoId: prospecto._id"
        }
      ]
    },
    {
      "archivo": "\\server\\routes\\plantillasWhatsApp.js",
      "referencias": 7,
      "detalles": [
        {
          "linea": 354,
          "contenido": "prospecto: datos.prospecto_id,"
        },
        {
          "linea": 361,
          "contenido": "etapa_prospecto: datos.etapa_prospecto"
        },
        {
          "linea": 375,
          "contenido": "prospectoId: datos?.prospecto_id || null"
        },
        {
          "linea": 405,
          "contenido": "const { plantilla_id, prospecto_id, evento, rating, notas, mensaje_generado } = req.body;"
        },
        {
          "linea": 412,
          "contenido": "prospectoId: prospecto_id,"
        },
        {
          "linea": 425,
          "contenido": "prospecto: prospecto_id,"
        },
        {
          "linea": 474,
          "contenido": "prospectoId: prospecto_id,"
        }
      ]
    },
    {
      "archivo": "\\server\\routes\\produccion.js",
      "referencias": 9,
      "detalles": [
        {
          "linea": 28,
          "contenido": ".populate('prospecto', 'nombre telefono')"
        },
        {
          "linea": 58,
          "contenido": ".populate('prospecto', 'nombre telefono direccion');"
        },
        {
          "linea": 80,
          "contenido": "prospectoId: pedido.prospecto._id,"
        },
        {
          "linea": 92,
          "contenido": "prospecto: pedido.prospecto._id,"
        },
        {
          "linea": 98,
          "contenido": "nombre: pedido.prospecto.nombre,"
        },
        {
          "linea": 99,
          "contenido": "telefono: pedido.prospecto.telefono,"
        },
        {
          "linea": 100,
          "contenido": "direccion: pedido.prospecto.direccion || ''"
        },
        {
          "linea": 154,
          "contenido": ".populate('prospecto', 'nombre telefono')"
        },
        {
          "linea": 238,
          "contenido": ".populate('prospecto', 'nombre')"
        }
      ]
    },
    {
      "archivo": "\\server\\routes\\prospectos.js",
      "referencias": 230,
      "detalles": [
        {
          "linea": 5,
          "contenido": "const Prospecto = require('../models/Prospecto');"
        },
        {
          "linea": 17,
          "contenido": "const prospecto = await Prospecto.findById(req.params.id);"
        },
        {
          "linea": 18,
          "contenido": "if (!prospecto) {"
        },
        {
          "linea": 19,
          "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
        },
        {
          "linea": 23,
          "contenido": "evidenciasReagendamiento: prospecto.evidenciasReagendamiento || [],"
        },
        {
          "linea": 24,
          "contenido": "comentariosConArchivos: prospecto.notas.filter(nota => nota.archivos && nota.archivos.length > 0)"
        },
        {
          "linea": 27,
          "contenido": "logger.error('Error obteniendo evidencias de prospecto', {"
        },
        {
          "linea": 28,
          "contenido": "ruta: 'prospectosRoutes',"
        },
        {
          "linea": 30,
          "contenido": "prospectoId: req.params.id,"
        },
        {
          "linea": 81,
          "contenido": "router.get('/', auth, verificarPermiso('prospectos', 'leer'), async (req, res) => {"
        },
        {
          "linea": 144,
          "contenido": "const prospectos = await Prospecto.paginate(filtros, opciones);"
        },
        {
          "linea": 146,
          "contenido": "res.json(prospectos);"
        },
        {
          "linea": 148,
          "contenido": "logger.error('Error obteniendo prospectos', {"
        },
        {
          "linea": 149,
          "contenido": "ruta: 'prospectosRoutes',"
        },
        {
          "linea": 150,
          "contenido": "accion: 'listarProspectos',"
        },
        {
          "linea": 161,
          "contenido": "router.get('/:id', auth, verificarPermiso('prospectos', 'leer'), async (req, res) => {"
        },
        {
          "linea": 163,
          "contenido": "const prospecto = await Prospecto.findById(req.params.id)"
        },
        {
          "linea": 168,
          "contenido": "if (!prospecto) {"
        },
        {
          "linea": 169,
          "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
        },
        {
          "linea": 174,
          "contenido": "prospecto.vendedorAsignado?.toString() !== req.usuario._id.toString()) {"
        },
        {
          "linea": 175,
          "contenido": "return res.status(403).json({ message: 'No tienes acceso a este prospecto' });"
        },
        {
          "linea": 178,
          "contenido": "res.json(prospecto);"
        },
        {
          "linea": 180,
          "contenido": "logger.error('Error obteniendo prospecto por ID', {"
        },
        {
          "linea": 181,
          "contenido": "ruta: 'prospectosRoutes',"
        },
        {
          "linea": 182,
          "contenido": "accion: 'obtenerProspecto',"
        },
        {
          "linea": 183,
          "contenido": "prospectoId: req.params.id,"
        },
        {
          "linea": 193,
          "contenido": "router.get('/:id/comentarios', auth, verificarPermiso('prospectos', 'leer'), async (req, res) => {"
        },
        {
          "linea": 195,
          "contenido": "const prospecto = await Prospecto.findById(req.params.id)"
        },
        {
          "linea": 197,
          "contenido": "if (!prospecto) {"
        },
        {
          "linea": 198,
          "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
        },
        {
          "linea": 201,
          "contenido": "const comentarios = (prospecto.notas || []).sort((a, b) => new Date(b.fecha) - new Date(a.fecha));"
        },
        {
          "linea": 204,
          "contenido": "logger.error('Error listando comentarios de prospecto', {"
        },
        {
          "linea": 205,
          "contenido": "ruta: 'prospectosRoutes',"
        },
        {
          "linea": 207,
          "contenido": "prospectoId: req.params.id,"
        },
        {
          "linea": 217,
          "contenido": "router.post('/:id/comentarios', auth, verificarPermiso('prospectos', 'actualizar'), async (req, res) => {"
        },
        {
          "linea": 221,
          "contenido": "const prospecto = await Prospecto.findById(req.params.id);"
        },
        {
          "linea": 222,
          "contenido": "if (!prospecto) {"
        },
        {
          "linea": 223,
          "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
        },
        {
          "linea": 239,
          "contenido": "ruta: 'prospectosRoutes',"
        },
        {
          "linea": 241,
          "contenido": "prospectoId: req.params.id,"
        },
        {
          "linea": 249,
          "contenido": "prospecto.notas.push({"
        },
        {
          "linea": 257,
          "contenido": "prospecto.fechaUltimoContacto = new Date();"
        },
        {
          "linea": 258,
          "contenido": "await prospecto.save();"
        },
        {
          "linea": 259,
          "contenido": "await prospecto.populate('notas.usuario', 'nombre apellido');"
        },
        {
          "linea": 263,
          "contenido": "comentario: prospecto.notas[prospecto.notas.length - 1]"
        },
        {
          "linea": 266,
          "contenido": "logger.error('Error agregando comentario a prospecto', {"
        },
        {
          "linea": 267,
          "contenido": "ruta: 'prospectosRoutes',"
        },
        {
          "linea": 269,
          "contenido": "prospectoId: req.params.id,"
        },
        {
          "linea": 279,
          "contenido": "router.get('/:id/etapas', auth, verificarPermiso('prospectos', 'leer'), async (req, res) => {"
        },
        {
          "linea": 281,
          "contenido": "const prospecto = await Prospecto.findById(req.params.id)"
        },
        {
          "linea": 283,
          "contenido": "if (!prospecto) {"
        },
        {
          "linea": 284,
          "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
        },
        {
          "linea": 286,
          "contenido": "const etapas = (prospecto.etapas || []).sort((a, b) => new Date(a.fechaHora) - new Date(b.fechaHora));"
        },
        {
          "linea": 289,
          "contenido": "logger.error('Error listando etapas del prospecto', {"
        },
        {
          "linea": 290,
          "contenido": "ruta: 'prospectosRoutes',"
        },
        {
          "linea": 292,
          "contenido": "prospectoId: req.params.id,"
        },
        {
          "linea": 302,
          "contenido": "router.post('/:id/etapas', auth, verificarPermiso('prospectos', 'actualizar'), async (req, res) => {"
        },
        {
          "linea": 306,
          "contenido": "const prospecto = await Prospecto.findById(req.params.id);"
        },
        {
          "linea": 307,
          "contenido": "if (!prospecto) {"
        },
        {
          "linea": 308,
          "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
        },
        {
          "linea": 319,
          "contenido": "prospecto.etapas.push(etapa);"
        },
        {
          "linea": 320,
          "contenido": "await prospecto.save();"
        },
        {
          "linea": 321,
          "contenido": "await prospecto.populate('etapas.usuario', 'nombre apellido');"
        },
        {
          "linea": 325,
          "contenido": "etapa: prospecto.etapas[prospecto.etapas.length - 1]"
        },
        {
          "linea": 328,
          "contenido": "logger.error('Error agregando etapa al prospecto', {"
        },
        {
          "linea": 329,
          "contenido": "ruta: 'prospectosRoutes',"
        },
        {
          "linea": 331,
          "contenido": "prospectoId: req.params.id,"
        },
        {
          "linea": 341,
          "contenido": "router.post('/', auth, verificarPermiso('prospectos', 'crear'), async (req, res) => {"
        },
        {
          "linea": 361,
          "contenido": "const nuevoProspecto = new Prospecto({"
        },
        {
          "linea": 381,
          "contenido": "await nuevoProspecto.save();"
        },
        {
          "linea": 382,
          "contenido": "await nuevoProspecto.populate('vendedorAsignado', 'nombre apellido');"
        },
        {
          "linea": 386,
          "contenido": "await ProyectoSyncMiddleware.sincronizarProspecto(nuevoProspecto, 'create');"
        },
        {
          "linea": 387,
          "contenido": "logger.info('Proyecto sincronizado automáticamente tras crear prospecto', {"
        },
        {
          "linea": 388,
          "contenido": "ruta: 'prospectosRoutes',"
        },
        {
          "linea": 389,
          "contenido": "accion: 'crearProspecto',"
        },
        {
          "linea": 390,
          "contenido": "prospectoId: nuevoProspecto._id,"
        },
        {
          "linea": 394,
          "contenido": "logger.warn('Error sincronizando proyecto tras crear prospecto', {"
        },
        {
          "linea": 395,
          "contenido": "ruta: 'prospectosRoutes',"
        },
        {
          "linea": 396,
          "contenido": "accion: 'crearProspecto',"
        },
        {
          "linea": 397,
          "contenido": "prospectoId: nuevoProspecto._id,"
        },
        {
          "linea": 406,
          "contenido": "message: 'Prospecto creado exitosamente',"
        },
        {
          "linea": 407,
          "contenido": "prospecto: nuevoProspecto"
        },
        {
          "linea": 410,
          "contenido": "logger.error('Error creando prospecto', {"
        },
        {
          "linea": 411,
          "contenido": "ruta: 'prospectosRoutes',"
        },
        {
          "linea": 412,
          "contenido": "accion: 'crearProspecto',"
        },
        {
          "linea": 423,
          "contenido": "router.put('/:id', auth, verificarPermiso('prospectos', 'actualizar'), upload.array('evidencias', 10), async (req, res) => {"
        },
        {
          "linea": 425,
          "contenido": "const prospecto = await Prospecto.findById(req.params.id);"
        },
        {
          "linea": 427,
          "contenido": "if (!prospecto) {"
        },
        {
          "linea": 428,
          "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
        },
        {
          "linea": 433,
          "contenido": "prospecto.vendedorAsignado?.toString() !== req.usuario._id.toString()) {"
        },
        {
          "linea": 434,
          "contenido": "return res.status(403).json({ message: 'No tienes acceso a este prospecto' });"
        },
        {
          "linea": 447,
          "contenido": "prospecto[campo] = req.body[campo];"
        },
        {
          "linea": 453,
          "contenido": "prospecto.fechaArchivado = null;"
        },
        {
          "linea": 467,
          "contenido": "if (!prospecto.evidenciasReagendamiento) {"
        },
        {
          "linea": 468,
          "contenido": "prospecto.evidenciasReagendamiento = [];"
        },
        {
          "linea": 470,
          "contenido": "prospecto.evidenciasReagendamiento.push(...evidencias);"
        },
        {
          "linea": 474,
          "contenido": "if (req.body.etapa && req.body.etapa !== prospecto.etapa) {"
        },
        {
          "linea": 475,
          "contenido": "prospecto.fechaUltimoContacto = new Date();"
        },
        {
          "linea": 480,
          "contenido": "prospecto.fechaUltimoContacto = new Date();"
        },
        {
          "linea": 483,
          "contenido": "await prospecto.save();"
        },
        {
          "linea": 484,
          "contenido": "await prospecto.populate('vendedorAsignado', 'nombre apellido');"
        },
        {
          "linea": 488,
          "contenido": "await ProyectoSyncMiddleware.sincronizarProspecto(prospecto, 'update');"
        },
        {
          "linea": 489,
          "contenido": "logger.info('Proyecto sincronizado automáticamente tras actualizar prospecto', {"
        },
        {
          "linea": 490,
          "contenido": "ruta: 'prospectosRoutes',"
        },
        {
          "linea": 491,
          "contenido": "accion: 'actualizarProspecto',"
        },
        {
          "linea": 492,
          "contenido": "prospectoId: prospecto._id,"
        },
        {
          "linea": 496,
          "contenido": "logger.warn('Error sincronizando proyecto tras actualizar prospecto', {"
        },
        {
          "linea": 497,
          "contenido": "ruta: 'prospectosRoutes',"
        },
        {
          "linea": 498,
          "contenido": "accion: 'actualizarProspecto',"
        },
        {
          "linea": 499,
          "contenido": "prospectoId: prospecto._id,"
        },
        {
          "linea": 508,
          "contenido": "message: 'Prospecto actualizado exitosamente',"
        },
        {
          "linea": 509,
          "contenido": "prospecto"
        },
        {
          "linea": 512,
          "contenido": "logger.error('Error actualizando prospecto', {"
        },
        {
          "linea": 513,
          "contenido": "ruta: 'prospectosRoutes',"
        },
        {
          "linea": 514,
          "contenido": "accion: 'actualizarProspecto',"
        },
        {
          "linea": 515,
          "contenido": "prospectoId: req.params.id,"
        },
        {
          "linea": 526,
          "contenido": "router.post('/:id/notas', auth, verificarPermiso('prospectos', 'actualizar'), async (req, res) => {"
        },
        {
          "linea": 530,
          "contenido": "const prospecto = await Prospecto.findById(req.params.id);"
        },
        {
          "linea": 531,
          "contenido": "if (!prospecto) {"
        },
        {
          "linea": 532,
          "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
        },
        {
          "linea": 535,
          "contenido": "prospecto.notas.push({"
        },
        {
          "linea": 541,
          "contenido": "prospecto.fechaUltimoContacto = new Date();"
        },
        {
          "linea": 542,
          "contenido": "await prospecto.save();"
        },
        {
          "linea": 543,
          "contenido": "await prospecto.populate('notas.usuario', 'nombre apellido');"
        },
        {
          "linea": 547,
          "contenido": "nota: prospecto.notas[prospecto.notas.length - 1]"
        },
        {
          "linea": 550,
          "contenido": "logger.error('Error agregando nota al prospecto', {"
        },
        {
          "linea": 551,
          "contenido": "ruta: 'prospectosRoutes',"
        },
        {
          "linea": 553,
          "contenido": "prospectoId: req.params.id,"
        },
        {
          "linea": 563,
          "contenido": "router.put('/:id/etapa', auth, verificarPermiso('prospectos', 'actualizar'), async (req, res) => {"
        },
        {
          "linea": 567,
          "contenido": "const prospecto = await Prospecto.findById(req.params.id);"
        },
        {
          "linea": 568,
          "contenido": "if (!prospecto) {"
        },
        {
          "linea": 569,
          "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
        },
        {
          "linea": 572,
          "contenido": "const etapaAnterior = prospecto.etapa;"
        },
        {
          "linea": 573,
          "contenido": "prospecto.etapa = etapa;"
        },
        {
          "linea": 574,
          "contenido": "prospecto.fechaUltimoContacto = new Date();"
        },
        {
          "linea": 577,
          "contenido": "prospecto.notas.push({"
        },
        {
          "linea": 583,
          "contenido": "await prospecto.save();"
        },
        {
          "linea": 587,
          "contenido": "prospecto"
        },
        {
          "linea": 590,
          "contenido": "logger.error('Error cambiando etapa del prospecto', {"
        },
        {
          "linea": 591,
          "contenido": "ruta: 'prospectosRoutes',"
        },
        {
          "linea": 593,
          "contenido": "prospectoId: req.params.id,"
        },
        {
          "linea": 604,
          "contenido": "router.put('/:id/asignar', auth, verificarPermiso('prospectos', 'actualizar'), async (req, res) => {"
        },
        {
          "linea": 610,
          "contenido": "return res.status(403).json({ message: 'No tienes permisos para asignar prospectos' });"
        },
        {
          "linea": 613,
          "contenido": "const prospecto = await Prospecto.findById(req.params.id);"
        },
        {
          "linea": 614,
          "contenido": "if (!prospecto) {"
        },
        {
          "linea": 615,
          "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
        },
        {
          "linea": 618,
          "contenido": "prospecto.vendedorAsignado = vendedorId;"
        },
        {
          "linea": 619,
          "contenido": "prospecto.notas.push({"
        },
        {
          "linea": 621,
          "contenido": "contenido: `Prospecto reasignado`,"
        },
        {
          "linea": 625,
          "contenido": "await prospecto.save();"
        },
        {
          "linea": 626,
          "contenido": "await prospecto.populate('vendedorAsignado', 'nombre apellido');"
        },
        {
          "linea": 629,
          "contenido": "message: 'Prospecto asignado exitosamente',"
        },
        {
          "linea": 630,
          "contenido": "prospecto"
        },
        {
          "linea": 633,
          "contenido": "logger.error('Error asignando prospecto a vendedor', {"
        },
        {
          "linea": 634,
          "contenido": "ruta: 'prospectosRoutes',"
        },
        {
          "linea": 635,
          "contenido": "accion: 'asignarProspecto',"
        },
        {
          "linea": 636,
          "contenido": "prospectoId: req.params.id,"
        },
        {
          "linea": 660,
          "contenido": "const prospectos = await Prospecto.find(filtros)"
        },
        {
          "linea": 665,
          "contenido": "res.json(prospectos);"
        },
        {
          "linea": 667,
          "contenido": "logger.error('Error obteniendo prospectos pendientes de seguimiento', {"
        },
        {
          "linea": 668,
          "contenido": "ruta: 'prospectosRoutes',"
        },
        {
          "linea": 680,
          "contenido": "router.put('/:id/papelera', auth, verificarPermiso('prospectos', 'actualizar'), async (req, res) => {"
        },
        {
          "linea": 682,
          "contenido": "logger.info('Solicitud para mover prospecto a papelera', {"
        },
        {
          "linea": 683,
          "contenido": "ruta: 'prospectosRoutes',"
        },
        {
          "linea": 685,
          "contenido": "prospectoId: req.params.id,"
        },
        {
          "linea": 691,
          "contenido": "const prospecto = await Prospecto.findById(req.params.id);"
        },
        {
          "linea": 692,
          "contenido": "if (!prospecto) {"
        },
        {
          "linea": 693,
          "contenido": "logger.warn('Prospecto no encontrado al intentar mover a papelera', {"
        },
        {
          "linea": 694,
          "contenido": "ruta: 'prospectosRoutes',"
        },
        {
          "linea": 696,
          "contenido": "prospectoId: req.params.id,"
        },
        {
          "linea": 699,
          "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
        },
        {
          "linea": 702,
          "contenido": "logger.debug('Prospecto localizado para mover a papelera', {"
        },
        {
          "linea": 703,
          "contenido": "ruta: 'prospectosRoutes',"
        },
        {
          "linea": 705,
          "contenido": "prospectoId: prospecto._id,"
        },
        {
          "linea": 706,
          "contenido": "nombreProspecto: prospecto.nombre,"
        },
        {
          "linea": 710,
          "contenido": "prospecto.enPapelera = true;"
        },
        {
          "linea": 711,
          "contenido": "prospecto.fechaEliminacion = new Date();"
        },
        {
          "linea": 712,
          "contenido": "prospecto.eliminadoPor = req.usuario._id;"
        },
        {
          "linea": 713,
          "contenido": "await prospecto.save();"
        },
        {
          "linea": 715,
          "contenido": "logger.info('Prospecto movido a papelera exitosamente', {"
        },
        {
          "linea": 716,
          "contenido": "ruta: 'prospectosRoutes',"
        },
        {
          "linea": 718,
          "contenido": "prospectoId: prospecto._id,"
        },
        {
          "linea": 721,
          "contenido": "res.json({ message: 'Prospecto movido a papelera exitosamente' });"
        },
        {
          "linea": 723,
          "contenido": "logger.error('Error moviendo prospecto a papelera', {"
        },
        {
          "linea": 724,
          "contenido": "ruta: 'prospectosRoutes',"
        },
        {
          "linea": 726,
          "contenido": "prospectoId: req.params.id,"
        },
        {
          "linea": 736,
          "contenido": "router.put('/:id/restaurar', auth, verificarPermiso('prospectos', 'actualizar'), async (req, res) => {"
        },
        {
          "linea": 738,
          "contenido": "const prospecto = await Prospecto.findById(req.params.id);"
        },
        {
          "linea": 739,
          "contenido": "if (!prospecto) {"
        },
        {
          "linea": 740,
          "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
        },
        {
          "linea": 743,
          "contenido": "prospecto.enPapelera = false;"
        },
        {
          "linea": 744,
          "contenido": "prospecto.fechaEliminacion = null;"
        },
        {
          "linea": 745,
          "contenido": "prospecto.eliminadoPor = null;"
        },
        {
          "linea": 746,
          "contenido": "await prospecto.save();"
        },
        {
          "linea": 748,
          "contenido": "res.json({ message: 'Prospecto restaurado exitosamente' });"
        },
        {
          "linea": 750,
          "contenido": "logger.error('Error restaurando prospecto desde papelera', {"
        },
        {
          "linea": 751,
          "contenido": "ruta: 'prospectosRoutes',"
        },
        {
          "linea": 752,
          "contenido": "accion: 'restaurarProspecto',"
        },
        {
          "linea": 753,
          "contenido": "prospectoId: req.params.id,"
        },
        {
          "linea": 763,
          "contenido": "router.get('/papelera/listar', auth, verificarPermiso('prospectos', 'leer'), async (req, res) => {"
        },
        {
          "linea": 787,
          "contenido": "const result = await Prospecto.paginate(filtros, options);"
        },
        {
          "linea": 790,
          "contenido": "logger.error('Error obteniendo prospectos en papelera', {"
        },
        {
          "linea": 791,
          "contenido": "ruta: 'prospectosRoutes',"
        },
        {
          "linea": 803,
          "contenido": "router.delete('/:id/permanente', auth, verificarPermiso('prospectos', 'actualizar'), async (req, res) => {"
        },
        {
          "linea": 805,
          "contenido": "const prospecto = await Prospecto.findById(req.params.id);"
        },
        {
          "linea": 806,
          "contenido": "if (!prospecto) {"
        },
        {
          "linea": 807,
          "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
        },
        {
          "linea": 812,
          "contenido": "prospecto.vendedorAsignado?.toString() !== req.usuario._id.toString()) {"
        },
        {
          "linea": 813,
          "contenido": "return res.status(403).json({ message: 'No tienes acceso a este prospecto' });"
        },
        {
          "linea": 817,
          "contenido": "if (!prospecto.enPapelera) {"
        },
        {
          "linea": 818,
          "contenido": "return res.status(400).json({ message: 'El prospecto debe estar en papelera para eliminarlo permanentemente' });"
        },
        {
          "linea": 821,
          "contenido": "await Prospecto.findByIdAndDelete(req.params.id);"
        },
        {
          "linea": 823,
          "contenido": "res.json({ message: 'Prospecto eliminado permanentemente' });"
        },
        {
          "linea": 825,
          "contenido": "logger.error('Error eliminando prospecto permanentemente', {"
        },
        {
          "linea": 826,
          "contenido": "ruta: 'prospectosRoutes',"
        },
        {
          "linea": 828,
          "contenido": "prospectoId: req.params.id,"
        },
        {
          "linea": 838,
          "contenido": "router.delete('/:id/forzar', auth, verificarPermiso('prospectos', 'actualizar'), async (req, res) => {"
        },
        {
          "linea": 840,
          "contenido": "const prospecto = await Prospecto.findById(req.params.id);"
        },
        {
          "linea": 841,
          "contenido": "if (!prospecto) {"
        },
        {
          "linea": 842,
          "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
        },
        {
          "linea": 850,
          "contenido": "await Prospecto.findByIdAndDelete(req.params.id);"
        },
        {
          "linea": 852,
          "contenido": "res.json({ message: 'Prospecto eliminado permanentemente (forzado)' });"
        },
        {
          "linea": 854,
          "contenido": "logger.error('Error eliminando prospecto de forma forzada', {"
        },
        {
          "linea": 855,
          "contenido": "ruta: 'prospectosRoutes',"
        },
        {
          "linea": 857,
          "contenido": "prospectoId: req.params.id,"
        },
        {
          "linea": 867,
          "contenido": "router.delete('/papelera/vaciar', auth, verificarPermiso('prospectos', 'actualizar'), async (req, res) => {"
        },
        {
          "linea": 879,
          "contenido": "const result = await Prospecto.deleteMany(filtros);"
        },
        {
          "linea": 882,
          "contenido": "message: `${result.deletedCount} prospectos eliminados permanentemente`,"
        },
        {
          "linea": 886,
          "contenido": "logger.error('Error vaciando la papelera de prospectos', {"
        },
        {
          "linea": 887,
          "contenido": "ruta: 'prospectosRoutes',"
        }
      ]
    },
    {
      "archivo": "\\server\\routes\\proyectos.js",
      "referencias": 5,
      "detalles": [
        {
          "linea": 16,
          "contenido": "crearDesdeProspecto,"
        },
        {
          "linea": 99,
          "contenido": "router.post('/desde-prospecto/:prospectoId',"
        },
        {
          "linea": 102,
          "contenido": "crearDesdeProspecto"
        },
        {
          "linea": 229,
          "contenido": ".populate('prospecto')"
        },
        {
          "linea": 256,
          "contenido": ".populate('prospecto')"
        }
      ]
    },
    {
      "archivo": "\\server\\routes\\recordatorios.js",
      "referencias": 1,
      "detalles": [
        {
          "linea": 17,
          "contenido": ".populate('prospecto', 'nombre telefono')"
        }
      ]
    },
    {
      "archivo": "\\server\\scripts\\auditoria_colecciones.js",
      "referencias": 1,
      "detalles": [
        {
          "linea": 25,
          "contenido": "const coleccionesClave = ['prospectos', 'proyectos', 'cotizacions', 'pedidos', 'ordenfabricacions'];"
        }
      ]
    },
    {
      "archivo": "\\server\\scripts\\auditoria_dependencias_prospecto.js",
      "referencias": 4,
      "detalles": [
        {
          "linea": 26,
          "contenido": "if (linea.toLowerCase().includes('prospecto') &&"
        },
        {
          "linea": 94,
          "contenido": "let markdown = `# 📊 AUDITORÍA DE DEPENDENCIAS — PROSPECTO LEGACY"
        },
        {
          "linea": 171,
          "contenido": "const reportePath = path.join(process.cwd(), 'docs', 'proyectos', 'auditorias', 'dependencias_prospecto_legacy.md');"
        },
        {
          "linea": 177,
          "contenido": "const jsonPath = path.join(process.cwd(), 'docs', 'proyectos', 'auditorias', 'dependencias_prospecto_legacy.json');"
        }
      ]
    },
    {
      "archivo": "\\server\\scripts\\buscarProspecto.js",
      "referencias": 4,
      "detalles": [
        {
          "linea": 2,
          "contenido": "const Prospecto = require('../models/Prospecto');"
        },
        {
          "linea": 16,
          "contenido": "const prospectos = await Prospecto.find(query)"
        },
        {
          "linea": 20,
          "contenido": "console.log(`📊 Total prospectos: ${prospectos.length}\\n`);"
        },
        {
          "linea": 22,
          "contenido": "prospectos.forEach((p, i) => {"
        }
      ]
    },
    {
      "archivo": "\\server\\scripts\\crearDatosPruebaFlujoTecnico.js",
      "referencias": 26,
      "detalles": [
        {
          "linea": 14,
          "contenido": "const Prospecto = require('../models/Prospecto');"
        },
        {
          "linea": 29,
          "contenido": "async function crearProspectoPrueba() {"
        },
        {
          "linea": 30,
          "contenido": "log('\\n📋 Creando prospecto de prueba...', 'yellow');"
        },
        {
          "linea": 32,
          "contenido": "const prospecto = new Prospecto({"
        },
        {
          "linea": 49,
          "contenido": "await prospecto.save();"
        },
        {
          "linea": 50,
          "contenido": "log(`✅ Prospecto creado: ${prospecto.nombre} (${prospecto._id})`, 'green');"
        },
        {
          "linea": 52,
          "contenido": "return prospecto;"
        },
        {
          "linea": 55,
          "contenido": "async function crearProyectoConLevantamiento(prospecto) {"
        },
        {
          "linea": 64,
          "contenido": "nombre: prospecto.nombre,"
        },
        {
          "linea": 65,
          "contenido": "telefono: prospecto.telefono,"
        },
        {
          "linea": 66,
          "contenido": "email: prospecto.email,"
        },
        {
          "linea": 67,
          "contenido": "direccion: prospecto.direccion"
        },
        {
          "linea": 69,
          "contenido": "prospecto: prospecto._id,"
        },
        {
          "linea": 194,
          "contenido": "async function crearCotizacion(proyecto, prospecto) {"
        },
        {
          "linea": 205,
          "contenido": "prospecto: prospecto._id,"
        },
        {
          "linea": 246,
          "contenido": "async function crearPedido(cotizacion, proyecto, prospecto) {"
        },
        {
          "linea": 255,
          "contenido": "prospecto: prospecto._id,"
        },
        {
          "linea": 278,
          "contenido": "direccionEntrega: prospecto.direccion,"
        },
        {
          "linea": 280,
          "contenido": "nombre: prospecto.nombre,"
        },
        {
          "linea": 281,
          "contenido": "telefono: prospecto.telefono,"
        },
        {
          "linea": 344,
          "contenido": "await Prospecto.deleteMany({ nombre: 'Juan Pérez García' });"
        },
        {
          "linea": 351,
          "contenido": "const prospecto = await crearProspectoPrueba();"
        },
        {
          "linea": 352,
          "contenido": "const proyecto = await crearProyectoConLevantamiento(prospecto);"
        },
        {
          "linea": 353,
          "contenido": "const cotizacion = await crearCotizacion(proyecto, prospecto);"
        },
        {
          "linea": 354,
          "contenido": "const pedido = await crearPedido(cotizacion, proyecto, prospecto);"
        },
        {
          "linea": 363,
          "contenido": "log(`\\n✅ Prospecto: ${prospecto.nombre} (${prospecto._id})`, 'green');"
        }
      ]
    },
    {
      "archivo": "\\server\\scripts\\crearDatosSimple.js",
      "referencias": 11,
      "detalles": [
        {
          "linea": 3,
          "contenido": "const Prospecto = require('../models/Prospecto');"
        },
        {
          "linea": 17,
          "contenido": "const prospecto = new Prospecto({"
        },
        {
          "linea": 24,
          "contenido": "await prospecto.save();"
        },
        {
          "linea": 25,
          "contenido": "logger.info('Prospecto de prueba creado', {"
        },
        {
          "linea": 27,
          "contenido": "prospectoId: prospecto._id.toString(),"
        },
        {
          "linea": 28,
          "contenido": "nombre: prospecto.nombre"
        },
        {
          "linea": 33,
          "contenido": "prospecto: prospecto._id,"
        },
        {
          "linea": 51,
          "contenido": "prospectoId: prospecto._id.toString()"
        },
        {
          "linea": 56,
          "contenido": "prospecto: prospecto._id,"
        },
        {
          "linea": 58,
          "contenido": "creado_por: prospecto._id,"
        },
        {
          "linea": 118,
          "contenido": "prospectoId: prospecto._id.toString(),"
        }
      ]
    },
    {
      "archivo": "\\server\\scripts\\crearProyectosPrueba.js",
      "referencias": 9,
      "detalles": [
        {
          "linea": 3,
          "contenido": "const Prospecto = require('../models/Prospecto');"
        },
        {
          "linea": 18,
          "contenido": "const prospecto = new Prospecto({"
        },
        {
          "linea": 29,
          "contenido": "await prospecto.save();"
        },
        {
          "linea": 30,
          "contenido": "logger.info('Prospecto de prueba creado', {"
        },
        {
          "linea": 32,
          "contenido": "prospectoId: prospecto._id.toString(),"
        },
        {
          "linea": 33,
          "contenido": "nombre: prospecto.nombre"
        },
        {
          "linea": 38,
          "contenido": "prospecto: prospecto._id,"
        },
        {
          "linea": 57,
          "contenido": "prospectoId: prospecto._id.toString()"
        },
        {
          "linea": 62,
          "contenido": "prospecto: prospecto._id,"
        }
      ]
    },
    {
      "archivo": "\\server\\scripts\\eliminarDatosPrueba.js",
      "referencias": 3,
      "detalles": [
        {
          "linea": 9,
          "contenido": "const Prospecto = require('../models/Prospecto');"
        },
        {
          "linea": 31,
          "contenido": "const resultProspectos = await Prospecto.deleteMany({ nombre: 'Juan Pérez García' });"
        },
        {
          "linea": 37,
          "contenido": "log(`   Prospectos: ${resultProspectos.deletedCount}`, 'reset');"
        }
      ]
    },
    {
      "archivo": "\\server\\scripts\\insertarDatos.js",
      "referencias": 3,
      "detalles": [
        {
          "linea": 22,
          "contenido": "prospecto: objectId,"
        },
        {
          "linea": 119,
          "contenido": "prospecto: new mongoose.Types.ObjectId(),"
        },
        {
          "linea": 162,
          "contenido": "prospecto: new mongoose.Types.ObjectId(),"
        }
      ]
    },
    {
      "archivo": "\\server\\scripts\\limpiarBaseDatos.js",
      "referencias": 6,
      "detalles": [
        {
          "linea": 7,
          "contenido": "const Prospecto = require('../models/Prospecto');"
        },
        {
          "linea": 34,
          "contenido": "prospectos: await Prospecto.countDocuments(),"
        },
        {
          "linea": 44,
          "contenido": "console.log(`   - Prospectos: ${conteoAntes.prospectos}`);"
        },
        {
          "linea": 68,
          "contenido": "prospectos: await Prospecto.deleteMany({}),"
        },
        {
          "linea": 77,
          "contenido": "console.log(`   - Prospectos: ${resultados.prospectos.deletedCount} eliminados`);"
        },
        {
          "linea": 89,
          "contenido": "prospectos: resultados.prospectos.deletedCount,"
        }
      ]
    },
    {
      "archivo": "\\server\\scripts\\migrarAProyectos.js",
      "referencias": 37,
      "detalles": [
        {
          "linea": 2,
          "contenido": "const Prospecto = require('../models/Prospecto');"
        },
        {
          "linea": 25,
          "contenido": "prospectos: 0,"
        },
        {
          "linea": 61,
          "contenido": "const prospectos = await Prospecto.find({}).lean();"
        },
        {
          "linea": 62,
          "contenido": "logger.info('Prospectos recuperados para migración completa', {"
        },
        {
          "linea": 65,
          "contenido": "totalProspectos: prospectos.length"
        },
        {
          "linea": 68,
          "contenido": "for (const prospecto of prospectos) {"
        },
        {
          "linea": 70,
          "contenido": "await this.migrarProspecto(prospecto);"
        },
        {
          "linea": 71,
          "contenido": "this.estadisticas.prospectos++;"
        },
        {
          "linea": 73,
          "contenido": "logger.error('Error migrando prospecto en proceso masivo', {"
        },
        {
          "linea": 76,
          "contenido": "prospectoId: prospecto._id,"
        },
        {
          "linea": 81,
          "contenido": "tipo: 'prospecto',"
        },
        {
          "linea": 82,
          "contenido": "id: prospecto._id,"
        },
        {
          "linea": 96,
          "contenido": "async migrarProspecto(prospecto) {"
        },
        {
          "linea": 97,
          "contenido": "logger.info('Migrando prospecto a proyecto unificado', {"
        },
        {
          "linea": 99,
          "contenido": "etapa: 'migrarProspecto',"
        },
        {
          "linea": 100,
          "contenido": "prospectoId: prospecto._id,"
        },
        {
          "linea": 101,
          "contenido": "prospectoNombre: prospecto.nombre"
        },
        {
          "linea": 105,
          "contenido": "const etapas = await Etapa.find({ prospectoId: prospecto._id }).lean();"
        },
        {
          "linea": 108,
          "contenido": "etapa: 'migrarProspecto',"
        },
        {
          "linea": 109,
          "contenido": "prospectoId: prospecto._id,"
        },
        {
          "linea": 114,
          "contenido": "const cotizaciones = await Cotizacion.find({ prospecto: prospecto._id }).lean();"
        },
        {
          "linea": 117,
          "contenido": "etapa: 'migrarProspecto',"
        },
        {
          "linea": 118,
          "contenido": "prospectoId: prospecto._id,"
        },
        {
          "linea": 123,
          "contenido": "const pedidos = await Pedido.find({ prospecto: prospecto._id }).lean();"
        },
        {
          "linea": 126,
          "contenido": "etapa: 'migrarProspecto',"
        },
        {
          "linea": 127,
          "contenido": "prospectoId: prospecto._id,"
        },
        {
          "linea": 143,
          "contenido": "prospecto: prospecto._id,"
        },
        {
          "linea": 151,
          "contenido": "nombre: prospecto.nombre,"
        },
        {
          "linea": 152,
          "contenido": "telefono: prospecto.telefono,"
        },
        {
          "linea": 153,
          "contenido": "email: prospecto.email,"
        },
        {
          "linea": 154,
          "contenido": "direccion: prospecto.direccion || {}"
        },
        {
          "linea": 167,
          "contenido": "fechaCreacion: prospecto.fechaCreacion || new Date(),"
        },
        {
          "linea": 179,
          "contenido": "origenProspecto: prospecto._id,"
        },
        {
          "linea": 190,
          "contenido": "logger.info('Proyecto unificado creado para prospecto', {"
        },
        {
          "linea": 192,
          "contenido": "etapa: 'migrarProspecto',"
        },
        {
          "linea": 193,
          "contenido": "prospectoId: prospecto._id,"
        },
        {
          "linea": 407,
          "contenido": "prospectosMigrados: this.estadisticas.prospectos,"
        }
      ]
    },
    {
      "archivo": "\\server\\scripts\\migrarDatos.js",
      "referencias": 45,
      "detalles": [
        {
          "linea": 2,
          "contenido": "const Prospecto = require('../models/Prospecto');"
        },
        {
          "linea": 31,
          "contenido": "async function migrarProspectosAProyectos() {"
        },
        {
          "linea": 33,
          "contenido": "logger.info('Iniciando migración de prospectos a proyectos', {"
        },
        {
          "linea": 35,
          "contenido": "etapa: 'migrarProspectosAProyectos'"
        },
        {
          "linea": 39,
          "contenido": "const prospectos = await Prospecto.find({}).lean();"
        },
        {
          "linea": 40,
          "contenido": "logger.info('Prospectos recuperados para sincronización', {"
        },
        {
          "linea": 42,
          "contenido": "etapa: 'migrarProspectosAProyectos',"
        },
        {
          "linea": 43,
          "contenido": "totalProspectos: prospectos.length"
        },
        {
          "linea": 50,
          "contenido": "for (const prospecto of prospectos) {"
        },
        {
          "linea": 54,
          "contenido": "prospecto_original: prospecto._id"
        },
        {
          "linea": 59,
          "contenido": "await ProyectoSyncMiddleware.sincronizarProspecto(prospecto, 'update');"
        },
        {
          "linea": 63,
          "contenido": "await ProyectoSyncMiddleware.sincronizarProspecto(prospecto, 'create');"
        },
        {
          "linea": 68,
          "contenido": "const proyecto = await Proyecto.findOne({ prospecto_original: prospecto._id });"
        },
        {
          "linea": 72,
          "contenido": "prospecto._id"
        },
        {
          "linea": 74,
          "contenido": "logger.info('Proyecto sincronizado desde prospecto', {"
        },
        {
          "linea": 76,
          "contenido": "etapa: 'migrarProspectosAProyectos',"
        },
        {
          "linea": 78,
          "contenido": "prospectoId: prospecto._id,"
        },
        {
          "linea": 79,
          "contenido": "prospectoNombre: prospecto.nombre,"
        },
        {
          "linea": 85,
          "contenido": "etapa: 'migrarProspectosAProyectos',"
        },
        {
          "linea": 86,
          "contenido": "prospectoId: prospecto._id,"
        },
        {
          "linea": 87,
          "contenido": "prospectoNombre: prospecto.nombre,"
        },
        {
          "linea": 93,
          "contenido": "logger.error('Error procesando prospecto durante migración', {"
        },
        {
          "linea": 95,
          "contenido": "etapa: 'migrarProspectosAProyectos',"
        },
        {
          "linea": 96,
          "contenido": "prospectoId: prospecto._id,"
        },
        {
          "linea": 97,
          "contenido": "prospectoNombre: prospecto.nombre,"
        },
        {
          "linea": 105,
          "contenido": "logger.info('Resumen de migración de prospectos a proyectos', {"
        },
        {
          "linea": 107,
          "contenido": "etapa: 'migrarProspectosAProyectos',"
        },
        {
          "linea": 115,
          "contenido": "logger.error('Error general en migración de prospectos a proyectos', {"
        },
        {
          "linea": 117,
          "contenido": "etapa: 'migrarProspectosAProyectos',"
        },
        {
          "linea": 132,
          "contenido": "const totalProspectos = await Prospecto.countDocuments({});"
        },
        {
          "linea": 134,
          "contenido": "const proyectosConProspecto = await Proyecto.countDocuments({"
        },
        {
          "linea": 135,
          "contenido": "prospecto_original: { $exists: true, $ne: null }"
        },
        {
          "linea": 141,
          "contenido": "totalProspectos,"
        },
        {
          "linea": 143,
          "contenido": "proyectosConProspecto"
        },
        {
          "linea": 213,
          "contenido": "prospecto_original: { $exists: true, $ne: null }"
        },
        {
          "linea": 218,
          "contenido": "_id: '$prospecto_original',"
        },
        {
          "linea": 228,
          "contenido": "logger.info('Proyectos duplicados detectados por prospecto', {"
        },
        {
          "linea": 231,
          "contenido": "prospectosDuplicados: duplicados.length"
        },
        {
          "linea": 247,
          "contenido": "prospectoId: grupo._id,"
        },
        {
          "linea": 279,
          "contenido": "await Proyecto.collection.createIndex({ prospecto_original: 1 });"
        },
        {
          "linea": 289,
          "contenido": "'prospecto_original',"
        },
        {
          "linea": 318,
          "contenido": "total_prospectos: await Prospecto.countDocuments({}),"
        },
        {
          "linea": 321,
          "contenido": "prospecto_original: { $exists: true, $ne: null }"
        },
        {
          "linea": 380,
          "contenido": "await migrarProspectosAProyectos();"
        },
        {
          "linea": 416,
          "contenido": "migrarProspectosAProyectos,"
        }
      ]
    },
    {
      "archivo": "\\server\\scripts\\migrarProyectoPedidoAProyecto.js",
      "referencias": 2,
      "detalles": [
        {
          "linea": 341,
          "contenido": "prospecto_original: proyectoExistente.prospecto_original || proyectoPedido.prospecto,"
        },
        {
          "linea": 383,
          "contenido": "prospecto_original: proyectoPedido.prospecto || undefined,"
        }
      ]
    },
    {
      "archivo": "\\server\\scripts\\plantillasIniciales.js",
      "referencias": 2,
      "detalles": [
        {
          "linea": 239,
          "contenido": "nombre: \"Recontacto Prospecto Frío - Formal\","
        },
        {
          "linea": 260,
          "contenido": "nombre: \"Recontacto Prospecto Frío - Breve\","
        }
      ]
    },
    {
      "archivo": "\\server\\scripts\\pruebasFinales.js",
      "referencias": 1,
      "detalles": [
        {
          "linea": 77,
          "contenido": "const camposRequeridos = ['numero', 'cotizacion', 'prospecto', 'montoTotal', 'anticipo', 'saldo', 'productos', 'estado'];"
        }
      ]
    },
    {
      "archivo": "\\server\\scripts\\seedData.js",
      "referencias": 15,
      "detalles": [
        {
          "linea": 8,
          "contenido": "const Prospecto = require('../models/Prospecto');"
        },
        {
          "linea": 25,
          "contenido": "await Prospecto.deleteMany({});"
        },
        {
          "linea": 29,
          "contenido": "colecciones: ['Usuario', 'Producto', 'Prospecto', 'Plantilla']"
        },
        {
          "linea": 42,
          "contenido": "modulo: 'prospectos',"
        },
        {
          "linea": 87,
          "contenido": "modulo: 'prospectos',"
        },
        {
          "linea": 107,
          "contenido": "modulo: 'prospectos',"
        },
        {
          "linea": 270,
          "contenido": "const prospectos = ["
        },
        {
          "linea": 402,
          "contenido": "await Prospecto.insertMany(prospectos);"
        },
        {
          "linea": 403,
          "contenido": "logger.info('Prospectos de ejemplo creados', {"
        },
        {
          "linea": 405,
          "contenido": "prospectosCreados: prospectos.length"
        },
        {
          "linea": 412,
          "contenido": "descripcion: 'Mensaje de primer contacto con nuevos prospectos',"
        },
        {
          "linea": 417,
          "contenido": "{ nombre: 'nombre', descripcion: 'Nombre del prospecto' },"
        },
        {
          "linea": 428,
          "contenido": "{ nombre: 'nombre', descripcion: 'Nombre del prospecto' },"
        },
        {
          "linea": 450,
          "contenido": "{ nombre: 'nombre', descripcion: 'Nombre del prospecto' },"
        },
        {
          "linea": 463,
          "contenido": "{ nombre: 'nombre', descripcion: 'Nombre del prospecto' },"
        }
      ]
    },
    {
      "archivo": "\\server\\scripts\\validarFlujoTecnicoUnificado.js",
      "referencias": 3,
      "detalles": [
        {
          "linea": 14,
          "contenido": "const Prospecto = require('../models/Prospecto');"
        },
        {
          "linea": 230,
          "contenido": ".populate('prospecto', 'nombre')"
        },
        {
          "linea": 240,
          "contenido": "log(`   Cliente: ${pedido.prospecto?.nombre || 'N/A'}`, 'reset');"
        }
      ]
    },
    {
      "archivo": "\\server\\services\\cotizacionMappingService.js",
      "referencias": 1,
      "detalles": [
        {
          "linea": 252,
          "contenido": "prospecto: datos.prospectoId,"
        }
      ]
    },
    {
      "archivo": "\\server\\services\\excelService.js",
      "referencias": 4,
      "detalles": [
        {
          "linea": 61,
          "contenido": "async generarLevantamientoExcel(prospecto, piezas, precioGeneral, totalM2, unidadMedida = 'm', tipoVisita = 'levantamiento') {"
        },
        {
          "linea": 146,
          "contenido": "infoCell.value = `Cliente: ${prospecto.nombre || 'N/A'} | Teléfono: ${prospecto.telefono || 'N/A'} | Fecha: ${this.formatDate(new Date())}`;"
        },
        {
          "linea": 464,
          "contenido": "prospectoId: prospecto?._id?.toString(),"
        },
        {
          "linea": 500,
          "contenido": "worksheet.addRow(['Cliente', cotizacion.prospecto?.nombre || '']);"
        }
      ]
    },
    {
      "archivo": "\\server\\services\\metricasComerciales.js",
      "referencias": 2,
      "detalles": [
        {
          "linea": 299,
          "contenido": ".populate('prospecto', 'nombre telefono')"
        },
        {
          "linea": 303,
          "contenido": ".select('numero montoTotal estado fechaPedido prospecto vendedor');"
        }
      ]
    },
    {
      "archivo": "\\server\\services\\notificacionesComerciales.js",
      "referencias": 11,
      "detalles": [
        {
          "linea": 122,
          "contenido": "}).populate('prospecto', 'nombre telefono')"
        },
        {
          "linea": 140,
          "contenido": "cliente: pedido.prospecto?.nombre || 'Cliente',"
        },
        {
          "linea": 166,
          "contenido": "}).populate('prospecto', 'nombre telefono')"
        },
        {
          "linea": 176,
          "contenido": "cliente: pedido.prospecto?.nombre || 'Cliente'"
        },
        {
          "linea": 180,
          "contenido": "cliente: pedido.prospecto?.nombre || 'Cliente',"
        },
        {
          "linea": 202,
          "contenido": "}).populate('prospecto', 'nombre telefono')"
        },
        {
          "linea": 219,
          "contenido": "cliente: pedido.prospecto?.nombre || 'Cliente',"
        },
        {
          "linea": 240,
          "contenido": "}).populate('prospecto', 'nombre telefono')"
        },
        {
          "linea": 253,
          "contenido": "cliente: pedido.prospecto?.nombre || 'Cliente',"
        },
        {
          "linea": 284,
          "contenido": "}).populate('prospecto', 'nombre telefono')"
        },
        {
          "linea": 299,
          "contenido": "cliente: pedido.prospecto?.nombre || 'Cliente',"
        }
      ]
    },
    {
      "archivo": "\\server\\services\\pdfService.js",
      "referencias": 20,
      "detalles": [
        {
          "linea": 792,
          "contenido": "prospecto: {"
        },
        {
          "linea": 793,
          "contenido": "id: getDocumentId(cotizacion?.prospecto),"
        },
        {
          "linea": 794,
          "contenido": "nombre: cotizacion?.prospecto?.nombre"
        },
        {
          "linea": 1592,
          "contenido": "<span class=\"info-label\">Nombre:</span> {{prospecto.nombre}}"
        },
        {
          "linea": 1595,
          "contenido": "<span class=\"info-label\">Teléfono:</span> {{prospecto.telefono}}"
        },
        {
          "linea": 1600,
          "contenido": "<span class=\"info-label\">Email:</span> {{prospecto.email}}"
        },
        {
          "linea": 1602,
          "contenido": "{{#if prospecto.direccion}}"
        },
        {
          "linea": 1604,
          "contenido": "<span class=\"info-label\">Dirección:</span> {{prospecto.direccion}}"
        },
        {
          "linea": 2081,
          "contenido": "prospectoNombre: etapa?.prospecto?.nombre"
        },
        {
          "linea": 2478,
          "contenido": "<td>{{prospecto.nombre}}</td>"
        },
        {
          "linea": 2484,
          "contenido": "<td>{{prospecto.telefono}}</td>"
        },
        {
          "linea": 2490,
          "contenido": "<td colspan=\"3\">{{#if prospecto.email}}{{prospecto.email}}{{else}}-{{/if}}</td>"
        },
        {
          "linea": 2492,
          "contenido": "{{#if prospecto.direccion}}"
        },
        {
          "linea": 2496,
          "contenido": "{{#if prospecto.direccion.calle}}"
        },
        {
          "linea": 2497,
          "contenido": "{{prospecto.direccion.calle}}, {{prospecto.direccion.colonia}}, {{prospecto.direccion.ciudad}}, CP {{prospecto.direccion.codigoPostal}}"
        },
        {
          "linea": 2498,
          "contenido": "{{#if prospecto.direccion.referencias}}<br><em>Ref: {{prospecto.direccion.referencias}}</em>{{/if}}"
        },
        {
          "linea": 2499,
          "contenido": "{{#if prospecto.direccion.linkMapa}}<br><a href=\"{{prospecto.direccion.linkMapa}}\" target=\"_blank\" style=\"color: #1E40AF; text-decoration: none;\">📍 Ver en Google Maps</a>{{/if}}"
        },
        {
          "linea": 2501,
          "contenido": "{{formatDireccion prospecto.direccion}}"
        },
        {
          "linea": 2876,
          "contenido": "prospecto: etapa.prospecto || { nombre: 'Cliente', telefono: '' },"
        },
        {
          "linea": 3181,
          "contenido": "prospecto: etapa.prospecto || { nombre: 'Cliente', telefono: '' },"
        }
      ]
    },
    {
      "archivo": "\\server\\services\\syncLegacyService.js",
      "referencias": 1,
      "detalles": [
        {
          "linea": 53,
          "contenido": "prospecto: legacy.prospecto,"
        }
      ]
    },
    {
      "archivo": "\\server\\tests\\controllers\\pedidoController.test.js",
      "referencias": 1,
      "detalles": [
        {
          "linea": 20,
          "contenido": "jest.mock('../../models/Prospecto', () => ({}));"
        }
      ]
    },
    {
      "archivo": "\\server\\tests\\listeners\\pedidoListener.test.js",
      "referencias": 8,
      "detalles": [
        {
          "linea": 10,
          "contenido": "jest.mock('../../models/Prospecto', () => ({"
        },
        {
          "linea": 27,
          "contenido": "const Prospecto = require('../../models/Prospecto');"
        },
        {
          "linea": 41,
          "contenido": "prospectoId: 'pros1',"
        },
        {
          "linea": 53,
          "contenido": "const mockProspecto = {"
        },
        {
          "linea": 63,
          "contenido": "prospecto: mockProspecto,"
        },
        {
          "linea": 90,
          "contenido": "Prospecto.findById.mockResolvedValue(mockProspecto);"
        },
        {
          "linea": 107,
          "contenido": "prospectoId: 'pros1',"
        },
        {
          "linea": 119,
          "contenido": "prospecto: 'pros1',"
        }
      ]
    },
    {
      "archivo": "\\server\\tests\\metric.test.js",
      "referencias": 3,
      "detalles": [
        {
          "linea": 28,
          "contenido": "endpoint: '/api/prospectos',"
        },
        {
          "linea": 35,
          "contenido": "expect(metric.metadata.endpoint).toBe('/api/prospectos');"
        },
        {
          "linea": 36,
          "contenido": "expect(metric.endpoint).toBe('/api/prospectos');"
        }
      ]
    },
    {
      "archivo": "\\server\\utils\\exportNormalizer.js",
      "referencias": 2,
      "detalles": [
        {
          "linea": 19,
          "contenido": "{ path: 'prospecto_original', select: 'nombre telefono email' },"
        },
        {
          "linea": 202,
          "contenido": "prospecto_original: proyecto.prospecto_original,"
        }
      ]
    }
  ],
  "totalReferencias": 990,
  "porTipo": {
    "models": [
      {
        "archivo": "\\server\\models\\Cotizacion.js",
        "referencias": 3,
        "detalles": [
          {
            "linea": 6,
            "contenido": "prospecto: {"
          },
          {
            "linea": 8,
            "contenido": "ref: 'Prospecto'"
          },
          {
            "linea": 229,
            "contenido": "cotizacionSchema.index({ prospecto: 1 });"
          }
        ]
      },
      {
        "archivo": "\\server\\models\\Etapa.js",
        "referencias": 2,
        "detalles": [
          {
            "linea": 47,
            "contenido": "prospectoId: {"
          },
          {
            "linea": 49,
            "contenido": "ref: 'Prospecto',"
          }
        ]
      },
      {
        "archivo": "\\server\\models\\Fabricacion.legacy.js",
        "referencias": 2,
        "detalles": [
          {
            "linea": 27,
            "contenido": "prospecto: {"
          },
          {
            "linea": 29,
            "contenido": "ref: 'Prospecto',"
          }
        ]
      },
      {
        "archivo": "\\server\\models\\KPI.js",
        "referencias": 10,
        "detalles": [
          {
            "linea": 21,
            "contenido": "prospectosNuevos: { type: Number, default: 0 },"
          },
          {
            "linea": 22,
            "contenido": "prospectosActivos: { type: Number, default: 0 },"
          },
          {
            "linea": 23,
            "contenido": "prospectosConvertidos: { type: Number, default: 0 },"
          },
          {
            "linea": 24,
            "contenido": "prospectosPerdidos: { type: Number, default: 0 },"
          },
          {
            "linea": 52,
            "contenido": "prospectoACotizacion: { type: Number, default: 0 },"
          },
          {
            "linea": 89,
            "contenido": "prospectosAsignados: { type: Number, default: 0 },"
          },
          {
            "linea": 177,
            "contenido": "prospectosNuevos: datosNormalizados.length,"
          },
          {
            "linea": 178,
            "contenido": "prospectosActivos: datosNormalizados.filter(p => !['completado', 'cancelado', 'entregado', 'instalado'].includes(p.estado)).length,"
          },
          {
            "linea": 179,
            "contenido": "prospectosConvertidos: datosNormalizados.filter(p => estadosCompletados.includes(p.estado)).length,"
          },
          {
            "linea": 180,
            "contenido": "prospectosPerdidos: datosNormalizados.filter(p => p.estado === 'cancelado').length,"
          }
        ]
      },
      {
        "archivo": "\\server\\models\\Pedido.js",
        "referencias": 3,
        "detalles": [
          {
            "linea": 12,
            "contenido": "prospecto: {"
          },
          {
            "linea": 14,
            "contenido": "ref: 'Prospecto',"
          },
          {
            "linea": 420,
            "contenido": "pedidoSchema.index({ prospecto: 1 });"
          }
        ]
      },
      {
        "archivo": "\\server\\models\\Postventa.js",
        "referencias": 1,
        "detalles": [
          {
            "linea": 17,
            "contenido": "ref: 'Prospecto',"
          }
        ]
      },
      {
        "archivo": "\\server\\models\\Prospecto.js",
        "referencias": 13,
        "detalles": [
          {
            "linea": 4,
            "contenido": "const prospectoSchema = new mongoose.Schema({"
          },
          {
            "linea": 190,
            "contenido": "prospectoSchema.index({ telefono: 1 });"
          },
          {
            "linea": 191,
            "contenido": "prospectoSchema.index({ email: 1 });"
          },
          {
            "linea": 192,
            "contenido": "prospectoSchema.index({ etapa: 1 });"
          },
          {
            "linea": 193,
            "contenido": "prospectoSchema.index({ vendedorAsignado: 1 });"
          },
          {
            "linea": 194,
            "contenido": "prospectoSchema.index({ fechaProximoSeguimiento: 1 });"
          },
          {
            "linea": 195,
            "contenido": "prospectoSchema.index({ archivado: 1 });"
          },
          {
            "linea": 196,
            "contenido": "prospectoSchema.index({ enPapelera: 1 });"
          },
          {
            "linea": 197,
            "contenido": "prospectoSchema.index({ createdAt: -1 });"
          },
          {
            "linea": 200,
            "contenido": "prospectoSchema.methods.calcularScore = function() {"
          },
          {
            "linea": 207,
            "contenido": "prospectoSchema.methods.necesitaSeguimiento = function() {"
          },
          {
            "linea": 213,
            "contenido": "prospectoSchema.plugin(mongoosePaginate);"
          },
          {
            "linea": 215,
            "contenido": "module.exports = mongoose.model('Prospecto', prospectoSchema);"
          }
        ]
      },
      {
        "archivo": "\\server\\models\\ProspectoNoConvertido.js",
        "referencias": 11,
        "detalles": [
          {
            "linea": 4,
            "contenido": "const prospectoNoConvertidoSchema = new mongoose.Schema({"
          },
          {
            "linea": 168,
            "contenido": "prospectoNoConvertidoSchema.index({ fechaPerdida: -1 });"
          },
          {
            "linea": 169,
            "contenido": "prospectoNoConvertidoSchema.index({ vendedorAsignado: 1, estadoRecuperacion: 1 });"
          },
          {
            "linea": 170,
            "contenido": "prospectoNoConvertidoSchema.index({ 'razonPerdida.tipo': 1 });"
          },
          {
            "linea": 171,
            "contenido": "prospectoNoConvertidoSchema.index({ 'alertas.proximoSeguimiento': 1, 'alertas.alertaActiva': 1 });"
          },
          {
            "linea": 174,
            "contenido": "prospectoNoConvertidoSchema.pre('save', function(next) {"
          },
          {
            "linea": 192,
            "contenido": "prospectoNoConvertidoSchema.methods.calcularScoreRecuperacion = function() {"
          },
          {
            "linea": 230,
            "contenido": "prospectoNoConvertidoSchema.statics.obtenerRecuperables = function(limite = 50) {"
          },
          {
            "linea": 243,
            "contenido": "prospectoNoConvertidoSchema.statics.analizarPerdidas = async function(fechaInicio, fechaFin) {"
          },
          {
            "linea": 271,
            "contenido": "prospectoNoConvertidoSchema.methods.programarSeguimiento = function(dias = 7) {"
          },
          {
            "linea": 281,
            "contenido": "module.exports = mongoose.model('ProspectoNoConvertido', prospectoNoConvertidoSchema);"
          }
        ]
      },
      {
        "archivo": "\\server\\models\\Proyecto.js",
        "referencias": 2,
        "detalles": [
          {
            "linea": 748,
            "contenido": "prospecto_original: {"
          },
          {
            "linea": 750,
            "contenido": "ref: 'Prospecto'"
          }
        ]
      },
      {
        "archivo": "\\server\\models\\ProyectoPedido.legacy.js",
        "referencias": 3,
        "detalles": [
          {
            "linea": 24,
            "contenido": "prospecto: {"
          },
          {
            "linea": 26,
            "contenido": "ref: 'Prospecto',"
          },
          {
            "linea": 761,
            "contenido": "proyectoPedidoSchema.index({ prospecto: 1 });"
          }
        ]
      },
      {
        "archivo": "\\server\\models\\Recordatorio.js",
        "referencias": 3,
        "detalles": [
          {
            "linea": 44,
            "contenido": "prospecto: {"
          },
          {
            "linea": 46,
            "contenido": "ref: 'Prospecto'"
          },
          {
            "linea": 151,
            "contenido": "recordatorioSchema.index({ prospecto: 1 });"
          }
        ]
      },
      {
        "archivo": "\\server\\models\\Usuario.js",
        "referencias": 2,
        "detalles": [
          {
            "linea": 44,
            "contenido": "enum: ['prospectos', 'cotizaciones', 'pedidos', 'fabricacion', 'instalaciones', 'postventa', 'reportes', 'usuarios', 'configuracion']"
          },
          {
            "linea": 83,
            "contenido": "prospectosAsignados: { type: Number, default: 0 },"
          }
        ]
      },
      {
        "archivo": "\\server\\models\\WhatsAppTracking.js",
        "referencias": 4,
        "detalles": [
          {
            "linea": 9,
            "contenido": "prospecto: {"
          },
          {
            "linea": 11,
            "contenido": "ref: 'Prospecto',"
          },
          {
            "linea": 51,
            "contenido": "etapa_prospecto: String,"
          },
          {
            "linea": 65,
            "contenido": "whatsAppTrackingSchema.index({ prospecto: 1, fecha_evento: -1 });"
          }
        ]
      }
    ],
    "routes": [
      {
        "archivo": "\\server\\routes\\backup.js",
        "referencias": 67,
        "detalles": [
          {
            "linea": 8,
            "contenido": "const Prospecto = require('../models/Prospecto');"
          },
          {
            "linea": 26,
            "contenido": "prospectos,"
          },
          {
            "linea": 31,
            "contenido": "Prospecto.find({}).lean(),"
          },
          {
            "linea": 45,
            "contenido": "prospectos: prospectos.length,"
          },
          {
            "linea": 51,
            "contenido": "prospectos,"
          },
          {
            "linea": 89,
            "contenido": "router.get('/export/prospectos', auth, verificarPermiso('prospectos', 'leer'), async (req, res) => {"
          },
          {
            "linea": 91,
            "contenido": "logger.info('Iniciando exportación de prospectos', {"
          },
          {
            "linea": 93,
            "contenido": "accion: 'exportacionProspectos',"
          },
          {
            "linea": 116,
            "contenido": "const prospectos = await Prospecto.find(filtros)"
          },
          {
            "linea": 123,
            "contenido": "exportType: 'prospectos_only',"
          },
          {
            "linea": 130,
            "contenido": "totalRecords: prospectos.length"
          },
          {
            "linea": 133,
            "contenido": "prospectos"
          },
          {
            "linea": 137,
            "contenido": "logger.info('Exportación de prospectos completada', {"
          },
          {
            "linea": 139,
            "contenido": "accion: 'exportacionProspectos',"
          },
          {
            "linea": 141,
            "contenido": "totalProspectos: prospectos.length"
          },
          {
            "linea": 144,
            "contenido": "const fileName = `prospectos_backup_${new Date().toISOString().split('T')[0]}_${Date.now()}.json`;"
          },
          {
            "linea": 152,
            "contenido": "logger.error('Error en exportación de prospectos', {"
          },
          {
            "linea": 154,
            "contenido": "accion: 'exportacionProspectos',"
          },
          {
            "linea": 168,
            "contenido": "router.get('/export/excel', auth, verificarPermiso('prospectos', 'leer'), async (req, res) => {"
          },
          {
            "linea": 172,
            "contenido": "logger.info('Iniciando exportación de prospectos a Excel', {"
          },
          {
            "linea": 186,
            "contenido": "const prospectos = await Prospecto.find(filtros)"
          },
          {
            "linea": 194,
            "contenido": "const worksheetMain = workbook.addWorksheet('Prospectos');"
          },
          {
            "linea": 215,
            "contenido": "prospectos.forEach(prospecto => {"
          },
          {
            "linea": 217,
            "contenido": "id: prospecto._id.toString(),"
          },
          {
            "linea": 218,
            "contenido": "nombre: prospecto.nombre,"
          },
          {
            "linea": 219,
            "contenido": "telefono: prospecto.telefono,"
          },
          {
            "linea": 220,
            "contenido": "email: prospecto.email || '',"
          },
          {
            "linea": 221,
            "contenido": "producto: prospecto.producto,"
          },
          {
            "linea": 222,
            "contenido": "etapa: prospecto.etapa,"
          },
          {
            "linea": 223,
            "contenido": "prioridad: prospecto.prioridad,"
          },
          {
            "linea": 224,
            "contenido": "fuente: prospecto.fuente,"
          },
          {
            "linea": 225,
            "contenido": "vendedor: prospecto.vendedorAsignado ?"
          },
          {
            "linea": 226,
            "contenido": "`${prospecto.vendedorAsignado.nombre} ${prospecto.vendedorAsignado.apellido}` : '',"
          },
          {
            "linea": 227,
            "contenido": "ciudad: prospecto.direccion?.ciudad || '',"
          },
          {
            "linea": 228,
            "contenido": "fechaCreacion: prospecto.createdAt,"
          },
          {
            "linea": 229,
            "contenido": "ultimoContacto: prospecto.fechaUltimoContacto || '',"
          },
          {
            "linea": 230,
            "contenido": "archivado: prospecto.archivado ? 'Sí' : 'No',"
          },
          {
            "linea": 231,
            "contenido": "observaciones: prospecto.descripcionNecesidad || ''"
          },
          {
            "linea": 240,
            "contenido": "total: prospectos.length,"
          },
          {
            "linea": 244,
            "contenido": "archivados: prospectos.filter(p => p.archivado).length"
          },
          {
            "linea": 247,
            "contenido": "prospectos.forEach(p => {"
          },
          {
            "linea": 258,
            "contenido": "worksheetStats.addRow(['Total Prospectos', stats.total]);"
          },
          {
            "linea": 274,
            "contenido": "const fileName = `sundeck_prospectos_${new Date().toISOString().split('T')[0]}.xlsx`;"
          },
          {
            "linea": 283,
            "contenido": "logger.error('Error en exportación Excel de prospectos', {"
          },
          {
            "linea": 321,
            "contenido": "if (backupData.data.prospectos && options.importProspectos !== false) {"
          },
          {
            "linea": 323,
            "contenido": "const prospectos = backupData.data.prospectos;"
          },
          {
            "linea": 327,
            "contenido": "for (const prospectoData of prospectos) {"
          },
          {
            "linea": 330,
            "contenido": "const existente = await Prospecto.findOne({ telefono: prospectoData.telefono });"
          },
          {
            "linea": 338,
            "contenido": "await Prospecto.findByIdAndUpdate(existente._id, prospectoData);"
          },
          {
            "linea": 342,
            "contenido": "await Prospecto.create(prospectoData);"
          },
          {
            "linea": 347,
            "contenido": "results.errors.push(`Error importando prospecto ${prospectoData.nombre}: ${error.message}`);"
          },
          {
            "linea": 351,
            "contenido": "results.imported.prospectos = importedCount;"
          },
          {
            "linea": 352,
            "contenido": "results.skipped.prospectos = skippedCount;"
          },
          {
            "linea": 354,
            "contenido": "results.errors.push(`Error general importando prospectos: ${error.message}`);"
          },
          {
            "linea": 414,
            "contenido": "totalProspectos,"
          },
          {
            "linea": 415,
            "contenido": "prospectosActivos,"
          },
          {
            "linea": 416,
            "contenido": "prospectosArchivados,"
          },
          {
            "linea": 417,
            "contenido": "prospectosPapelera,"
          },
          {
            "linea": 421,
            "contenido": "Prospecto.countDocuments({}),"
          },
          {
            "linea": 422,
            "contenido": "Prospecto.countDocuments({ activo: true, archivado: { $ne: true }, enPapelera: { $ne: true } }),"
          },
          {
            "linea": 423,
            "contenido": "Prospecto.countDocuments({ archivado: true }),"
          },
          {
            "linea": 424,
            "contenido": "Prospecto.countDocuments({ enPapelera: true }),"
          },
          {
            "linea": 431,
            "contenido": "prospectos: {"
          },
          {
            "linea": 432,
            "contenido": "total: totalProspectos,"
          },
          {
            "linea": 433,
            "contenido": "activos: prospectosActivos,"
          },
          {
            "linea": 434,
            "contenido": "archivados: prospectosArchivados,"
          },
          {
            "linea": 435,
            "contenido": "enPapelera: prospectosPapelera"
          }
        ]
      },
      {
        "archivo": "\\server\\routes\\cotizaciones.js",
        "referencias": 25,
        "detalles": [
          {
            "linea": 3,
            "contenido": "const Prospecto = require('../models/Prospecto');"
          },
          {
            "linea": 37,
            "contenido": "prospecto,"
          },
          {
            "linea": 45,
            "contenido": "if (prospecto) filtros.prospecto = prospecto;"
          },
          {
            "linea": 69,
            "contenido": "{ path: 'prospecto', select: 'nombre telefono email' },"
          },
          {
            "linea": 88,
            "contenido": "prospectoId,"
          },
          {
            "linea": 99,
            "contenido": "logger.debug('Datos extraídos desde-visita', { prospectoId, piezasCount: Array.isArray(piezas) ? piezas.length : 0, precioGeneral, totalM2, unidadMedida, origen });"
          },
          {
            "linea": 102,
            "contenido": "const prospecto = await Prospecto.findById(prospectoId);"
          },
          {
            "linea": 103,
            "contenido": "if (!prospecto) {"
          },
          {
            "linea": 104,
            "contenido": "logger.warn('Prospecto no encontrado', { prospectoId });"
          },
          {
            "linea": 105,
            "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
          },
          {
            "linea": 107,
            "contenido": "logger.debug('Prospecto encontrado', { prospectoId, nombre: prospecto.nombre });"
          },
          {
            "linea": 485,
            "contenido": "logger.debug('Creando nueva cotización', { numeroCotizacion, prospectoId });"
          },
          {
            "linea": 487,
            "contenido": "prospecto: prospectoId,"
          },
          {
            "linea": 516,
            "contenido": "{ path: 'prospecto', select: 'nombre telefono email' },"
          },
          {
            "linea": 521,
            "contenido": "prospecto.etapa = 'cotizacion';"
          },
          {
            "linea": 524,
            "contenido": "if (!prospecto.producto || prospecto.producto.trim() === '') {"
          },
          {
            "linea": 525,
            "contenido": "prospecto.producto = productos[0]?.nombre || 'Producto personalizado';"
          },
          {
            "linea": 528,
            "contenido": "await prospecto.save();"
          },
          {
            "linea": 535,
            "contenido": "logger.logError(error, { context: 'generarCotizacionDesdeVisita', prospectoId: req.body.prospectoId, userId: req.usuario?.id });"
          },
          {
            "linea": 555,
            "contenido": ".populate('prospecto')"
          },
          {
            "linea": 564,
            "contenido": "logger.debug('Cotización encontrada', { numero: cotizacion.numero, prospecto: cotizacion.prospecto?.nombre, productosCount: cotizacion.productos?.length || 0, total: cotizacion.total });"
          },
          {
            "linea": 895,
            "contenido": ".populate('prospecto')"
          },
          {
            "linea": 911,
            "contenido": "const nombreCliente = (cotizacion.prospecto?.nombre || 'Cliente').replace(/[^a-zA-Z0-9\\s]/g, '').replace(/\\s+/g, '-') || 'Cliente';"
          },
          {
            "linea": 950,
            "contenido": ".populate('prospecto')"
          },
          {
            "linea": 966,
            "contenido": "const nombreCliente = (cotizacion.prospecto?.nombre || 'Cliente').replace(/[^a-zA-Z0-9\\s]/g, '').replace(/\\s+/g, '-') || 'Cliente';"
          }
        ]
      },
      {
        "archivo": "\\server\\routes\\dashboard.js",
        "referencias": 28,
        "detalles": [
          {
            "linea": 2,
            "contenido": "const Prospecto = require('../models/Prospecto');"
          },
          {
            "linea": 26,
            "contenido": "Prospecto.countDocuments({ ...filtroUsuario, etapa: 'nuevo', activo: true }),"
          },
          {
            "linea": 27,
            "contenido": "Prospecto.countDocuments({ ...filtroUsuario, etapa: 'contactado', activo: true }),"
          },
          {
            "linea": 28,
            "contenido": "Prospecto.countDocuments({ ...filtroUsuario, etapa: 'cita_agendada', activo: true }),"
          },
          {
            "linea": 29,
            "contenido": "Prospecto.countDocuments({ ...filtroUsuario, etapa: 'cotizacion', activo: true }),"
          },
          {
            "linea": 30,
            "contenido": "Prospecto.countDocuments({ ...filtroUsuario, etapa: 'venta_cerrada', activo: true }),"
          },
          {
            "linea": 31,
            "contenido": "Prospecto.countDocuments({ ...filtroUsuario, etapa: 'pedido', activo: true }),"
          },
          {
            "linea": 34,
            "contenido": "Prospecto.countDocuments({ ...filtroUsuario, etapa: 'entregado', activo: true }),"
          },
          {
            "linea": 35,
            "contenido": "Prospecto.countDocuments({ ...filtroUsuario, etapa: 'postventa', activo: true })"
          },
          {
            "linea": 99,
            "contenido": "prospectosNuevos,"
          },
          {
            "linea": 101,
            "contenido": "ventasCerradasProspectos,"
          },
          {
            "linea": 103,
            "contenido": "montoVentasProspectos,"
          },
          {
            "linea": 106,
            "contenido": "Prospecto.countDocuments({"
          },
          {
            "linea": 118,
            "contenido": "Prospecto.countDocuments({"
          },
          {
            "linea": 124,
            "contenido": "Prospecto.countDocuments({"
          },
          {
            "linea": 138,
            "contenido": "Prospecto.aggregate(["
          },
          {
            "linea": 186,
            "contenido": "const montoVentasTotal = (montoVentasProspectos[0]?.total || 0) + (montoVentasPedidos[0]?.total || 0);"
          },
          {
            "linea": 189,
            "contenido": "const seguimientosPendientes = await Prospecto.find({"
          },
          {
            "linea": 200,
            "contenido": "const actividadReciente = await Prospecto.find({"
          },
          {
            "linea": 215,
            "contenido": "const citasHoy = await Prospecto.find({"
          },
          {
            "linea": 225,
            "contenido": "const totalProspectos = await Prospecto.countDocuments({"
          },
          {
            "linea": 231,
            "contenido": "const tasaConversion = totalProspectos > 0 ?"
          },
          {
            "linea": 238,
            "contenido": "prospectosNuevos,"
          },
          {
            "linea": 273,
            "contenido": "const metricas = await Prospecto.aggregate(["
          },
          {
            "linea": 284,
            "contenido": "totalProspectos: { $sum: 1 },"
          },
          {
            "linea": 314,
            "contenido": "totalProspectos: 1,"
          },
          {
            "linea": 319,
            "contenido": "{ $divide: ['$contactados', '$totalProspectos'] },"
          },
          {
            "linea": 346,
            "contenido": "const embudo = await Prospecto.aggregate(["
          }
        ]
      },
      {
        "archivo": "\\server\\routes\\etapas.js",
        "referencias": 61,
        "detalles": [
          {
            "linea": 5,
            "contenido": "const Prospecto = require('../models/Prospecto');"
          },
          {
            "linea": 14,
            "contenido": "router.get('/', auth, verificarPermiso('prospectos', 'leer'), async (req, res) => {"
          },
          {
            "linea": 16,
            "contenido": "const { prospectoId } = req.query;"
          },
          {
            "linea": 18,
            "contenido": "if (!prospectoId || !mongoose.Types.ObjectId.isValid(prospectoId)) {"
          },
          {
            "linea": 19,
            "contenido": "return res.status(400).json({ message: 'prospectoId inválido o requerido' });"
          },
          {
            "linea": 23,
            "contenido": "const prospecto = await Prospecto.findById(prospectoId);"
          },
          {
            "linea": 24,
            "contenido": "if (!prospecto) {"
          },
          {
            "linea": 25,
            "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
          },
          {
            "linea": 29,
            "contenido": "const etapas = await Etapa.find({ prospectoId })"
          },
          {
            "linea": 42,
            "contenido": "prospectoId: req.query.prospectoId,"
          },
          {
            "linea": 49,
            "contenido": "router.post('/', auth, verificarPermiso('prospectos', 'actualizar'), async (req, res) => {"
          },
          {
            "linea": 52,
            "contenido": "prospectoId,"
          },
          {
            "linea": 63,
            "contenido": "if (!prospectoId || !mongoose.Types.ObjectId.isValid(prospectoId)) {"
          },
          {
            "linea": 64,
            "contenido": "return res.status(400).json({ message: 'prospectoId inválido' });"
          },
          {
            "linea": 71,
            "contenido": "const prospecto = await Prospecto.findById(prospectoId);"
          },
          {
            "linea": 72,
            "contenido": "if (!prospecto) {"
          },
          {
            "linea": 73,
            "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
          },
          {
            "linea": 132,
            "contenido": "prospectoId,"
          },
          {
            "linea": 146,
            "contenido": "prospecto.fechaUltimoContacto = new Date();"
          },
          {
            "linea": 147,
            "contenido": "await prospecto.save();"
          },
          {
            "linea": 152,
            "contenido": "const proyecto = await Proyecto.findOne({ prospecto_original: prospectoId });"
          },
          {
            "linea": 155,
            "contenido": "await ProyectoSyncMiddleware.sincronizarMedidasDesdeEtapas(proyecto._id, prospectoId);"
          },
          {
            "linea": 158,
            "contenido": "prospectoId,"
          },
          {
            "linea": 165,
            "contenido": "prospectoId,"
          },
          {
            "linea": 178,
            "contenido": "prospectoId: req.body.prospectoId,"
          },
          {
            "linea": 213,
            "contenido": "prospectoId: req.query.prospectoId"
          },
          {
            "linea": 218,
            "contenido": "prospectoId,"
          },
          {
            "linea": 227,
            "contenido": "prospectoId,"
          },
          {
            "linea": 233,
            "contenido": "await generarPDFLevantamiento(req, res, { prospectoId, piezas, precioGeneral: Number(precioGeneral), totalM2: Number(totalM2), unidadMedida });"
          },
          {
            "linea": 237,
            "contenido": "prospectoId: req.query.prospectoId"
          },
          {
            "linea": 244,
            "contenido": "router.get('/pdf-viewer/:prospectoId', authSimple, async (req, res) => {"
          },
          {
            "linea": 246,
            "contenido": "prospectoId: req.params.prospectoId"
          },
          {
            "linea": 250,
            "contenido": "const { prospectoId } = req.params;"
          },
          {
            "linea": 260,
            "contenido": "prospectoId,"
          },
          {
            "linea": 272,
            "contenido": "await generarPDFLevantamiento(req, res, { prospectoId, piezas, precioGeneral: Number(precioGeneral), totalM2: Number(totalM2), unidadMedida });"
          },
          {
            "linea": 276,
            "contenido": "prospectoId: req.params.prospectoId"
          },
          {
            "linea": 285,
            "contenido": "prospectoId: req.body.prospectoId,"
          },
          {
            "linea": 293,
            "contenido": "prospectoId,"
          },
          {
            "linea": 301,
            "contenido": "prospectoId,"
          },
          {
            "linea": 305,
            "contenido": "await generarPDFLevantamiento(req, res, { prospectoId, piezas, precioGeneral, totalM2, unidadMedida });"
          },
          {
            "linea": 309,
            "contenido": "prospectoId: req.body.prospectoId,"
          },
          {
            "linea": 324,
            "contenido": "}, auth, verificarPermiso('prospectos', 'leer'), async (req, res) => {"
          },
          {
            "linea": 327,
            "contenido": "prospectoId: req.body.prospectoId,"
          },
          {
            "linea": 335,
            "contenido": "prospectoId,"
          },
          {
            "linea": 371,
            "contenido": "prospectoId,"
          },
          {
            "linea": 376,
            "contenido": "const nombreCliente = (prospecto.nombre || 'Cliente').replace(/[^a-zA-Z0-9\\s]/g, '').replace(/\\s+/g, '-') || 'Cliente';"
          },
          {
            "linea": 387,
            "contenido": "prospectoId,"
          },
          {
            "linea": 401,
            "contenido": "prospectoId: req.body.prospectoId,"
          },
          {
            "linea": 422,
            "contenido": "router.post('/levantamiento-excel', auth, verificarPermiso('prospectos', 'leer'), async (req, res) => {"
          },
          {
            "linea": 425,
            "contenido": "prospectoId,"
          },
          {
            "linea": 433,
            "contenido": "if (!prospectoId || !mongoose.Types.ObjectId.isValid(prospectoId)) {"
          },
          {
            "linea": 434,
            "contenido": "return res.status(400).json({ message: 'prospectoId inválido' });"
          },
          {
            "linea": 437,
            "contenido": "const prospecto = await Prospecto.findById(prospectoId);"
          },
          {
            "linea": 438,
            "contenido": "if (!prospecto) {"
          },
          {
            "linea": 439,
            "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
          },
          {
            "linea": 445,
            "contenido": "nombre: prospecto.nombre,"
          },
          {
            "linea": 446,
            "contenido": "telefono: prospecto.telefono,"
          },
          {
            "linea": 447,
            "contenido": "email: prospecto.email,"
          },
          {
            "linea": 448,
            "contenido": "direccion: prospecto.direccion"
          },
          {
            "linea": 458,
            "contenido": "const nombreCliente = (prospecto.nombre || 'Cliente').replace(/[^a-zA-Z0-9\\s]/g, '').replace(/\\s+/g, '-') || 'Cliente';"
          },
          {
            "linea": 478,
            "contenido": "prospectoId: req.body.prospectoId,"
          }
        ]
      },
      {
        "archivo": "\\server\\routes\\instalaciones.js",
        "referencias": 7,
        "detalles": [
          {
            "linea": 232,
            "contenido": ".populate('prospecto', 'nombre telefono direccion');"
          },
          {
            "linea": 288,
            "contenido": "nombre: fabricacion.prospecto.nombre,"
          },
          {
            "linea": 289,
            "contenido": "telefono: fabricacion.prospecto.telefono,"
          },
          {
            "linea": 290,
            "contenido": "direccion: fabricacion.prospecto.direccion"
          },
          {
            "linea": 308,
            "contenido": "nombre: fabricacion.prospecto.nombre,"
          },
          {
            "linea": 309,
            "contenido": "telefono: fabricacion.prospecto.telefono"
          },
          {
            "linea": 313,
            "contenido": "direccion: fabricacion.prospecto.direccion || {},"
          }
        ]
      },
      {
        "archivo": "\\server\\routes\\kpis.js",
        "referencias": 45,
        "detalles": [
          {
            "linea": 4,
            "contenido": "const ProspectoNoConvertido = require('../models/ProspectoNoConvertido');"
          },
          {
            "linea": 32,
            "contenido": "const razonesPerdidasQuery = await ProspectoNoConvertido.analizarPerdidas(fechaInicio, fechaFin);"
          },
          {
            "linea": 35,
            "contenido": "const prospectosRecuperables = await ProspectoNoConvertido.obtenerRecuperables(10);"
          },
          {
            "linea": 41,
            "contenido": "prospectosAbandonados: await ProspectoNoConvertido.countDocuments({"
          },
          {
            "linea": 54,
            "contenido": "prospectosRecuperables,"
          },
          {
            "linea": 57,
            "contenido": "totalProspectos: kpiActual.metricas.prospectosNuevos,"
          },
          {
            "linea": 61,
            "contenido": "prospectosEnRiesgo: prospectosRecuperables.length"
          },
          {
            "linea": 103,
            "contenido": "prospectos: conversionPorEtapa.reduce((sum, etapa) => sum + etapa.cantidad, 0),"
          },
          {
            "linea": 154,
            "contenido": "const razonesAnalisis = await ProspectoNoConvertido.analizarPerdidas("
          },
          {
            "linea": 160,
            "contenido": "const perdidasPorEtapa = await ProspectoNoConvertido.aggregate(["
          },
          {
            "linea": 174,
            "contenido": "const perdidasPorVendedor = await ProspectoNoConvertido.aggregate(["
          },
          {
            "linea": 195,
            "contenido": "const tendenciaPerdidas = await ProspectoNoConvertido.aggregate(["
          },
          {
            "linea": 249,
            "contenido": "const prospectosRecuperables = await ProspectoNoConvertido.find(filtro)"
          },
          {
            "linea": 258,
            "contenido": "alta: prospectosRecuperables.filter(p => p.scoreRecuperacion >= 70),"
          },
          {
            "linea": 259,
            "contenido": "media: prospectosRecuperables.filter(p => p.scoreRecuperacion >= 50 && p.scoreRecuperacion < 70),"
          },
          {
            "linea": 260,
            "contenido": "baja: prospectosRecuperables.filter(p => p.scoreRecuperacion < 50)"
          },
          {
            "linea": 264,
            "contenido": "const proximosSeguimientos = await ProspectoNoConvertido.find({"
          },
          {
            "linea": 276,
            "contenido": "prospectosRecuperables,"
          },
          {
            "linea": 278,
            "contenido": "alta: { cantidad: porPrioridad.alta.length, prospectos: porPrioridad.alta },"
          },
          {
            "linea": 279,
            "contenido": "media: { cantidad: porPrioridad.media.length, prospectos: porPrioridad.media },"
          },
          {
            "linea": 280,
            "contenido": "baja: { cantidad: porPrioridad.baja.length, prospectos: porPrioridad.baja }"
          },
          {
            "linea": 284,
            "contenido": "totalRecuperables: prospectosRecuperables.length,"
          },
          {
            "linea": 285,
            "contenido": "montoTotalRecuperable: prospectosRecuperables.reduce((sum, p) => sum + (p.montoEstimado || 0), 0),"
          },
          {
            "linea": 286,
            "contenido": "scorePromedio: prospectosRecuperables.length > 0"
          },
          {
            "linea": 287,
            "contenido": "? prospectosRecuperables.reduce((sum, p) => sum + p.scoreRecuperacion, 0) / prospectosRecuperables.length"
          },
          {
            "linea": 292,
            "contenido": "console.error('Error obteniendo prospectos recuperables:', error);"
          },
          {
            "linea": 293,
            "contenido": "res.status(500).json({ message: 'Error obteniendo prospectos recuperables', error: error.message });"
          },
          {
            "linea": 332,
            "contenido": "const prospectoNoConvertido = new ProspectoNoConvertido({"
          },
          {
            "linea": 352,
            "contenido": "await prospectoNoConvertido.save();"
          },
          {
            "linea": 366,
            "contenido": "message: 'Prospecto registrado como perdido',"
          },
          {
            "linea": 367,
            "contenido": "prospectoNoConvertido"
          },
          {
            "linea": 370,
            "contenido": "console.error('Error registrando prospecto perdido:', error);"
          },
          {
            "linea": 371,
            "contenido": "res.status(500).json({ message: 'Error registrando prospecto perdido', error: error.message });"
          },
          {
            "linea": 381,
            "contenido": "const prospecto = await ProspectoNoConvertido.findById(id);"
          },
          {
            "linea": 382,
            "contenido": "if (!prospecto) {"
          },
          {
            "linea": 383,
            "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
          },
          {
            "linea": 387,
            "contenido": "prospecto.intentosRecuperacion.push({"
          },
          {
            "linea": 397,
            "contenido": "prospecto.estadoRecuperacion = 'recuperado';"
          },
          {
            "linea": 398,
            "contenido": "prospecto.alertas.alertaActiva = false;"
          },
          {
            "linea": 400,
            "contenido": "prospecto.estadoRecuperacion = 'en_seguimiento';"
          },
          {
            "linea": 402,
            "contenido": "prospecto.alertas.proximoSeguimiento = new Date(proximoSeguimiento);"
          },
          {
            "linea": 405,
            "contenido": "prospecto.estadoRecuperacion = 'perdido_definitivo';"
          },
          {
            "linea": 406,
            "contenido": "prospecto.alertas.alertaActiva = false;"
          },
          {
            "linea": 409,
            "contenido": "await prospecto.save();"
          },
          {
            "linea": 413,
            "contenido": "prospecto"
          }
        ]
      },
      {
        "archivo": "\\server\\routes\\pedidos.js",
        "referencias": 40,
        "detalles": [
          {
            "linea": 4,
            "contenido": "const Prospecto = require('../models/Prospecto');"
          },
          {
            "linea": 28,
            "contenido": ".populate('prospecto', 'nombre telefono')"
          },
          {
            "linea": 59,
            "contenido": "const cotizacion = await Cotizacion.findById(cotizacionId).populate('prospecto');"
          },
          {
            "linea": 85,
            "contenido": "prospecto: cotizacion.prospecto._id,"
          },
          {
            "linea": 164,
            "contenido": "calle: cotizacion.prospecto.direccion || '',"
          },
          {
            "linea": 168,
            "contenido": "nombre: cotizacion.prospecto.nombre,"
          },
          {
            "linea": 169,
            "contenido": "telefono: cotizacion.prospecto.telefono"
          },
          {
            "linea": 181,
            "contenido": "{ path: 'prospecto', select: 'nombre telefono email' },"
          },
          {
            "linea": 191,
            "contenido": "await Prospecto.findByIdAndUpdate(cotizacion.prospecto._id, {"
          },
          {
            "linea": 219,
            "contenido": "prospectoId: nuevoPedido.prospecto?._id,"
          },
          {
            "linea": 250,
            "contenido": "const pedido = await Pedido.findById(id).populate('prospecto');"
          },
          {
            "linea": 306,
            "contenido": "let nuevaEtapaProspecto = pedido.prospecto.etapa;"
          },
          {
            "linea": 307,
            "contenido": "if (estado === 'terminado') nuevaEtapaProspecto = 'fabricacion';"
          },
          {
            "linea": 308,
            "contenido": "if (estado === 'instalado') nuevaEtapaProspecto = 'entregado';"
          },
          {
            "linea": 310,
            "contenido": "await Prospecto.findByIdAndUpdate(pedido.prospecto._id, {"
          },
          {
            "linea": 311,
            "contenido": "etapa: nuevaEtapaProspecto,"
          },
          {
            "linea": 334,
            "contenido": "{ path: 'prospecto', select: 'nombre telefono' },"
          },
          {
            "linea": 358,
            "contenido": "const pedido = await Pedido.findById(id).populate('prospecto');"
          },
          {
            "linea": 384,
            "contenido": "await Prospecto.findByIdAndUpdate(pedido.prospecto._id, {"
          },
          {
            "linea": 406,
            "contenido": "{ path: 'prospecto', select: 'nombre telefono' },"
          },
          {
            "linea": 428,
            "contenido": ".populate('prospecto')"
          },
          {
            "linea": 468,
            "contenido": "prospectoId,"
          },
          {
            "linea": 480,
            "contenido": "if (!prospectoId) {"
          },
          {
            "linea": 481,
            "contenido": "return res.status(400).json({ message: 'ProspectoId es requerido' });"
          },
          {
            "linea": 493,
            "contenido": "prospectoId,"
          },
          {
            "linea": 503,
            "contenido": "prospectoId,"
          },
          {
            "linea": 518,
            "contenido": "prospectoId"
          },
          {
            "linea": 522,
            "contenido": "const prospecto = await Prospecto.findById(prospectoId);"
          },
          {
            "linea": 523,
            "contenido": "if (!prospecto) {"
          },
          {
            "linea": 524,
            "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
          },
          {
            "linea": 529,
            "contenido": "prospectoId,"
          },
          {
            "linea": 551,
            "contenido": "prospecto: prospecto._id,"
          },
          {
            "linea": 568,
            "contenido": "prospecto: prospecto._id,"
          },
          {
            "linea": 607,
            "contenido": "direccion: prospecto.direccion || '',"
          },
          {
            "linea": 608,
            "contenido": "contacto: prospecto.telefono || ''"
          },
          {
            "linea": 642,
            "contenido": "prospecto.etapa = 'pedido';"
          },
          {
            "linea": 643,
            "contenido": "prospecto.fechaUltimoContacto = new Date();"
          },
          {
            "linea": 644,
            "contenido": "await prospecto.save();"
          },
          {
            "linea": 648,
            "contenido": ".populate('prospecto', 'nombre telefono email')"
          },
          {
            "linea": 657,
            "contenido": "prospectoId: prospecto._id"
          }
        ]
      },
      {
        "archivo": "\\server\\routes\\plantillasWhatsApp.js",
        "referencias": 7,
        "detalles": [
          {
            "linea": 354,
            "contenido": "prospecto: datos.prospecto_id,"
          },
          {
            "linea": 361,
            "contenido": "etapa_prospecto: datos.etapa_prospecto"
          },
          {
            "linea": 375,
            "contenido": "prospectoId: datos?.prospecto_id || null"
          },
          {
            "linea": 405,
            "contenido": "const { plantilla_id, prospecto_id, evento, rating, notas, mensaje_generado } = req.body;"
          },
          {
            "linea": 412,
            "contenido": "prospectoId: prospecto_id,"
          },
          {
            "linea": 425,
            "contenido": "prospecto: prospecto_id,"
          },
          {
            "linea": 474,
            "contenido": "prospectoId: prospecto_id,"
          }
        ]
      },
      {
        "archivo": "\\server\\routes\\produccion.js",
        "referencias": 9,
        "detalles": [
          {
            "linea": 28,
            "contenido": ".populate('prospecto', 'nombre telefono')"
          },
          {
            "linea": 58,
            "contenido": ".populate('prospecto', 'nombre telefono direccion');"
          },
          {
            "linea": 80,
            "contenido": "prospectoId: pedido.prospecto._id,"
          },
          {
            "linea": 92,
            "contenido": "prospecto: pedido.prospecto._id,"
          },
          {
            "linea": 98,
            "contenido": "nombre: pedido.prospecto.nombre,"
          },
          {
            "linea": 99,
            "contenido": "telefono: pedido.prospecto.telefono,"
          },
          {
            "linea": 100,
            "contenido": "direccion: pedido.prospecto.direccion || ''"
          },
          {
            "linea": 154,
            "contenido": ".populate('prospecto', 'nombre telefono')"
          },
          {
            "linea": 238,
            "contenido": ".populate('prospecto', 'nombre')"
          }
        ]
      },
      {
        "archivo": "\\server\\routes\\prospectos.js",
        "referencias": 230,
        "detalles": [
          {
            "linea": 5,
            "contenido": "const Prospecto = require('../models/Prospecto');"
          },
          {
            "linea": 17,
            "contenido": "const prospecto = await Prospecto.findById(req.params.id);"
          },
          {
            "linea": 18,
            "contenido": "if (!prospecto) {"
          },
          {
            "linea": 19,
            "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
          },
          {
            "linea": 23,
            "contenido": "evidenciasReagendamiento: prospecto.evidenciasReagendamiento || [],"
          },
          {
            "linea": 24,
            "contenido": "comentariosConArchivos: prospecto.notas.filter(nota => nota.archivos && nota.archivos.length > 0)"
          },
          {
            "linea": 27,
            "contenido": "logger.error('Error obteniendo evidencias de prospecto', {"
          },
          {
            "linea": 28,
            "contenido": "ruta: 'prospectosRoutes',"
          },
          {
            "linea": 30,
            "contenido": "prospectoId: req.params.id,"
          },
          {
            "linea": 81,
            "contenido": "router.get('/', auth, verificarPermiso('prospectos', 'leer'), async (req, res) => {"
          },
          {
            "linea": 144,
            "contenido": "const prospectos = await Prospecto.paginate(filtros, opciones);"
          },
          {
            "linea": 146,
            "contenido": "res.json(prospectos);"
          },
          {
            "linea": 148,
            "contenido": "logger.error('Error obteniendo prospectos', {"
          },
          {
            "linea": 149,
            "contenido": "ruta: 'prospectosRoutes',"
          },
          {
            "linea": 150,
            "contenido": "accion: 'listarProspectos',"
          },
          {
            "linea": 161,
            "contenido": "router.get('/:id', auth, verificarPermiso('prospectos', 'leer'), async (req, res) => {"
          },
          {
            "linea": 163,
            "contenido": "const prospecto = await Prospecto.findById(req.params.id)"
          },
          {
            "linea": 168,
            "contenido": "if (!prospecto) {"
          },
          {
            "linea": 169,
            "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
          },
          {
            "linea": 174,
            "contenido": "prospecto.vendedorAsignado?.toString() !== req.usuario._id.toString()) {"
          },
          {
            "linea": 175,
            "contenido": "return res.status(403).json({ message: 'No tienes acceso a este prospecto' });"
          },
          {
            "linea": 178,
            "contenido": "res.json(prospecto);"
          },
          {
            "linea": 180,
            "contenido": "logger.error('Error obteniendo prospecto por ID', {"
          },
          {
            "linea": 181,
            "contenido": "ruta: 'prospectosRoutes',"
          },
          {
            "linea": 182,
            "contenido": "accion: 'obtenerProspecto',"
          },
          {
            "linea": 183,
            "contenido": "prospectoId: req.params.id,"
          },
          {
            "linea": 193,
            "contenido": "router.get('/:id/comentarios', auth, verificarPermiso('prospectos', 'leer'), async (req, res) => {"
          },
          {
            "linea": 195,
            "contenido": "const prospecto = await Prospecto.findById(req.params.id)"
          },
          {
            "linea": 197,
            "contenido": "if (!prospecto) {"
          },
          {
            "linea": 198,
            "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
          },
          {
            "linea": 201,
            "contenido": "const comentarios = (prospecto.notas || []).sort((a, b) => new Date(b.fecha) - new Date(a.fecha));"
          },
          {
            "linea": 204,
            "contenido": "logger.error('Error listando comentarios de prospecto', {"
          },
          {
            "linea": 205,
            "contenido": "ruta: 'prospectosRoutes',"
          },
          {
            "linea": 207,
            "contenido": "prospectoId: req.params.id,"
          },
          {
            "linea": 217,
            "contenido": "router.post('/:id/comentarios', auth, verificarPermiso('prospectos', 'actualizar'), async (req, res) => {"
          },
          {
            "linea": 221,
            "contenido": "const prospecto = await Prospecto.findById(req.params.id);"
          },
          {
            "linea": 222,
            "contenido": "if (!prospecto) {"
          },
          {
            "linea": 223,
            "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
          },
          {
            "linea": 239,
            "contenido": "ruta: 'prospectosRoutes',"
          },
          {
            "linea": 241,
            "contenido": "prospectoId: req.params.id,"
          },
          {
            "linea": 249,
            "contenido": "prospecto.notas.push({"
          },
          {
            "linea": 257,
            "contenido": "prospecto.fechaUltimoContacto = new Date();"
          },
          {
            "linea": 258,
            "contenido": "await prospecto.save();"
          },
          {
            "linea": 259,
            "contenido": "await prospecto.populate('notas.usuario', 'nombre apellido');"
          },
          {
            "linea": 263,
            "contenido": "comentario: prospecto.notas[prospecto.notas.length - 1]"
          },
          {
            "linea": 266,
            "contenido": "logger.error('Error agregando comentario a prospecto', {"
          },
          {
            "linea": 267,
            "contenido": "ruta: 'prospectosRoutes',"
          },
          {
            "linea": 269,
            "contenido": "prospectoId: req.params.id,"
          },
          {
            "linea": 279,
            "contenido": "router.get('/:id/etapas', auth, verificarPermiso('prospectos', 'leer'), async (req, res) => {"
          },
          {
            "linea": 281,
            "contenido": "const prospecto = await Prospecto.findById(req.params.id)"
          },
          {
            "linea": 283,
            "contenido": "if (!prospecto) {"
          },
          {
            "linea": 284,
            "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
          },
          {
            "linea": 286,
            "contenido": "const etapas = (prospecto.etapas || []).sort((a, b) => new Date(a.fechaHora) - new Date(b.fechaHora));"
          },
          {
            "linea": 289,
            "contenido": "logger.error('Error listando etapas del prospecto', {"
          },
          {
            "linea": 290,
            "contenido": "ruta: 'prospectosRoutes',"
          },
          {
            "linea": 292,
            "contenido": "prospectoId: req.params.id,"
          },
          {
            "linea": 302,
            "contenido": "router.post('/:id/etapas', auth, verificarPermiso('prospectos', 'actualizar'), async (req, res) => {"
          },
          {
            "linea": 306,
            "contenido": "const prospecto = await Prospecto.findById(req.params.id);"
          },
          {
            "linea": 307,
            "contenido": "if (!prospecto) {"
          },
          {
            "linea": 308,
            "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
          },
          {
            "linea": 319,
            "contenido": "prospecto.etapas.push(etapa);"
          },
          {
            "linea": 320,
            "contenido": "await prospecto.save();"
          },
          {
            "linea": 321,
            "contenido": "await prospecto.populate('etapas.usuario', 'nombre apellido');"
          },
          {
            "linea": 325,
            "contenido": "etapa: prospecto.etapas[prospecto.etapas.length - 1]"
          },
          {
            "linea": 328,
            "contenido": "logger.error('Error agregando etapa al prospecto', {"
          },
          {
            "linea": 329,
            "contenido": "ruta: 'prospectosRoutes',"
          },
          {
            "linea": 331,
            "contenido": "prospectoId: req.params.id,"
          },
          {
            "linea": 341,
            "contenido": "router.post('/', auth, verificarPermiso('prospectos', 'crear'), async (req, res) => {"
          },
          {
            "linea": 361,
            "contenido": "const nuevoProspecto = new Prospecto({"
          },
          {
            "linea": 381,
            "contenido": "await nuevoProspecto.save();"
          },
          {
            "linea": 382,
            "contenido": "await nuevoProspecto.populate('vendedorAsignado', 'nombre apellido');"
          },
          {
            "linea": 386,
            "contenido": "await ProyectoSyncMiddleware.sincronizarProspecto(nuevoProspecto, 'create');"
          },
          {
            "linea": 387,
            "contenido": "logger.info('Proyecto sincronizado automáticamente tras crear prospecto', {"
          },
          {
            "linea": 388,
            "contenido": "ruta: 'prospectosRoutes',"
          },
          {
            "linea": 389,
            "contenido": "accion: 'crearProspecto',"
          },
          {
            "linea": 390,
            "contenido": "prospectoId: nuevoProspecto._id,"
          },
          {
            "linea": 394,
            "contenido": "logger.warn('Error sincronizando proyecto tras crear prospecto', {"
          },
          {
            "linea": 395,
            "contenido": "ruta: 'prospectosRoutes',"
          },
          {
            "linea": 396,
            "contenido": "accion: 'crearProspecto',"
          },
          {
            "linea": 397,
            "contenido": "prospectoId: nuevoProspecto._id,"
          },
          {
            "linea": 406,
            "contenido": "message: 'Prospecto creado exitosamente',"
          },
          {
            "linea": 407,
            "contenido": "prospecto: nuevoProspecto"
          },
          {
            "linea": 410,
            "contenido": "logger.error('Error creando prospecto', {"
          },
          {
            "linea": 411,
            "contenido": "ruta: 'prospectosRoutes',"
          },
          {
            "linea": 412,
            "contenido": "accion: 'crearProspecto',"
          },
          {
            "linea": 423,
            "contenido": "router.put('/:id', auth, verificarPermiso('prospectos', 'actualizar'), upload.array('evidencias', 10), async (req, res) => {"
          },
          {
            "linea": 425,
            "contenido": "const prospecto = await Prospecto.findById(req.params.id);"
          },
          {
            "linea": 427,
            "contenido": "if (!prospecto) {"
          },
          {
            "linea": 428,
            "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
          },
          {
            "linea": 433,
            "contenido": "prospecto.vendedorAsignado?.toString() !== req.usuario._id.toString()) {"
          },
          {
            "linea": 434,
            "contenido": "return res.status(403).json({ message: 'No tienes acceso a este prospecto' });"
          },
          {
            "linea": 447,
            "contenido": "prospecto[campo] = req.body[campo];"
          },
          {
            "linea": 453,
            "contenido": "prospecto.fechaArchivado = null;"
          },
          {
            "linea": 467,
            "contenido": "if (!prospecto.evidenciasReagendamiento) {"
          },
          {
            "linea": 468,
            "contenido": "prospecto.evidenciasReagendamiento = [];"
          },
          {
            "linea": 470,
            "contenido": "prospecto.evidenciasReagendamiento.push(...evidencias);"
          },
          {
            "linea": 474,
            "contenido": "if (req.body.etapa && req.body.etapa !== prospecto.etapa) {"
          },
          {
            "linea": 475,
            "contenido": "prospecto.fechaUltimoContacto = new Date();"
          },
          {
            "linea": 480,
            "contenido": "prospecto.fechaUltimoContacto = new Date();"
          },
          {
            "linea": 483,
            "contenido": "await prospecto.save();"
          },
          {
            "linea": 484,
            "contenido": "await prospecto.populate('vendedorAsignado', 'nombre apellido');"
          },
          {
            "linea": 488,
            "contenido": "await ProyectoSyncMiddleware.sincronizarProspecto(prospecto, 'update');"
          },
          {
            "linea": 489,
            "contenido": "logger.info('Proyecto sincronizado automáticamente tras actualizar prospecto', {"
          },
          {
            "linea": 490,
            "contenido": "ruta: 'prospectosRoutes',"
          },
          {
            "linea": 491,
            "contenido": "accion: 'actualizarProspecto',"
          },
          {
            "linea": 492,
            "contenido": "prospectoId: prospecto._id,"
          },
          {
            "linea": 496,
            "contenido": "logger.warn('Error sincronizando proyecto tras actualizar prospecto', {"
          },
          {
            "linea": 497,
            "contenido": "ruta: 'prospectosRoutes',"
          },
          {
            "linea": 498,
            "contenido": "accion: 'actualizarProspecto',"
          },
          {
            "linea": 499,
            "contenido": "prospectoId: prospecto._id,"
          },
          {
            "linea": 508,
            "contenido": "message: 'Prospecto actualizado exitosamente',"
          },
          {
            "linea": 509,
            "contenido": "prospecto"
          },
          {
            "linea": 512,
            "contenido": "logger.error('Error actualizando prospecto', {"
          },
          {
            "linea": 513,
            "contenido": "ruta: 'prospectosRoutes',"
          },
          {
            "linea": 514,
            "contenido": "accion: 'actualizarProspecto',"
          },
          {
            "linea": 515,
            "contenido": "prospectoId: req.params.id,"
          },
          {
            "linea": 526,
            "contenido": "router.post('/:id/notas', auth, verificarPermiso('prospectos', 'actualizar'), async (req, res) => {"
          },
          {
            "linea": 530,
            "contenido": "const prospecto = await Prospecto.findById(req.params.id);"
          },
          {
            "linea": 531,
            "contenido": "if (!prospecto) {"
          },
          {
            "linea": 532,
            "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
          },
          {
            "linea": 535,
            "contenido": "prospecto.notas.push({"
          },
          {
            "linea": 541,
            "contenido": "prospecto.fechaUltimoContacto = new Date();"
          },
          {
            "linea": 542,
            "contenido": "await prospecto.save();"
          },
          {
            "linea": 543,
            "contenido": "await prospecto.populate('notas.usuario', 'nombre apellido');"
          },
          {
            "linea": 547,
            "contenido": "nota: prospecto.notas[prospecto.notas.length - 1]"
          },
          {
            "linea": 550,
            "contenido": "logger.error('Error agregando nota al prospecto', {"
          },
          {
            "linea": 551,
            "contenido": "ruta: 'prospectosRoutes',"
          },
          {
            "linea": 553,
            "contenido": "prospectoId: req.params.id,"
          },
          {
            "linea": 563,
            "contenido": "router.put('/:id/etapa', auth, verificarPermiso('prospectos', 'actualizar'), async (req, res) => {"
          },
          {
            "linea": 567,
            "contenido": "const prospecto = await Prospecto.findById(req.params.id);"
          },
          {
            "linea": 568,
            "contenido": "if (!prospecto) {"
          },
          {
            "linea": 569,
            "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
          },
          {
            "linea": 572,
            "contenido": "const etapaAnterior = prospecto.etapa;"
          },
          {
            "linea": 573,
            "contenido": "prospecto.etapa = etapa;"
          },
          {
            "linea": 574,
            "contenido": "prospecto.fechaUltimoContacto = new Date();"
          },
          {
            "linea": 577,
            "contenido": "prospecto.notas.push({"
          },
          {
            "linea": 583,
            "contenido": "await prospecto.save();"
          },
          {
            "linea": 587,
            "contenido": "prospecto"
          },
          {
            "linea": 590,
            "contenido": "logger.error('Error cambiando etapa del prospecto', {"
          },
          {
            "linea": 591,
            "contenido": "ruta: 'prospectosRoutes',"
          },
          {
            "linea": 593,
            "contenido": "prospectoId: req.params.id,"
          },
          {
            "linea": 604,
            "contenido": "router.put('/:id/asignar', auth, verificarPermiso('prospectos', 'actualizar'), async (req, res) => {"
          },
          {
            "linea": 610,
            "contenido": "return res.status(403).json({ message: 'No tienes permisos para asignar prospectos' });"
          },
          {
            "linea": 613,
            "contenido": "const prospecto = await Prospecto.findById(req.params.id);"
          },
          {
            "linea": 614,
            "contenido": "if (!prospecto) {"
          },
          {
            "linea": 615,
            "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
          },
          {
            "linea": 618,
            "contenido": "prospecto.vendedorAsignado = vendedorId;"
          },
          {
            "linea": 619,
            "contenido": "prospecto.notas.push({"
          },
          {
            "linea": 621,
            "contenido": "contenido: `Prospecto reasignado`,"
          },
          {
            "linea": 625,
            "contenido": "await prospecto.save();"
          },
          {
            "linea": 626,
            "contenido": "await prospecto.populate('vendedorAsignado', 'nombre apellido');"
          },
          {
            "linea": 629,
            "contenido": "message: 'Prospecto asignado exitosamente',"
          },
          {
            "linea": 630,
            "contenido": "prospecto"
          },
          {
            "linea": 633,
            "contenido": "logger.error('Error asignando prospecto a vendedor', {"
          },
          {
            "linea": 634,
            "contenido": "ruta: 'prospectosRoutes',"
          },
          {
            "linea": 635,
            "contenido": "accion: 'asignarProspecto',"
          },
          {
            "linea": 636,
            "contenido": "prospectoId: req.params.id,"
          },
          {
            "linea": 660,
            "contenido": "const prospectos = await Prospecto.find(filtros)"
          },
          {
            "linea": 665,
            "contenido": "res.json(prospectos);"
          },
          {
            "linea": 667,
            "contenido": "logger.error('Error obteniendo prospectos pendientes de seguimiento', {"
          },
          {
            "linea": 668,
            "contenido": "ruta: 'prospectosRoutes',"
          },
          {
            "linea": 680,
            "contenido": "router.put('/:id/papelera', auth, verificarPermiso('prospectos', 'actualizar'), async (req, res) => {"
          },
          {
            "linea": 682,
            "contenido": "logger.info('Solicitud para mover prospecto a papelera', {"
          },
          {
            "linea": 683,
            "contenido": "ruta: 'prospectosRoutes',"
          },
          {
            "linea": 685,
            "contenido": "prospectoId: req.params.id,"
          },
          {
            "linea": 691,
            "contenido": "const prospecto = await Prospecto.findById(req.params.id);"
          },
          {
            "linea": 692,
            "contenido": "if (!prospecto) {"
          },
          {
            "linea": 693,
            "contenido": "logger.warn('Prospecto no encontrado al intentar mover a papelera', {"
          },
          {
            "linea": 694,
            "contenido": "ruta: 'prospectosRoutes',"
          },
          {
            "linea": 696,
            "contenido": "prospectoId: req.params.id,"
          },
          {
            "linea": 699,
            "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
          },
          {
            "linea": 702,
            "contenido": "logger.debug('Prospecto localizado para mover a papelera', {"
          },
          {
            "linea": 703,
            "contenido": "ruta: 'prospectosRoutes',"
          },
          {
            "linea": 705,
            "contenido": "prospectoId: prospecto._id,"
          },
          {
            "linea": 706,
            "contenido": "nombreProspecto: prospecto.nombre,"
          },
          {
            "linea": 710,
            "contenido": "prospecto.enPapelera = true;"
          },
          {
            "linea": 711,
            "contenido": "prospecto.fechaEliminacion = new Date();"
          },
          {
            "linea": 712,
            "contenido": "prospecto.eliminadoPor = req.usuario._id;"
          },
          {
            "linea": 713,
            "contenido": "await prospecto.save();"
          },
          {
            "linea": 715,
            "contenido": "logger.info('Prospecto movido a papelera exitosamente', {"
          },
          {
            "linea": 716,
            "contenido": "ruta: 'prospectosRoutes',"
          },
          {
            "linea": 718,
            "contenido": "prospectoId: prospecto._id,"
          },
          {
            "linea": 721,
            "contenido": "res.json({ message: 'Prospecto movido a papelera exitosamente' });"
          },
          {
            "linea": 723,
            "contenido": "logger.error('Error moviendo prospecto a papelera', {"
          },
          {
            "linea": 724,
            "contenido": "ruta: 'prospectosRoutes',"
          },
          {
            "linea": 726,
            "contenido": "prospectoId: req.params.id,"
          },
          {
            "linea": 736,
            "contenido": "router.put('/:id/restaurar', auth, verificarPermiso('prospectos', 'actualizar'), async (req, res) => {"
          },
          {
            "linea": 738,
            "contenido": "const prospecto = await Prospecto.findById(req.params.id);"
          },
          {
            "linea": 739,
            "contenido": "if (!prospecto) {"
          },
          {
            "linea": 740,
            "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
          },
          {
            "linea": 743,
            "contenido": "prospecto.enPapelera = false;"
          },
          {
            "linea": 744,
            "contenido": "prospecto.fechaEliminacion = null;"
          },
          {
            "linea": 745,
            "contenido": "prospecto.eliminadoPor = null;"
          },
          {
            "linea": 746,
            "contenido": "await prospecto.save();"
          },
          {
            "linea": 748,
            "contenido": "res.json({ message: 'Prospecto restaurado exitosamente' });"
          },
          {
            "linea": 750,
            "contenido": "logger.error('Error restaurando prospecto desde papelera', {"
          },
          {
            "linea": 751,
            "contenido": "ruta: 'prospectosRoutes',"
          },
          {
            "linea": 752,
            "contenido": "accion: 'restaurarProspecto',"
          },
          {
            "linea": 753,
            "contenido": "prospectoId: req.params.id,"
          },
          {
            "linea": 763,
            "contenido": "router.get('/papelera/listar', auth, verificarPermiso('prospectos', 'leer'), async (req, res) => {"
          },
          {
            "linea": 787,
            "contenido": "const result = await Prospecto.paginate(filtros, options);"
          },
          {
            "linea": 790,
            "contenido": "logger.error('Error obteniendo prospectos en papelera', {"
          },
          {
            "linea": 791,
            "contenido": "ruta: 'prospectosRoutes',"
          },
          {
            "linea": 803,
            "contenido": "router.delete('/:id/permanente', auth, verificarPermiso('prospectos', 'actualizar'), async (req, res) => {"
          },
          {
            "linea": 805,
            "contenido": "const prospecto = await Prospecto.findById(req.params.id);"
          },
          {
            "linea": 806,
            "contenido": "if (!prospecto) {"
          },
          {
            "linea": 807,
            "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
          },
          {
            "linea": 812,
            "contenido": "prospecto.vendedorAsignado?.toString() !== req.usuario._id.toString()) {"
          },
          {
            "linea": 813,
            "contenido": "return res.status(403).json({ message: 'No tienes acceso a este prospecto' });"
          },
          {
            "linea": 817,
            "contenido": "if (!prospecto.enPapelera) {"
          },
          {
            "linea": 818,
            "contenido": "return res.status(400).json({ message: 'El prospecto debe estar en papelera para eliminarlo permanentemente' });"
          },
          {
            "linea": 821,
            "contenido": "await Prospecto.findByIdAndDelete(req.params.id);"
          },
          {
            "linea": 823,
            "contenido": "res.json({ message: 'Prospecto eliminado permanentemente' });"
          },
          {
            "linea": 825,
            "contenido": "logger.error('Error eliminando prospecto permanentemente', {"
          },
          {
            "linea": 826,
            "contenido": "ruta: 'prospectosRoutes',"
          },
          {
            "linea": 828,
            "contenido": "prospectoId: req.params.id,"
          },
          {
            "linea": 838,
            "contenido": "router.delete('/:id/forzar', auth, verificarPermiso('prospectos', 'actualizar'), async (req, res) => {"
          },
          {
            "linea": 840,
            "contenido": "const prospecto = await Prospecto.findById(req.params.id);"
          },
          {
            "linea": 841,
            "contenido": "if (!prospecto) {"
          },
          {
            "linea": 842,
            "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
          },
          {
            "linea": 850,
            "contenido": "await Prospecto.findByIdAndDelete(req.params.id);"
          },
          {
            "linea": 852,
            "contenido": "res.json({ message: 'Prospecto eliminado permanentemente (forzado)' });"
          },
          {
            "linea": 854,
            "contenido": "logger.error('Error eliminando prospecto de forma forzada', {"
          },
          {
            "linea": 855,
            "contenido": "ruta: 'prospectosRoutes',"
          },
          {
            "linea": 857,
            "contenido": "prospectoId: req.params.id,"
          },
          {
            "linea": 867,
            "contenido": "router.delete('/papelera/vaciar', auth, verificarPermiso('prospectos', 'actualizar'), async (req, res) => {"
          },
          {
            "linea": 879,
            "contenido": "const result = await Prospecto.deleteMany(filtros);"
          },
          {
            "linea": 882,
            "contenido": "message: `${result.deletedCount} prospectos eliminados permanentemente`,"
          },
          {
            "linea": 886,
            "contenido": "logger.error('Error vaciando la papelera de prospectos', {"
          },
          {
            "linea": 887,
            "contenido": "ruta: 'prospectosRoutes',"
          }
        ]
      },
      {
        "archivo": "\\server\\routes\\proyectos.js",
        "referencias": 5,
        "detalles": [
          {
            "linea": 16,
            "contenido": "crearDesdeProspecto,"
          },
          {
            "linea": 99,
            "contenido": "router.post('/desde-prospecto/:prospectoId',"
          },
          {
            "linea": 102,
            "contenido": "crearDesdeProspecto"
          },
          {
            "linea": 229,
            "contenido": ".populate('prospecto')"
          },
          {
            "linea": 256,
            "contenido": ".populate('prospecto')"
          }
        ]
      },
      {
        "archivo": "\\server\\routes\\recordatorios.js",
        "referencias": 1,
        "detalles": [
          {
            "linea": 17,
            "contenido": ".populate('prospecto', 'nombre telefono')"
          }
        ]
      }
    ],
    "controllers": [
      {
        "archivo": "\\server\\controllers\\cotizacionController.js",
        "referencias": 26,
        "detalles": [
          {
            "linea": 2,
            "contenido": "const Prospecto = require('../models/Prospecto');"
          },
          {
            "linea": 27,
            "contenido": "prospecto: prospectoId,"
          },
          {
            "linea": 46,
            "contenido": "if (!prospectoId) {"
          },
          {
            "linea": 47,
            "contenido": "logger.warn('Solicitud sin prospectoId', {"
          },
          {
            "linea": 54,
            "contenido": "return res.status(400).json({ message: 'Debes proporcionar el prospecto asociado a la cotización.' });"
          },
          {
            "linea": 87,
            "contenido": "const prospecto = await Prospecto.findById(prospectoId);"
          },
          {
            "linea": 88,
            "contenido": "if (!prospecto) {"
          },
          {
            "linea": 89,
            "contenido": "logger.warn('Prospecto no encontrado para crear cotización', {"
          },
          {
            "linea": 95,
            "contenido": "prospectoId"
          },
          {
            "linea": 97,
            "contenido": "return res.status(404).json({ message: 'Prospecto no encontrado' });"
          },
          {
            "linea": 123,
            "contenido": "prospecto: prospecto._id,"
          },
          {
            "linea": 124,
            "contenido": "nombre: nombre || `Cotización para ${prospecto.nombre}`,"
          },
          {
            "linea": 171,
            "contenido": "prospectoId: prospecto._id"
          },
          {
            "linea": 174,
            "contenido": "prospecto.etapa = 'cotizacion';"
          },
          {
            "linea": 175,
            "contenido": "prospecto.fechaUltimoContacto = new Date();"
          },
          {
            "linea": 176,
            "contenido": "await prospecto.save();"
          },
          {
            "linea": 177,
            "contenido": "logger.info('Prospecto actualizado a etapa cotizacion', {"
          },
          {
            "linea": 183,
            "contenido": "prospectoId"
          },
          {
            "linea": 229,
            "contenido": "const cotizacion = await Cotizacion.findById(id).populate('prospecto');"
          },
          {
            "linea": 253,
            "contenido": "if (cotizacion.prospecto?._id) {"
          },
          {
            "linea": 254,
            "contenido": "await Prospecto.findByIdAndUpdate(cotizacion.prospecto._id, {"
          },
          {
            "linea": 268,
            "contenido": "prospectoId: cotizacion.prospecto?._id,"
          },
          {
            "linea": 270,
            "contenido": "id: cotizacion.prospecto?._id,"
          },
          {
            "linea": 271,
            "contenido": "nombre: cotizacion.prospecto?.nombre,"
          },
          {
            "linea": 272,
            "contenido": "telefono: cotizacion.prospecto?.telefono,"
          },
          {
            "linea": 273,
            "contenido": "correo: cotizacion.prospecto?.correo"
          }
        ]
      },
      {
        "archivo": "\\server\\controllers\\fabricacionController.js",
        "referencias": 12,
        "detalles": [
          {
            "linea": 92,
            "contenido": ".populate('prospecto', 'nombre telefono direccion');"
          },
          {
            "linea": 112,
            "contenido": "prospectoId: pedido.prospecto?._id,"
          },
          {
            "linea": 122,
            "contenido": "nombre: pedido.prospecto?.nombre,"
          },
          {
            "linea": 123,
            "contenido": "telefono: pedido.prospecto?.telefono,"
          },
          {
            "linea": 124,
            "contenido": "direccion: pedido.prospecto?.direccion || ''"
          },
          {
            "linea": 214,
            "contenido": "}, { new: true }).populate('prospecto', 'nombre telefono direccion email');"
          },
          {
            "linea": 222,
            "contenido": "nombre: pedidoEvento?.prospecto?.nombre,"
          },
          {
            "linea": 223,
            "contenido": "telefono: pedidoEvento?.prospecto?.telefono,"
          },
          {
            "linea": 250,
            "contenido": "select: 'numero prospecto productos estado fechaInstalacion fechaEntrega direccionEntrega contactoEntrega',"
          },
          {
            "linea": 251,
            "contenido": "populate: { path: 'prospecto', select: 'nombre telefono email direccion' }"
          },
          {
            "linea": 270,
            "contenido": "nombre: ordenActualizada.pedido?.prospecto?.nombre,"
          },
          {
            "linea": 271,
            "contenido": "telefono: ordenActualizada.pedido?.prospecto?.telefono,"
          }
        ]
      },
      {
        "archivo": "\\server\\controllers\\pedidoController.js",
        "referencias": 10,
        "detalles": [
          {
            "linea": 3,
            "contenido": "const Prospecto = require('../models/Prospecto');"
          },
          {
            "linea": 22,
            "contenido": "const cotizacion = await Cotizacion.findById(cotizacionId).populate('prospecto');"
          },
          {
            "linea": 91,
            "contenido": "prospecto: cotizacion.prospecto?._id,"
          },
          {
            "linea": 109,
            "contenido": "direccionEntrega: direccionEntrega || cotizacion.prospecto?.direccion || {},"
          },
          {
            "linea": 111,
            "contenido": "nombre: cotizacion.prospecto?.nombre,"
          },
          {
            "linea": 112,
            "contenido": "telefono: cotizacion.prospecto?.telefono,"
          },
          {
            "linea": 130,
            "contenido": "if (cotizacion.prospecto?._id) {"
          },
          {
            "linea": 131,
            "contenido": "await Prospecto.findByIdAndUpdate(cotizacion.prospecto._id, {"
          },
          {
            "linea": 138,
            "contenido": ".populate('prospecto', 'nombre telefono email direccion')"
          },
          {
            "linea": 165,
            "contenido": "prospectoId: pedidoCompleto.prospecto?._id,"
          }
        ]
      },
      {
        "archivo": "\\server\\controllers\\proyectoController.js",
        "referencias": 31,
        "detalles": [
          {
            "linea": 2,
            "contenido": "const Prospecto = require('../models/Prospecto');"
          },
          {
            "linea": 95,
            "contenido": "const proyecto = await Proyecto.findById(id).populate('prospecto_original');"
          },
          {
            "linea": 106,
            "contenido": "const prospecto = proyecto.prospecto_original || proyecto.cliente || {};"
          },
          {
            "linea": 113,
            "contenido": "prospecto,"
          },
          {
            "linea": 127,
            "contenido": "const clienteNombre = prospecto?.nombre || proyecto.cliente?.nombre || id;"
          },
          {
            "linea": 420,
            "contenido": "prospecto_original"
          },
          {
            "linea": 442,
            "contenido": "prospecto_original,"
          },
          {
            "linea": 458,
            "contenido": "{ path: 'prospecto_original', select: 'nombre telefono' }"
          },
          {
            "linea": 535,
            "contenido": "{ path: 'prospecto_original', select: 'nombre telefono email etapa' }"
          },
          {
            "linea": 605,
            "contenido": "{ path: 'prospecto_original', select: 'nombre telefono email direccion' },"
          },
          {
            "linea": 678,
            "contenido": "{ path: 'prospecto_original', select: 'nombre telefono' }"
          },
          {
            "linea": 871,
            "contenido": "const crearDesdeProspecto = async (req, res) => {"
          },
          {
            "linea": 873,
            "contenido": "const { prospectoId } = req.params;"
          },
          {
            "linea": 876,
            "contenido": "if (!mongoose.Types.ObjectId.isValid(prospectoId)) {"
          },
          {
            "linea": 879,
            "contenido": "message: 'ID de prospecto inválido'"
          },
          {
            "linea": 883,
            "contenido": "const prospecto = await Prospecto.findById(prospectoId);"
          },
          {
            "linea": 885,
            "contenido": "if (!prospecto) {"
          },
          {
            "linea": 888,
            "contenido": "message: 'Prospecto no encontrado'"
          },
          {
            "linea": 895,
            "contenido": "nombre: prospecto.nombre,"
          },
          {
            "linea": 896,
            "contenido": "telefono: prospecto.telefono,"
          },
          {
            "linea": 897,
            "contenido": "correo: prospecto.email,"
          },
          {
            "linea": 898,
            "contenido": "direccion: prospecto.direccion,"
          },
          {
            "linea": 899,
            "contenido": "zona: prospecto.zona"
          },
          {
            "linea": 902,
            "contenido": "observaciones: prospecto.observaciones,"
          },
          {
            "linea": 903,
            "contenido": "responsable: prospecto.asesorAsignado,"
          },
          {
            "linea": 904,
            "contenido": "prospecto_original: prospectoId,"
          },
          {
            "linea": 913,
            "contenido": "message: 'Proyecto creado desde prospecto exitosamente',"
          },
          {
            "linea": 919,
            "contenido": "context: 'crearDesdeProspecto',"
          },
          {
            "linea": 920,
            "contenido": "prospectoId: req.params.prospectoId,"
          },
          {
            "linea": 1489,
            "contenido": "prospecto: proyecto.prospecto_original,"
          },
          {
            "linea": 1643,
            "contenido": "crearDesdeProspecto,"
          }
        ]
      },
      {
        "archivo": "\\server\\controllers\\proyectoPedidoController.js",
        "referencias": 13,
        "detalles": [
          {
            "linea": 2,
            "contenido": "const Prospecto = require('../models/Prospecto');"
          },
          {
            "linea": 20,
            "contenido": "const cotizacion = await Cotizacion.findById(cotizacionId).populate('prospecto');"
          },
          {
            "linea": 47,
            "contenido": "prospecto: cotizacion.prospecto._id,"
          },
          {
            "linea": 52,
            "contenido": "nombre: cotizacion.prospecto.nombre,"
          },
          {
            "linea": 53,
            "contenido": "telefono: cotizacion.prospecto.telefono,"
          },
          {
            "linea": 54,
            "contenido": "email: cotizacion.prospecto.email,"
          },
          {
            "linea": 55,
            "contenido": "direccion: cotizacion.prospecto.direccion"
          },
          {
            "linea": 103,
            "contenido": "direccion: cotizacion.prospecto.direccion,"
          },
          {
            "linea": 105,
            "contenido": "nombre: contactoEntrega?.nombre || cotizacion.prospecto.nombre,"
          },
          {
            "linea": 106,
            "contenido": "telefono: contactoEntrega?.telefono || cotizacion.prospecto.telefono,"
          },
          {
            "linea": 137,
            "contenido": ".populate('prospecto', 'nombre telefono email')"
          },
          {
            "linea": 259,
            "contenido": "{ path: 'prospecto', select: 'nombre telefono email etapa' },"
          },
          {
            "linea": 311,
            "contenido": ".populate('prospecto')"
          }
        ]
      },
      {
        "archivo": "\\server\\tests\\controllers\\pedidoController.test.js",
        "referencias": 1,
        "detalles": [
          {
            "linea": 20,
            "contenido": "jest.mock('../../models/Prospecto', () => ({}));"
          }
        ]
      }
    ],
    "middleware": [
      {
        "archivo": "\\server\\middleware\\proyectoSync.js",
        "referencias": 64,
        "detalles": [
          {
            "linea": 14,
            "contenido": "static async sincronizarProspecto(prospecto, operacion = 'create') {"
          },
          {
            "linea": 16,
            "contenido": "logger.info('Sincronizando prospecto con proyecto', {"
          },
          {
            "linea": 18,
            "contenido": "accion: 'sincronizarProspecto',"
          },
          {
            "linea": 19,
            "contenido": "prospectoId: prospecto?._id?.toString(),"
          },
          {
            "linea": 24,
            "contenido": "let proyecto = await Proyecto.findOne({ prospecto_original: prospecto._id });"
          },
          {
            "linea": 28,
            "contenido": "proyecto = await this.crearProyectoDesdeProspecto(prospecto);"
          },
          {
            "linea": 31,
            "contenido": "proyecto = await this.actualizarProyectoDesdeProspecto(proyecto, prospecto);"
          },
          {
            "linea": 37,
            "contenido": "logger.error('Error en sincronización Prospecto → Proyecto', {"
          },
          {
            "linea": 39,
            "contenido": "accion: 'sincronizarProspecto',"
          },
          {
            "linea": 40,
            "contenido": "prospectoId: prospecto?._id?.toString(),"
          },
          {
            "linea": 53,
            "contenido": "static async crearProyectoDesdeProspecto(prospecto) {"
          },
          {
            "linea": 55,
            "contenido": "logger.info('Creando proyecto desde prospecto', {"
          },
          {
            "linea": 57,
            "contenido": "accion: 'crearProyectoDesdeProspecto',"
          },
          {
            "linea": 58,
            "contenido": "prospectoId: prospecto?._id?.toString()"
          },
          {
            "linea": 62,
            "contenido": "const tipo_fuente = this.determinarTipoFuente(prospecto);"
          },
          {
            "linea": 67,
            "contenido": "nombre: prospecto.nombre,"
          },
          {
            "linea": 68,
            "contenido": "telefono: prospecto.telefono,"
          },
          {
            "linea": 69,
            "contenido": "correo: prospecto.email,"
          },
          {
            "linea": 70,
            "contenido": "direccion: this.formatearDireccion(prospecto.direccion),"
          },
          {
            "linea": 71,
            "contenido": "zona: prospecto.direccion?.colonia || ''"
          },
          {
            "linea": 74,
            "contenido": "estado: this.mapearEtapaAEstado(prospecto.etapa),"
          },
          {
            "linea": 75,
            "contenido": "observaciones: prospecto.descripcionNecesidad || '',"
          },
          {
            "linea": 79,
            "contenido": "fotos: prospecto.archivos?.map(arch => arch.url) || [],"
          },
          {
            "linea": 80,
            "contenido": "responsable: prospecto.vendedorAsignado?.toString() || '',"
          },
          {
            "linea": 81,
            "contenido": "monto_estimado: prospecto.presupuestoEstimado || 0,"
          },
          {
            "linea": 82,
            "contenido": "prospecto_original: prospecto._id,"
          },
          {
            "linea": 83,
            "contenido": "fecha_compromiso: prospecto.fechaCita,"
          },
          {
            "linea": 86,
            "contenido": "creado_por: prospecto.vendedorAsignado,"
          },
          {
            "linea": 87,
            "contenido": "asesor_asignado: prospecto.vendedorAsignado,"
          },
          {
            "linea": 93,
            "contenido": "logger.info('Proyecto creado exitosamente desde prospecto', {"
          },
          {
            "linea": 95,
            "contenido": "accion: 'crearProyectoDesdeProspecto',"
          },
          {
            "linea": 96,
            "contenido": "prospectoId: prospecto?._id?.toString(),"
          },
          {
            "linea": 103,
            "contenido": "logger.error('Error creando proyecto desde prospecto', {"
          },
          {
            "linea": 105,
            "contenido": "accion: 'crearProyectoDesdeProspecto',"
          },
          {
            "linea": 106,
            "contenido": "prospectoId: prospecto?._id?.toString(),"
          },
          {
            "linea": 117,
            "contenido": "static async actualizarProyectoDesdeProspecto(proyecto, prospecto) {"
          },
          {
            "linea": 119,
            "contenido": "logger.info('Actualizando proyecto desde prospecto', {"
          },
          {
            "linea": 121,
            "contenido": "accion: 'actualizarProyectoDesdeProspecto',"
          },
          {
            "linea": 122,
            "contenido": "prospectoId: prospecto?._id?.toString(),"
          },
          {
            "linea": 127,
            "contenido": "proyecto.cliente.nombre = prospecto.nombre;"
          },
          {
            "linea": 128,
            "contenido": "proyecto.cliente.telefono = prospecto.telefono;"
          },
          {
            "linea": 129,
            "contenido": "proyecto.cliente.correo = prospecto.email;"
          },
          {
            "linea": 130,
            "contenido": "proyecto.cliente.direccion = this.formatearDireccion(prospecto.direccion);"
          },
          {
            "linea": 131,
            "contenido": "proyecto.cliente.zona = prospecto.direccion?.colonia || '';"
          },
          {
            "linea": 133,
            "contenido": "proyecto.estado = this.mapearEtapaAEstado(prospecto.etapa);"
          },
          {
            "linea": 134,
            "contenido": "proyecto.observaciones = prospecto.descripcionNecesidad || '';"
          },
          {
            "linea": 135,
            "contenido": "proyecto.monto_estimado = prospecto.presupuestoEstimado || 0;"
          },
          {
            "linea": 136,
            "contenido": "proyecto.fecha_compromiso = prospecto.fechaCita;"
          },
          {
            "linea": 140,
            "contenido": "logger.info('Proyecto actualizado exitosamente desde prospecto', {"
          },
          {
            "linea": 142,
            "contenido": "accion: 'actualizarProyectoDesdeProspecto',"
          },
          {
            "linea": 143,
            "contenido": "prospectoId: prospecto?._id?.toString(),"
          },
          {
            "linea": 150,
            "contenido": "logger.error('Error actualizando proyecto desde prospecto', {"
          },
          {
            "linea": 152,
            "contenido": "accion: 'actualizarProyectoDesdeProspecto',"
          },
          {
            "linea": 153,
            "contenido": "prospectoId: prospecto?._id?.toString(),"
          },
          {
            "linea": 165,
            "contenido": "static async sincronizarMedidasDesdeEtapas(proyectoId, prospectoId) {"
          },
          {
            "linea": 170,
            "contenido": "const etapas = await Etapa.find({ prospectoId }).sort({ creadoEn: 1 });"
          },
          {
            "linea": 273,
            "contenido": "prospectoId: prospectoId?.toString(),"
          },
          {
            "linea": 282,
            "contenido": "prospectoId: prospectoId?.toString(),"
          },
          {
            "linea": 316,
            "contenido": "static determinarTipoFuente(prospecto) {"
          },
          {
            "linea": 317,
            "contenido": "if (prospecto.fuente === 'cotizacion_directa') return 'directo';"
          },
          {
            "linea": 318,
            "contenido": "if (prospecto.tipoProducto === 'cotizacion') return 'en_vivo';"
          },
          {
            "linea": 319,
            "contenido": "if (prospecto.tipoProducto === 'toma_medidas') return 'formal';"
          },
          {
            "linea": 323,
            "contenido": "static mapearEtapaAEstado(etapaProspecto) {"
          },
          {
            "linea": 338,
            "contenido": "return mapeo[etapaProspecto] || 'levantamiento';"
          }
        ]
      }
    ],
    "otros": [
      {
        "archivo": "\\server\\index.js",
        "referencias": 1,
        "detalles": [
          {
            "linea": 124,
            "contenido": "app.use('/api/prospectos', require('./routes/prospectos'));"
          }
        ]
      },
      {
        "archivo": "\\server\\listeners\\fabricacionListener.js",
        "referencias": 4,
        "detalles": [
          {
            "linea": 50,
            "contenido": "const pedido = await Pedido.findById(pedidoId).populate('prospecto');"
          },
          {
            "linea": 72,
            "contenido": "nombre: pedido.prospecto?.nombre,"
          },
          {
            "linea": 73,
            "contenido": "telefono: pedido.prospecto?.telefono,"
          },
          {
            "linea": 74,
            "contenido": "direccion: pedido.prospecto?.direccion?.calle || ''"
          }
        ]
      },
      {
        "archivo": "\\server\\listeners\\instalacionListener.js",
        "referencias": 3,
        "detalles": [
          {
            "linea": 41,
            "contenido": "const pedido = await Pedido.findById(pedidoId).populate('prospecto');"
          },
          {
            "linea": 69,
            "contenido": "nombre: cliente?.nombre || pedido.prospecto?.nombre,"
          },
          {
            "linea": 70,
            "contenido": "telefono: cliente?.telefono || pedido.prospecto?.telefono"
          }
        ]
      },
      {
        "archivo": "\\server\\listeners\\pedidoListener.js",
        "referencias": 17,
        "detalles": [
          {
            "linea": 4,
            "contenido": "const Prospecto = require('../models/Prospecto');"
          },
          {
            "linea": 28,
            "contenido": "prospectoId,"
          },
          {
            "linea": 36,
            "contenido": "if (!cotizacionId || !prospectoId) {"
          },
          {
            "linea": 39,
            "contenido": "prospectoId"
          },
          {
            "linea": 63,
            "contenido": ".select('prospecto total productos formaPago instalacion descuento pago entrega vendedor')"
          },
          {
            "linea": 64,
            "contenido": ".populate('prospecto');"
          },
          {
            "linea": 66,
            "contenido": "const prospecto = cotizacion?.prospecto || await Prospecto.findById(prospectoId);"
          },
          {
            "linea": 68,
            "contenido": "if (!cotizacion && !prospecto) {"
          },
          {
            "linea": 69,
            "contenido": "this.logWarn('No se encontró cotización ni prospecto para crear pedido', {"
          },
          {
            "linea": 71,
            "contenido": "prospectoId"
          },
          {
            "linea": 78,
            "contenido": "prospecto: prospecto?._id || prospectoId,"
          },
          {
            "linea": 125,
            "contenido": "if (prospecto) {"
          },
          {
            "linea": 126,
            "contenido": "prospecto.etapa = 'pedido';"
          },
          {
            "linea": 127,
            "contenido": "prospecto.fechaUltimoContacto = new Date();"
          },
          {
            "linea": 128,
            "contenido": "await prospecto.save();"
          },
          {
            "linea": 138,
            "contenido": "prospectoId: prospecto?._id || prospectoId"
          },
          {
            "linea": 148,
            "contenido": "prospectoId"
          }
        ]
      },
      {
        "archivo": "\\server\\scripts\\auditoria_colecciones.js",
        "referencias": 1,
        "detalles": [
          {
            "linea": 25,
            "contenido": "const coleccionesClave = ['prospectos', 'proyectos', 'cotizacions', 'pedidos', 'ordenfabricacions'];"
          }
        ]
      },
      {
        "archivo": "\\server\\scripts\\auditoria_dependencias_prospecto.js",
        "referencias": 4,
        "detalles": [
          {
            "linea": 26,
            "contenido": "if (linea.toLowerCase().includes('prospecto') &&"
          },
          {
            "linea": 94,
            "contenido": "let markdown = `# 📊 AUDITORÍA DE DEPENDENCIAS — PROSPECTO LEGACY"
          },
          {
            "linea": 171,
            "contenido": "const reportePath = path.join(process.cwd(), 'docs', 'proyectos', 'auditorias', 'dependencias_prospecto_legacy.md');"
          },
          {
            "linea": 177,
            "contenido": "const jsonPath = path.join(process.cwd(), 'docs', 'proyectos', 'auditorias', 'dependencias_prospecto_legacy.json');"
          }
        ]
      },
      {
        "archivo": "\\server\\scripts\\buscarProspecto.js",
        "referencias": 4,
        "detalles": [
          {
            "linea": 2,
            "contenido": "const Prospecto = require('../models/Prospecto');"
          },
          {
            "linea": 16,
            "contenido": "const prospectos = await Prospecto.find(query)"
          },
          {
            "linea": 20,
            "contenido": "console.log(`📊 Total prospectos: ${prospectos.length}\\n`);"
          },
          {
            "linea": 22,
            "contenido": "prospectos.forEach((p, i) => {"
          }
        ]
      },
      {
        "archivo": "\\server\\scripts\\crearDatosPruebaFlujoTecnico.js",
        "referencias": 26,
        "detalles": [
          {
            "linea": 14,
            "contenido": "const Prospecto = require('../models/Prospecto');"
          },
          {
            "linea": 29,
            "contenido": "async function crearProspectoPrueba() {"
          },
          {
            "linea": 30,
            "contenido": "log('\\n📋 Creando prospecto de prueba...', 'yellow');"
          },
          {
            "linea": 32,
            "contenido": "const prospecto = new Prospecto({"
          },
          {
            "linea": 49,
            "contenido": "await prospecto.save();"
          },
          {
            "linea": 50,
            "contenido": "log(`✅ Prospecto creado: ${prospecto.nombre} (${prospecto._id})`, 'green');"
          },
          {
            "linea": 52,
            "contenido": "return prospecto;"
          },
          {
            "linea": 55,
            "contenido": "async function crearProyectoConLevantamiento(prospecto) {"
          },
          {
            "linea": 64,
            "contenido": "nombre: prospecto.nombre,"
          },
          {
            "linea": 65,
            "contenido": "telefono: prospecto.telefono,"
          },
          {
            "linea": 66,
            "contenido": "email: prospecto.email,"
          },
          {
            "linea": 67,
            "contenido": "direccion: prospecto.direccion"
          },
          {
            "linea": 69,
            "contenido": "prospecto: prospecto._id,"
          },
          {
            "linea": 194,
            "contenido": "async function crearCotizacion(proyecto, prospecto) {"
          },
          {
            "linea": 205,
            "contenido": "prospecto: prospecto._id,"
          },
          {
            "linea": 246,
            "contenido": "async function crearPedido(cotizacion, proyecto, prospecto) {"
          },
          {
            "linea": 255,
            "contenido": "prospecto: prospecto._id,"
          },
          {
            "linea": 278,
            "contenido": "direccionEntrega: prospecto.direccion,"
          },
          {
            "linea": 280,
            "contenido": "nombre: prospecto.nombre,"
          },
          {
            "linea": 281,
            "contenido": "telefono: prospecto.telefono,"
          },
          {
            "linea": 344,
            "contenido": "await Prospecto.deleteMany({ nombre: 'Juan Pérez García' });"
          },
          {
            "linea": 351,
            "contenido": "const prospecto = await crearProspectoPrueba();"
          },
          {
            "linea": 352,
            "contenido": "const proyecto = await crearProyectoConLevantamiento(prospecto);"
          },
          {
            "linea": 353,
            "contenido": "const cotizacion = await crearCotizacion(proyecto, prospecto);"
          },
          {
            "linea": 354,
            "contenido": "const pedido = await crearPedido(cotizacion, proyecto, prospecto);"
          },
          {
            "linea": 363,
            "contenido": "log(`\\n✅ Prospecto: ${prospecto.nombre} (${prospecto._id})`, 'green');"
          }
        ]
      },
      {
        "archivo": "\\server\\scripts\\crearDatosSimple.js",
        "referencias": 11,
        "detalles": [
          {
            "linea": 3,
            "contenido": "const Prospecto = require('../models/Prospecto');"
          },
          {
            "linea": 17,
            "contenido": "const prospecto = new Prospecto({"
          },
          {
            "linea": 24,
            "contenido": "await prospecto.save();"
          },
          {
            "linea": 25,
            "contenido": "logger.info('Prospecto de prueba creado', {"
          },
          {
            "linea": 27,
            "contenido": "prospectoId: prospecto._id.toString(),"
          },
          {
            "linea": 28,
            "contenido": "nombre: prospecto.nombre"
          },
          {
            "linea": 33,
            "contenido": "prospecto: prospecto._id,"
          },
          {
            "linea": 51,
            "contenido": "prospectoId: prospecto._id.toString()"
          },
          {
            "linea": 56,
            "contenido": "prospecto: prospecto._id,"
          },
          {
            "linea": 58,
            "contenido": "creado_por: prospecto._id,"
          },
          {
            "linea": 118,
            "contenido": "prospectoId: prospecto._id.toString(),"
          }
        ]
      },
      {
        "archivo": "\\server\\scripts\\crearProyectosPrueba.js",
        "referencias": 9,
        "detalles": [
          {
            "linea": 3,
            "contenido": "const Prospecto = require('../models/Prospecto');"
          },
          {
            "linea": 18,
            "contenido": "const prospecto = new Prospecto({"
          },
          {
            "linea": 29,
            "contenido": "await prospecto.save();"
          },
          {
            "linea": 30,
            "contenido": "logger.info('Prospecto de prueba creado', {"
          },
          {
            "linea": 32,
            "contenido": "prospectoId: prospecto._id.toString(),"
          },
          {
            "linea": 33,
            "contenido": "nombre: prospecto.nombre"
          },
          {
            "linea": 38,
            "contenido": "prospecto: prospecto._id,"
          },
          {
            "linea": 57,
            "contenido": "prospectoId: prospecto._id.toString()"
          },
          {
            "linea": 62,
            "contenido": "prospecto: prospecto._id,"
          }
        ]
      },
      {
        "archivo": "\\server\\scripts\\eliminarDatosPrueba.js",
        "referencias": 3,
        "detalles": [
          {
            "linea": 9,
            "contenido": "const Prospecto = require('../models/Prospecto');"
          },
          {
            "linea": 31,
            "contenido": "const resultProspectos = await Prospecto.deleteMany({ nombre: 'Juan Pérez García' });"
          },
          {
            "linea": 37,
            "contenido": "log(`   Prospectos: ${resultProspectos.deletedCount}`, 'reset');"
          }
        ]
      },
      {
        "archivo": "\\server\\scripts\\insertarDatos.js",
        "referencias": 3,
        "detalles": [
          {
            "linea": 22,
            "contenido": "prospecto: objectId,"
          },
          {
            "linea": 119,
            "contenido": "prospecto: new mongoose.Types.ObjectId(),"
          },
          {
            "linea": 162,
            "contenido": "prospecto: new mongoose.Types.ObjectId(),"
          }
        ]
      },
      {
        "archivo": "\\server\\scripts\\limpiarBaseDatos.js",
        "referencias": 6,
        "detalles": [
          {
            "linea": 7,
            "contenido": "const Prospecto = require('../models/Prospecto');"
          },
          {
            "linea": 34,
            "contenido": "prospectos: await Prospecto.countDocuments(),"
          },
          {
            "linea": 44,
            "contenido": "console.log(`   - Prospectos: ${conteoAntes.prospectos}`);"
          },
          {
            "linea": 68,
            "contenido": "prospectos: await Prospecto.deleteMany({}),"
          },
          {
            "linea": 77,
            "contenido": "console.log(`   - Prospectos: ${resultados.prospectos.deletedCount} eliminados`);"
          },
          {
            "linea": 89,
            "contenido": "prospectos: resultados.prospectos.deletedCount,"
          }
        ]
      },
      {
        "archivo": "\\server\\scripts\\migrarAProyectos.js",
        "referencias": 37,
        "detalles": [
          {
            "linea": 2,
            "contenido": "const Prospecto = require('../models/Prospecto');"
          },
          {
            "linea": 25,
            "contenido": "prospectos: 0,"
          },
          {
            "linea": 61,
            "contenido": "const prospectos = await Prospecto.find({}).lean();"
          },
          {
            "linea": 62,
            "contenido": "logger.info('Prospectos recuperados para migración completa', {"
          },
          {
            "linea": 65,
            "contenido": "totalProspectos: prospectos.length"
          },
          {
            "linea": 68,
            "contenido": "for (const prospecto of prospectos) {"
          },
          {
            "linea": 70,
            "contenido": "await this.migrarProspecto(prospecto);"
          },
          {
            "linea": 71,
            "contenido": "this.estadisticas.prospectos++;"
          },
          {
            "linea": 73,
            "contenido": "logger.error('Error migrando prospecto en proceso masivo', {"
          },
          {
            "linea": 76,
            "contenido": "prospectoId: prospecto._id,"
          },
          {
            "linea": 81,
            "contenido": "tipo: 'prospecto',"
          },
          {
            "linea": 82,
            "contenido": "id: prospecto._id,"
          },
          {
            "linea": 96,
            "contenido": "async migrarProspecto(prospecto) {"
          },
          {
            "linea": 97,
            "contenido": "logger.info('Migrando prospecto a proyecto unificado', {"
          },
          {
            "linea": 99,
            "contenido": "etapa: 'migrarProspecto',"
          },
          {
            "linea": 100,
            "contenido": "prospectoId: prospecto._id,"
          },
          {
            "linea": 101,
            "contenido": "prospectoNombre: prospecto.nombre"
          },
          {
            "linea": 105,
            "contenido": "const etapas = await Etapa.find({ prospectoId: prospecto._id }).lean();"
          },
          {
            "linea": 108,
            "contenido": "etapa: 'migrarProspecto',"
          },
          {
            "linea": 109,
            "contenido": "prospectoId: prospecto._id,"
          },
          {
            "linea": 114,
            "contenido": "const cotizaciones = await Cotizacion.find({ prospecto: prospecto._id }).lean();"
          },
          {
            "linea": 117,
            "contenido": "etapa: 'migrarProspecto',"
          },
          {
            "linea": 118,
            "contenido": "prospectoId: prospecto._id,"
          },
          {
            "linea": 123,
            "contenido": "const pedidos = await Pedido.find({ prospecto: prospecto._id }).lean();"
          },
          {
            "linea": 126,
            "contenido": "etapa: 'migrarProspecto',"
          },
          {
            "linea": 127,
            "contenido": "prospectoId: prospecto._id,"
          },
          {
            "linea": 143,
            "contenido": "prospecto: prospecto._id,"
          },
          {
            "linea": 151,
            "contenido": "nombre: prospecto.nombre,"
          },
          {
            "linea": 152,
            "contenido": "telefono: prospecto.telefono,"
          },
          {
            "linea": 153,
            "contenido": "email: prospecto.email,"
          },
          {
            "linea": 154,
            "contenido": "direccion: prospecto.direccion || {}"
          },
          {
            "linea": 167,
            "contenido": "fechaCreacion: prospecto.fechaCreacion || new Date(),"
          },
          {
            "linea": 179,
            "contenido": "origenProspecto: prospecto._id,"
          },
          {
            "linea": 190,
            "contenido": "logger.info('Proyecto unificado creado para prospecto', {"
          },
          {
            "linea": 192,
            "contenido": "etapa: 'migrarProspecto',"
          },
          {
            "linea": 193,
            "contenido": "prospectoId: prospecto._id,"
          },
          {
            "linea": 407,
            "contenido": "prospectosMigrados: this.estadisticas.prospectos,"
          }
        ]
      },
      {
        "archivo": "\\server\\scripts\\migrarDatos.js",
        "referencias": 45,
        "detalles": [
          {
            "linea": 2,
            "contenido": "const Prospecto = require('../models/Prospecto');"
          },
          {
            "linea": 31,
            "contenido": "async function migrarProspectosAProyectos() {"
          },
          {
            "linea": 33,
            "contenido": "logger.info('Iniciando migración de prospectos a proyectos', {"
          },
          {
            "linea": 35,
            "contenido": "etapa: 'migrarProspectosAProyectos'"
          },
          {
            "linea": 39,
            "contenido": "const prospectos = await Prospecto.find({}).lean();"
          },
          {
            "linea": 40,
            "contenido": "logger.info('Prospectos recuperados para sincronización', {"
          },
          {
            "linea": 42,
            "contenido": "etapa: 'migrarProspectosAProyectos',"
          },
          {
            "linea": 43,
            "contenido": "totalProspectos: prospectos.length"
          },
          {
            "linea": 50,
            "contenido": "for (const prospecto of prospectos) {"
          },
          {
            "linea": 54,
            "contenido": "prospecto_original: prospecto._id"
          },
          {
            "linea": 59,
            "contenido": "await ProyectoSyncMiddleware.sincronizarProspecto(prospecto, 'update');"
          },
          {
            "linea": 63,
            "contenido": "await ProyectoSyncMiddleware.sincronizarProspecto(prospecto, 'create');"
          },
          {
            "linea": 68,
            "contenido": "const proyecto = await Proyecto.findOne({ prospecto_original: prospecto._id });"
          },
          {
            "linea": 72,
            "contenido": "prospecto._id"
          },
          {
            "linea": 74,
            "contenido": "logger.info('Proyecto sincronizado desde prospecto', {"
          },
          {
            "linea": 76,
            "contenido": "etapa: 'migrarProspectosAProyectos',"
          },
          {
            "linea": 78,
            "contenido": "prospectoId: prospecto._id,"
          },
          {
            "linea": 79,
            "contenido": "prospectoNombre: prospecto.nombre,"
          },
          {
            "linea": 85,
            "contenido": "etapa: 'migrarProspectosAProyectos',"
          },
          {
            "linea": 86,
            "contenido": "prospectoId: prospecto._id,"
          },
          {
            "linea": 87,
            "contenido": "prospectoNombre: prospecto.nombre,"
          },
          {
            "linea": 93,
            "contenido": "logger.error('Error procesando prospecto durante migración', {"
          },
          {
            "linea": 95,
            "contenido": "etapa: 'migrarProspectosAProyectos',"
          },
          {
            "linea": 96,
            "contenido": "prospectoId: prospecto._id,"
          },
          {
            "linea": 97,
            "contenido": "prospectoNombre: prospecto.nombre,"
          },
          {
            "linea": 105,
            "contenido": "logger.info('Resumen de migración de prospectos a proyectos', {"
          },
          {
            "linea": 107,
            "contenido": "etapa: 'migrarProspectosAProyectos',"
          },
          {
            "linea": 115,
            "contenido": "logger.error('Error general en migración de prospectos a proyectos', {"
          },
          {
            "linea": 117,
            "contenido": "etapa: 'migrarProspectosAProyectos',"
          },
          {
            "linea": 132,
            "contenido": "const totalProspectos = await Prospecto.countDocuments({});"
          },
          {
            "linea": 134,
            "contenido": "const proyectosConProspecto = await Proyecto.countDocuments({"
          },
          {
            "linea": 135,
            "contenido": "prospecto_original: { $exists: true, $ne: null }"
          },
          {
            "linea": 141,
            "contenido": "totalProspectos,"
          },
          {
            "linea": 143,
            "contenido": "proyectosConProspecto"
          },
          {
            "linea": 213,
            "contenido": "prospecto_original: { $exists: true, $ne: null }"
          },
          {
            "linea": 218,
            "contenido": "_id: '$prospecto_original',"
          },
          {
            "linea": 228,
            "contenido": "logger.info('Proyectos duplicados detectados por prospecto', {"
          },
          {
            "linea": 231,
            "contenido": "prospectosDuplicados: duplicados.length"
          },
          {
            "linea": 247,
            "contenido": "prospectoId: grupo._id,"
          },
          {
            "linea": 279,
            "contenido": "await Proyecto.collection.createIndex({ prospecto_original: 1 });"
          },
          {
            "linea": 289,
            "contenido": "'prospecto_original',"
          },
          {
            "linea": 318,
            "contenido": "total_prospectos: await Prospecto.countDocuments({}),"
          },
          {
            "linea": 321,
            "contenido": "prospecto_original: { $exists: true, $ne: null }"
          },
          {
            "linea": 380,
            "contenido": "await migrarProspectosAProyectos();"
          },
          {
            "linea": 416,
            "contenido": "migrarProspectosAProyectos,"
          }
        ]
      },
      {
        "archivo": "\\server\\scripts\\migrarProyectoPedidoAProyecto.js",
        "referencias": 2,
        "detalles": [
          {
            "linea": 341,
            "contenido": "prospecto_original: proyectoExistente.prospecto_original || proyectoPedido.prospecto,"
          },
          {
            "linea": 383,
            "contenido": "prospecto_original: proyectoPedido.prospecto || undefined,"
          }
        ]
      },
      {
        "archivo": "\\server\\scripts\\plantillasIniciales.js",
        "referencias": 2,
        "detalles": [
          {
            "linea": 239,
            "contenido": "nombre: \"Recontacto Prospecto Frío - Formal\","
          },
          {
            "linea": 260,
            "contenido": "nombre: \"Recontacto Prospecto Frío - Breve\","
          }
        ]
      },
      {
        "archivo": "\\server\\scripts\\pruebasFinales.js",
        "referencias": 1,
        "detalles": [
          {
            "linea": 77,
            "contenido": "const camposRequeridos = ['numero', 'cotizacion', 'prospecto', 'montoTotal', 'anticipo', 'saldo', 'productos', 'estado'];"
          }
        ]
      },
      {
        "archivo": "\\server\\scripts\\seedData.js",
        "referencias": 15,
        "detalles": [
          {
            "linea": 8,
            "contenido": "const Prospecto = require('../models/Prospecto');"
          },
          {
            "linea": 25,
            "contenido": "await Prospecto.deleteMany({});"
          },
          {
            "linea": 29,
            "contenido": "colecciones: ['Usuario', 'Producto', 'Prospecto', 'Plantilla']"
          },
          {
            "linea": 42,
            "contenido": "modulo: 'prospectos',"
          },
          {
            "linea": 87,
            "contenido": "modulo: 'prospectos',"
          },
          {
            "linea": 107,
            "contenido": "modulo: 'prospectos',"
          },
          {
            "linea": 270,
            "contenido": "const prospectos = ["
          },
          {
            "linea": 402,
            "contenido": "await Prospecto.insertMany(prospectos);"
          },
          {
            "linea": 403,
            "contenido": "logger.info('Prospectos de ejemplo creados', {"
          },
          {
            "linea": 405,
            "contenido": "prospectosCreados: prospectos.length"
          },
          {
            "linea": 412,
            "contenido": "descripcion: 'Mensaje de primer contacto con nuevos prospectos',"
          },
          {
            "linea": 417,
            "contenido": "{ nombre: 'nombre', descripcion: 'Nombre del prospecto' },"
          },
          {
            "linea": 428,
            "contenido": "{ nombre: 'nombre', descripcion: 'Nombre del prospecto' },"
          },
          {
            "linea": 450,
            "contenido": "{ nombre: 'nombre', descripcion: 'Nombre del prospecto' },"
          },
          {
            "linea": 463,
            "contenido": "{ nombre: 'nombre', descripcion: 'Nombre del prospecto' },"
          }
        ]
      },
      {
        "archivo": "\\server\\scripts\\validarFlujoTecnicoUnificado.js",
        "referencias": 3,
        "detalles": [
          {
            "linea": 14,
            "contenido": "const Prospecto = require('../models/Prospecto');"
          },
          {
            "linea": 230,
            "contenido": ".populate('prospecto', 'nombre')"
          },
          {
            "linea": 240,
            "contenido": "log(`   Cliente: ${pedido.prospecto?.nombre || 'N/A'}`, 'reset');"
          }
        ]
      },
      {
        "archivo": "\\server\\services\\cotizacionMappingService.js",
        "referencias": 1,
        "detalles": [
          {
            "linea": 252,
            "contenido": "prospecto: datos.prospectoId,"
          }
        ]
      },
      {
        "archivo": "\\server\\services\\excelService.js",
        "referencias": 4,
        "detalles": [
          {
            "linea": 61,
            "contenido": "async generarLevantamientoExcel(prospecto, piezas, precioGeneral, totalM2, unidadMedida = 'm', tipoVisita = 'levantamiento') {"
          },
          {
            "linea": 146,
            "contenido": "infoCell.value = `Cliente: ${prospecto.nombre || 'N/A'} | Teléfono: ${prospecto.telefono || 'N/A'} | Fecha: ${this.formatDate(new Date())}`;"
          },
          {
            "linea": 464,
            "contenido": "prospectoId: prospecto?._id?.toString(),"
          },
          {
            "linea": 500,
            "contenido": "worksheet.addRow(['Cliente', cotizacion.prospecto?.nombre || '']);"
          }
        ]
      },
      {
        "archivo": "\\server\\services\\metricasComerciales.js",
        "referencias": 2,
        "detalles": [
          {
            "linea": 299,
            "contenido": ".populate('prospecto', 'nombre telefono')"
          },
          {
            "linea": 303,
            "contenido": ".select('numero montoTotal estado fechaPedido prospecto vendedor');"
          }
        ]
      },
      {
        "archivo": "\\server\\services\\notificacionesComerciales.js",
        "referencias": 11,
        "detalles": [
          {
            "linea": 122,
            "contenido": "}).populate('prospecto', 'nombre telefono')"
          },
          {
            "linea": 140,
            "contenido": "cliente: pedido.prospecto?.nombre || 'Cliente',"
          },
          {
            "linea": 166,
            "contenido": "}).populate('prospecto', 'nombre telefono')"
          },
          {
            "linea": 176,
            "contenido": "cliente: pedido.prospecto?.nombre || 'Cliente'"
          },
          {
            "linea": 180,
            "contenido": "cliente: pedido.prospecto?.nombre || 'Cliente',"
          },
          {
            "linea": 202,
            "contenido": "}).populate('prospecto', 'nombre telefono')"
          },
          {
            "linea": 219,
            "contenido": "cliente: pedido.prospecto?.nombre || 'Cliente',"
          },
          {
            "linea": 240,
            "contenido": "}).populate('prospecto', 'nombre telefono')"
          },
          {
            "linea": 253,
            "contenido": "cliente: pedido.prospecto?.nombre || 'Cliente',"
          },
          {
            "linea": 284,
            "contenido": "}).populate('prospecto', 'nombre telefono')"
          },
          {
            "linea": 299,
            "contenido": "cliente: pedido.prospecto?.nombre || 'Cliente',"
          }
        ]
      },
      {
        "archivo": "\\server\\services\\pdfService.js",
        "referencias": 20,
        "detalles": [
          {
            "linea": 792,
            "contenido": "prospecto: {"
          },
          {
            "linea": 793,
            "contenido": "id: getDocumentId(cotizacion?.prospecto),"
          },
          {
            "linea": 794,
            "contenido": "nombre: cotizacion?.prospecto?.nombre"
          },
          {
            "linea": 1592,
            "contenido": "<span class=\"info-label\">Nombre:</span> {{prospecto.nombre}}"
          },
          {
            "linea": 1595,
            "contenido": "<span class=\"info-label\">Teléfono:</span> {{prospecto.telefono}}"
          },
          {
            "linea": 1600,
            "contenido": "<span class=\"info-label\">Email:</span> {{prospecto.email}}"
          },
          {
            "linea": 1602,
            "contenido": "{{#if prospecto.direccion}}"
          },
          {
            "linea": 1604,
            "contenido": "<span class=\"info-label\">Dirección:</span> {{prospecto.direccion}}"
          },
          {
            "linea": 2081,
            "contenido": "prospectoNombre: etapa?.prospecto?.nombre"
          },
          {
            "linea": 2478,
            "contenido": "<td>{{prospecto.nombre}}</td>"
          },
          {
            "linea": 2484,
            "contenido": "<td>{{prospecto.telefono}}</td>"
          },
          {
            "linea": 2490,
            "contenido": "<td colspan=\"3\">{{#if prospecto.email}}{{prospecto.email}}{{else}}-{{/if}}</td>"
          },
          {
            "linea": 2492,
            "contenido": "{{#if prospecto.direccion}}"
          },
          {
            "linea": 2496,
            "contenido": "{{#if prospecto.direccion.calle}}"
          },
          {
            "linea": 2497,
            "contenido": "{{prospecto.direccion.calle}}, {{prospecto.direccion.colonia}}, {{prospecto.direccion.ciudad}}, CP {{prospecto.direccion.codigoPostal}}"
          },
          {
            "linea": 2498,
            "contenido": "{{#if prospecto.direccion.referencias}}<br><em>Ref: {{prospecto.direccion.referencias}}</em>{{/if}}"
          },
          {
            "linea": 2499,
            "contenido": "{{#if prospecto.direccion.linkMapa}}<br><a href=\"{{prospecto.direccion.linkMapa}}\" target=\"_blank\" style=\"color: #1E40AF; text-decoration: none;\">📍 Ver en Google Maps</a>{{/if}}"
          },
          {
            "linea": 2501,
            "contenido": "{{formatDireccion prospecto.direccion}}"
          },
          {
            "linea": 2876,
            "contenido": "prospecto: etapa.prospecto || { nombre: 'Cliente', telefono: '' },"
          },
          {
            "linea": 3181,
            "contenido": "prospecto: etapa.prospecto || { nombre: 'Cliente', telefono: '' },"
          }
        ]
      },
      {
        "archivo": "\\server\\services\\syncLegacyService.js",
        "referencias": 1,
        "detalles": [
          {
            "linea": 53,
            "contenido": "prospecto: legacy.prospecto,"
          }
        ]
      },
      {
        "archivo": "\\server\\tests\\listeners\\pedidoListener.test.js",
        "referencias": 8,
        "detalles": [
          {
            "linea": 10,
            "contenido": "jest.mock('../../models/Prospecto', () => ({"
          },
          {
            "linea": 27,
            "contenido": "const Prospecto = require('../../models/Prospecto');"
          },
          {
            "linea": 41,
            "contenido": "prospectoId: 'pros1',"
          },
          {
            "linea": 53,
            "contenido": "const mockProspecto = {"
          },
          {
            "linea": 63,
            "contenido": "prospecto: mockProspecto,"
          },
          {
            "linea": 90,
            "contenido": "Prospecto.findById.mockResolvedValue(mockProspecto);"
          },
          {
            "linea": 107,
            "contenido": "prospectoId: 'pros1',"
          },
          {
            "linea": 119,
            "contenido": "prospecto: 'pros1',"
          }
        ]
      },
      {
        "archivo": "\\server\\tests\\metric.test.js",
        "referencias": 3,
        "detalles": [
          {
            "linea": 28,
            "contenido": "endpoint: '/api/prospectos',"
          },
          {
            "linea": 35,
            "contenido": "expect(metric.metadata.endpoint).toBe('/api/prospectos');"
          },
          {
            "linea": 36,
            "contenido": "expect(metric.endpoint).toBe('/api/prospectos');"
          }
        ]
      },
      {
        "archivo": "\\server\\utils\\exportNormalizer.js",
        "referencias": 2,
        "detalles": [
          {
            "linea": 19,
            "contenido": "{ path: 'prospecto_original', select: 'nombre telefono email' },"
          },
          {
            "linea": 202,
            "contenido": "prospecto_original: proyecto.prospecto_original,"
          }
        ]
      }
    ]
  }
}